<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOIA Agent Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1a202c;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 16px;
        }

        .status-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border-radius: 8px;
            background: #f7fafc;
        }

        .status-item.active {
            background: #c6f6d5;
        }

        .status-item.inactive {
            background: #fed7d7;
        }

        .status-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a202c;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #1a202c;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .output-box {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
        }

        .output-box:empty::before {
            content: 'No output yet...';
            color: #718096;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #667eea;
            background: #2d3748;
            border-radius: 4px;
        }

        .log-entry.success {
            border-left-color: #48bb78;
        }

        .log-entry.error {
            border-left-color: #f56565;
        }

        .log-entry.warning {
            border-left-color: #ed8936;
        }

        .timestamp {
            color: #a0aec0;
            font-size: 10px;
            margin-right: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge.danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .test-case-selector {
            margin-bottom: 15px;
        }

        .test-case-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .test-case-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #2d3748;
        }

        .table tr:hover {
            background: #f7fafc;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .emoji {
            font-size: 16px;
        }

        .case-monitor-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .case-search-input {
            flex: 1;
            min-width: 220px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .case-search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .case-monitor-meta {
            font-size: 12px;
            color: #718096;
            margin-left: auto;
        }

        .case-title {
            font-weight: 600;
            color: #1a202c;
        }

        .case-meta {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .case-preview {
            margin-top: 6px;
            color: #2d3748;
            font-size: 13px;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            background: #edf2f7;
            color: #2d3748;
        }

        .status-pill.ready_to_send { background: #bee3f8; color: #2b6cb0; }
        .status-pill.awaiting_response { background: #faf089; color: #b7791f; }
        .status-pill.closed { background: #c6f6d5; color: #276749; }
        .status-pill.follow_up_scheduled { background: #e9d8fd; color: #553c9a; }

        .message-direction {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-direction.inbound {
            background: #c6f6d5;
            color: #22543d;
        }

        .message-direction.outbound {
            background: #bee3f8;
            color: #2c5282;
        }

        .message-direction.neutral {
            background: #edf2f7;
            color: #4a5568;
        }

        .table-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #667eea;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }

        .table-btn:hover {
            opacity: 0.9;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: min(900px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #4a5568;
        }

        .thread-message {
            border-left: 4px solid #667eea;
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .thread-message.inbound {
            border-left-color: #48bb78;
        }

        .thread-message.outbound {
            border-left-color: #4299e1;
        }

        .thread-message-meta {
            font-size: 12px;
            color: #4a5568;
            margin-bottom: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .thread-message-body {
            font-size: 14px;
            color: #1a202c;
            white-space: pre-wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-field label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #4a5568;
        }

        .form-field input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .inline-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #4a5568;
        }

        .inline-checkbox input {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ FOIA Agent Test Dashboard</h1>
            <p class="subtitle">Test the autonomous agent with real scenarios - no commands needed!</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item" id="agent-status">
                <div class="status-label">Agent Status</div>
                <div class="status-value">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Cases Created</div>
                <div class="status-value" id="cases-count">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Agent Decisions</div>
                <div class="status-value" id="decisions-count">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Escalations</div>
                <div class="status-value" id="escalations-count">0</div>
            </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid">
            <!-- Test Scenarios -->
            <div class="card">
                <h2>üìß Send Test Emails</h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="sendTestEmail()">
                        <span class="emoji">üì§</span> Send Test Email
                    </button>
                    <p style="color: #718096; font-size: 12px; margin-top: 10px;">
                        Creates a new test case and sends email to overlord1pvp@gmail.com
                    </p>
                </div>
            </div>

            <!-- Simulate Replies -->
            <div class="card">
                <h2>üí¨ Simulate Agency Replies</h2>
                <div class="test-case-selector">
                    <select id="case-selector">
                        <option value="">Select a case first...</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn-danger" onclick="simulateReply('denial')">
                        <span class="emoji">‚ùå</span> Send Denial
                    </button>
                    <button class="btn-warning" onclick="simulateReply('fee')">
                        <span class="emoji">üí∞</span> Send High Fee ($500)
                    </button>
                    <button class="btn-info" onclick="simulateReply('clarification')">
                        <span class="emoji">‚ùì</span> Request Clarification
                    </button>
                    <button class="btn-success" onclick="simulateReply('approval')">
                        <span class="emoji">‚úÖ</span> Send Approval
                    </button>
                </div>
            </div>

            <!-- Monitor Agent -->
            <div class="card">
                <h2>üîç Monitor & Control</h2>
                <div class="button-group">
                    <button class="btn-info" onclick="refreshStats()">
                        <span class="emoji">üîÑ</span> Refresh Stats
                    </button>
                    <button class="btn-info" onclick="viewAgentDecisions()">
                        <span class="emoji">üìä</span> View Agent Decisions
                    </button>
                    <button class="btn-info" onclick="viewEscalations()">
                        <span class="emoji">üö®</span> View Escalations
                    </button>
                    <button class="btn-secondary" onclick="viewAllCases()">
                        <span class="emoji">üìÅ</span> View All Cases
                    </button>
                    <button class="btn-secondary" onclick="viewPortalRuns()">
                        <span class="emoji">üåê</span> Portal Runs
                    </button>
                </div>
            </div>

            <!-- Database Controls -->
            <div class="card">
                <h2>üóÑÔ∏è Database Controls</h2>
                <div class="button-group">
                    <button class="btn-warning" onclick="runMigration()">
                        <span class="emoji">‚öôÔ∏è</span> Run Migration
                    </button>
                    <button class="btn-danger" onclick="clearDatabase()">
                        <span class="emoji">üóëÔ∏è</span> Clear All Cases
                    </button>
                    <p style="color: #718096; font-size: 12px; margin-top: 10px;">
                        ‚ö†Ô∏è Clear database will delete ALL cases and data!
                    </p>
                </div>
            </div>

            <!-- Notion Launch -->
            <div class="card full-width">
                <h2>üóÇÔ∏è Launch Outreach From Notion</h2>
                <div class="form-grid">
                    <div class="form-field" style="grid-column: span 2;">
                        <label for="notion-link-input">Notion Page Link or ID</label>
                        <input id="notion-link-input" type="text" placeholder="https://www.notion.so/... or 6f5c2d90c0b24b3e9f6a..." />
                    </div>
                    <div class="form-field">
                        <label for="notion-email-input">Override Agency Email (optional)</label>
                        <input id="notion-email-input" type="email" placeholder="agency@example.gov" />
                    </div>
                    <div class="form-field">
                        <label>Send Mode</label>
                        <div class="inline-checkbox">
                            <input id="notion-instant-checkbox" type="checkbox" checked />
                            <span>Instant mode (no delay)</span>
                        </div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="processNotionCase(event)">
                        <span class="emoji">üöÄ</span> Launch Outreach
                    </button>
                    <p style="color: #718096; font-size: 12px;">
                        Paste any Notion request card link/ID to queue drafting + sending automatically. Finished case will appear in the Live Case Monitor below.
                    </p>
                </div>
            </div>

            <!-- Live Case Monitor -->
            <div class="card full-width">
                <h2>üì° Live Case Monitor</h2>
                <div class="case-monitor-controls">
                    <input id="case-search" type="text" class="case-search-input" placeholder="Search by case name, agency, or email..." />
                    <select id="status-filter" class="case-search-input" style="max-width: 220px;">
                        <option value="all">All statuses</option>
                        <option value="ready_to_send">Ready to Send</option>
                        <option value="awaiting_response">Awaiting Response</option>
                        <option value="follow_up_scheduled">Follow-up Scheduled</option>
                        <option value="closed">Closed</option>
                    </select>
                    <button class="btn-info" onclick="loadCaseMonitor({ manual: true, announce: true })">
                        <span class="emoji">üîç</span> Search
                    </button>
                    <div class="case-monitor-meta" id="case-monitor-meta">Live view auto-refreshes every 30s</div>
                </div>
                <div id="case-monitor-table" class="table-scroll">
                    <p style="color: #718096;">Loading case overview...</p>
                </div>
            </div>

            <!-- Output Log -->
            <div class="card full-width">
                <h2>üìù Activity Log</h2>
                <div id="output" class="output-box"></div>
            </div>

            <!-- Agent Decisions Table -->
            <div class="card full-width">
                <h2>ü§ñ Recent Agent Decisions</h2>
                <div id="decisions-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "View Agent Decisions" to load...</p>
                </div>
            </div>

            <!-- Escalations Table -->
            <div class="card full-width">
                <h2>üö® Pending Escalations</h2>
                <div id="escalations-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "View Escalations" to load...</p>
                </div>
            </div>

            <!-- Portal Runs Table -->
            <div class="card full-width">
                <h2>üåê Portal Automation Runs</h2>
                <div id="portal-runs-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "Portal Runs" to load...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Thread Modal -->
    <div id="thread-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close" onclick="closeThreadModal()" aria-label="Close">&times;</button>
            <h3 id="thread-modal-title" style="margin-bottom: 6px;">Case Thread</h3>
            <p id="thread-modal-summary" class="case-meta" style="margin-bottom: 20px;"></p>
            <div id="thread-modal-body"></div>
        </div>
    </div>

    <script>
        let currentCaseId = null;
        let caseMonitorTimer = null;
        let latestCaseMonitorCount = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Dashboard loaded', 'success');
            refreshStats();
            loadCaseSelector();
            setupCaseMonitorControls();
            setupNotionFormControls();
            loadCaseMonitor();
            scheduleCaseMonitorRefresh();

            const modal = document.getElementById('thread-modal');
            if (modal) {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeThreadModal();
                    }
                });
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeThreadModal();
            }
        });

        // Logging
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        function setupCaseMonitorControls() {
            const searchInput = document.getElementById('case-search');
            const statusFilter = document.getElementById('status-filter');

            if (searchInput) {
                searchInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        loadCaseMonitor({ manual: true, announce: true });
                    }
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', () => loadCaseMonitor({ manual: true }));
            }
        }

        function setupNotionFormControls() {
            const notionInput = document.getElementById('notion-link-input');
            const emailInput = document.getElementById('notion-email-input');

            [notionInput, emailInput].forEach((input) => {
                if (!input) return;
                input.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        processNotionCase(event);
                    }
                });
            });
        }

        function scheduleCaseMonitorRefresh() {
            if (caseMonitorTimer) {
                clearInterval(caseMonitorTimer);
            }
            caseMonitorTimer = setInterval(() => loadCaseMonitor(), 30000);
        }

        function formatRelativeTime(value) {
            if (!value) return '‚Äî';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '‚Äî';

            const diffMs = Date.now() - date.getTime();
            const minutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMs / 3600000);
            const days = Math.floor(diffMs / 86400000);

            if (diffMs < 45000) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function formatDateTime(value) {
            if (!value) return '‚Äî';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '‚Äî';
            return date.toLocaleString();
        }

        function extractNotionPageId(input) {
            if (!input) return null;
            const trimmed = input.trim();
            if (!trimmed) return null;

            const hyphenated = trimmed.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i);
            if (hyphenated) {
                return hyphenated[0].replace(/-/g, '').toLowerCase();
            }

            const plain = trimmed.match(/[0-9a-f]{32}/i);
            if (plain) {
                return plain[0].toLowerCase();
            }

            const queryIndex = trimmed.indexOf('?');
            if (queryIndex !== -1) {
                try {
                    const search = new URLSearchParams(trimmed.substring(queryIndex + 1));
                    const paramId = search.get('p') || search.get('pageId');
                    if (paramId) {
                        const cleaned = paramId.replace(/-/g, '');
                        if (/^[0-9a-f]{32}$/i.test(cleaned)) {
                            return cleaned.toLowerCase();
                        }
                    }
                } catch {
                    // ignore malformed query params
                }
            }

            return null;
        }

        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function stripHtml(html = '') {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function normalizePortalUrl(url) {
            if (!url) return null;
            if (/^https?:\/\//i.test(url)) {
                return url;
            }
            return `https://${url}`;
        }

        function renderPortalStatusCell(c) {
            const status = c.last_portal_status ? escapeHtml(c.last_portal_status) : '‚Äî';
            const metaParts = [];
            if (c.last_portal_status_at) {
                metaParts.push(formatRelativeTime(c.last_portal_status_at));
            }
            if (c.last_portal_engine) {
                metaParts.push(`via ${escapeHtml(c.last_portal_engine)}`);
            }
            const metaHtml = metaParts.length ? `<div class="case-meta">${metaParts.join(' ‚Ä¢ ')}</div>` : '';
            const portalUrl = normalizePortalUrl(c.portal_url);
            const provider = c.portal_provider ? `<div class="case-meta">Provider: ${escapeHtml(c.portal_provider)}</div>` : '';
            const linkHtml = portalUrl ? `<div class="case-meta"><a href="${portalUrl}" target="_blank" rel="noopener">Open Portal</a></div>` : '';
            return `<div class="case-title">${status}</div>${metaHtml}${provider}${linkHtml}`;
        }

        function renderStatusPill(status, substatus) {
            if (!status) return '<span class="status-pill">Unknown</span>';
            const className = `status-pill ${status}`;
            const label = escapeHtml(status.replace(/_/g, ' '));
            const sub = substatus ? `<div class="case-meta">${escapeHtml(substatus)}</div>` : '';
            return `<div><span class="${className}">${label}</span>${sub}</div>`;
        }

        function renderDirectionBadge(direction) {
            if (!direction) {
                return '<span class="message-direction neutral">No messages</span>';
            }
            const dir = direction === 'inbound' ? 'inbound' : direction === 'outbound' ? 'outbound' : 'neutral';
            const label = direction.charAt(0).toUpperCase() + direction.slice(1);
            return `<span class="message-direction ${dir}">${label}</span>`;
        }

        async function processNotionCase(clickEvent) {
            const notionInput = document.getElementById('notion-link-input');
            const emailInput = document.getElementById('notion-email-input');
            const instantCheckbox = document.getElementById('notion-instant-checkbox');

            if (!notionInput || !notionInput.value.trim()) {
                log('‚ùå Please paste a Notion link or ID first.', 'error');
                return;
            }

            const pageId = extractNotionPageId(notionInput.value);
            if (!pageId) {
                log('‚ùå Could not parse a Notion page ID from that input.', 'error');
                return;
            }

            const payload = {
                notion_page_id: pageId,
                instant_mode: instantCheckbox ? instantCheckbox.checked : true
            };

            if (emailInput && emailInput.value.trim()) {
                payload.test_email = emailInput.value.trim();
            }

            const btn = clickEvent?.target?.closest('button');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Launching...';
            }

            log(`üöÄ Launching outreach for Notion page ${pageId}...`);

            try {
                const result = await apiCall('/test/process-notion', 'POST', payload);
                if (result.success) {
                    log(`‚úÖ Case ${result.case_id} queued (instant mode: ${result.instant_mode})`, 'success');
                    await refreshStats();
                    await loadCaseSelector();
                    await loadCaseMonitor({ manual: true });
                } else {
                    log(`‚ùå Failed to queue case: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error launching outreach: ${error.message}`, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="emoji">üöÄ</span> Launch Outreach';
                }
            }
        }

        async function loadCaseMonitor(options = {}) {
            const container = document.getElementById('case-monitor-table');
            const meta = document.getElementById('case-monitor-meta');
            if (!container) return;

            const searchInput = document.getElementById('case-search');
            const statusFilter = document.getElementById('status-filter');
            const params = new URLSearchParams();

            if (searchInput && searchInput.value.trim().length > 0) {
                params.set('search', searchInput.value.trim());
            }
            if (statusFilter && statusFilter.value !== 'all') {
                params.set('status', statusFilter.value);
            }
            params.set('limit', '100');

            const queryString = params.toString();
            const endpoint = `/test/cases${queryString ? `?${queryString}` : ''}`;

            if (options.manual || options.announce) {
                log('üì° Refreshing live case monitor...');
            }

            try {
                const result = await apiCall(endpoint);
                const cases = result.cases || [];
                latestCaseMonitorCount = cases.length;
                renderCaseMonitor(cases);

                if (meta) {
                    meta.textContent = `Updated ${new Date().toLocaleTimeString()} ‚Ä¢ Showing ${cases.length} case${cases.length === 1 ? '' : 's'}`;
                }

                if (options.manual || options.announce) {
                    log(`‚úÖ Loaded ${cases.length} cases`, 'success');
                }
            } catch (error) {
                container.innerHTML = `<p style="color: #e53e3e;">Failed to load cases: ${escapeHtml(error.message)}</p>`;
                if (options.manual || options.announce) {
                    log(`‚ùå Failed to load case monitor: ${error.message}`, 'error');
                }
            }
        }

        function renderCaseMonitor(cases = []) {
            const container = document.getElementById('case-monitor-table');
            if (!container) return;

            if (!cases.length) {
                container.innerHTML = '<p style="color: #718096;">No cases match the current filters.</p>';
                return;
            }

            let html = '<table class="table"><thead><tr>';
            html += '<th>Case</th><th>Agency</th><th>Status</th><th>Portal</th><th>Last Response</th><th>Messages</th><th>Next Step</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            cases.forEach((c) => {
                const name = escapeHtml(c.case_name || 'Untitled case');
                const agency = escapeHtml(c.agency_name || 'Unknown agency');
                const statusHtml = renderStatusPill(c.status, c.substatus);
                const directionBadge = renderDirectionBadge(c.last_message_direction);
                const preview = escapeHtml(c.last_message_preview || 'No correspondence yet.');
                const lastActivity = c.last_message_at
                    ? formatRelativeTime(c.last_message_at)
                    : formatRelativeTime(c.updated_at);
                const totalMessages = c.total_messages || 0;
                const inboundMeta = c.last_inbound_at ? formatRelativeTime(c.last_inbound_at) : '‚Äî';
                const outboundMeta = c.last_outbound_at ? formatRelativeTime(c.last_outbound_at) : '‚Äî';
                const followupText = c.next_followup_date
                    ? `${formatDateTime(c.next_followup_date)} (${formatRelativeTime(c.next_followup_date)})`
                    : '‚Äî';
                const followupStatus = c.followup_status ? `<div class="case-meta">Status: ${escapeHtml(c.followup_status)}</div>` : '';

                html += '<tr>';
                html += `<td><div class="case-title">${name}</div><div class="case-meta">#${c.id} ‚Ä¢ Created ${formatRelativeTime(c.created_at)}</div></td>`;
                html += `<td><div class="case-title">${agency}</div><div class="case-meta">${escapeHtml(c.agency_email || '‚Äî')}</div></td>`;
                const portalCell = renderPortalStatusCell(c);

                html += `<td>${statusHtml}</td>`;
                html += `<td>${portalCell}</td>`;
                html += `<td>${directionBadge}<div class="case-meta">${lastActivity}</div><div class="case-preview">${preview}</div></td>`;
                html += `<td><div class="case-title">${totalMessages} message${totalMessages === 1 ? '' : 's'}</div><div class="case-meta">Inbound: ${inboundMeta} ‚Ä¢ Outbound: ${outboundMeta}</div></td>`;
                html += `<td><div class="case-title">${followupText}</div>${followupStatus}</td>`;
                html += `<td>
                    <button class="table-btn" onclick="openThreadModal(${c.id})">View Thread</button>
                    <button class="table-btn" onclick="retriggerAnalysis(${c.id})" style="background: #ed8936; margin-top: 5px;">Retrigger</button>
                </td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function openThreadModal(caseId) {
            const modal = document.getElementById('thread-modal');
            const title = document.getElementById('thread-modal-title');
            const summary = document.getElementById('thread-modal-summary');
            const body = document.getElementById('thread-modal-body');

            if (!modal || !body) return;

            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            body.innerHTML = '<p style="color: #718096;">Loading correspondence...</p>';

            try {
                const result = await apiCall(`/test/cases/${caseId}/messages`);
                const caseData = result.case || {};
                title.textContent = `${caseData.case_name || 'Case'} (#${caseData.id || caseId})`;
                summary.textContent = [
                    caseData.agency_name || 'Unknown agency',
                    caseData.agency_email || 'No email',
                    caseData.status ? `Status: ${caseData.status.replace(/_/g, ' ')}` : ''
                ].filter(Boolean).join(' ‚Ä¢ ');

                renderThreadMessages(result.messages || []);
            } catch (error) {
                body.innerHTML = `<p style="color: #e53e3e;">${escapeHtml(error.message)}</p>`;
            }
        }

        function closeThreadModal() {
            const modal = document.getElementById('thread-modal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function renderThreadMessages(messages = []) {
            const body = document.getElementById('thread-modal-body');
            if (!body) return;

            if (!messages.length) {
                body.innerHTML = '<p style="color: #718096;">No correspondence yet for this case.</p>';
                return;
            }

            const html = messages.map((msg) => {
                const direction = msg.direction || 'neutral';
                const subject = escapeHtml(msg.subject || '(No subject)');
                const timestamp = formatDateTime(msg.message_timestamp);
                const fallbackText = msg.body_text && msg.body_text.trim().length > 0
                    ? msg.body_text
                    : stripHtml(msg.body_html || '');
                const content = escapeHtml(fallbackText || '').replace(/\n/g, '<br>');

                return `
                    <div class="thread-message ${direction}">
                        <div class="thread-message-meta">
                            <span class="message-direction ${direction}">${direction.toUpperCase()}</span>
                            <span>${timestamp}</span>
                            <span>${subject}</span>
                        </div>
                        <div class="thread-message-body">${content || '<em>No content</em>'}</div>
                    </div>
                `;
            }).join('');

            body.innerHTML = html;
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(`/api${endpoint}`, options);
                const data = await response.json();
                return data;
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Refresh Stats
        async function refreshStats() {
            log('üîÑ Refreshing statistics...');

            try {
                // Agent is always enabled (hardcoded)
                const statusDiv = document.getElementById('agent-status');
                statusDiv.className = 'status-item active';
                statusDiv.querySelector('.status-value').textContent = 'ENABLED ‚úÖ';

                // Get stats
                const stats = await apiCall('/test/stats');
                document.getElementById('cases-count').textContent = stats.total_cases || 0;
                document.getElementById('decisions-count').textContent = stats.agent_decisions || 0;
                document.getElementById('escalations-count').textContent = stats.escalations || 0;

                log('‚úÖ Stats refreshed', 'success');
            } catch (error) {
                log(`‚ùå Failed to refresh stats: ${error.message}`, 'error');
            }
        }

        // Load Case Selector
        async function loadCaseSelector() {
            try {
                const cases = await apiCall('/test/cases');
                const selector = document.getElementById('case-selector');

                selector.innerHTML = '<option value="">Select a case...</option>';

                if (cases.cases && cases.cases.length > 0) {
                    cases.cases.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = `Case ${c.id}: ${c.case_name} (${c.status})`;
                        selector.appendChild(option);
                    });

                    // Auto-select most recent
                    selector.value = cases.cases[0].id;
                    currentCaseId = cases.cases[0].id;
                }
            } catch (error) {
                log(`Failed to load cases: ${error.message}`, 'error');
            }
        }

        // Update current case when selector changes
        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('case-selector');
            if (selector) {
                selector.addEventListener('change', (e) => {
                    currentCaseId = e.target.value;
                    log(`üìå Selected case ${currentCaseId}`);
                });
            }
        });

        // Send Test Email
        async function sendTestEmail() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Sending...';

            log('üì§ Sending test email...');

            try {
                const result = await apiCall('/test/send-and-reply', 'POST');

                if (result.success) {
                    currentCaseId = result.case_id;
                    log(`‚úÖ Test email sent! Case ID: ${result.case_id}`, 'success');
                    log(`üìß Email sent to: ${result.sent_to}`, 'info');
                    log(`üìã Message ID: ${result.message_id}`, 'info');

                    await loadCaseSelector();
                    await refreshStats();
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üì§</span> Send Test Email';
            }
        }

        // Simulate Reply
        async function simulateReply(type) {
            const caseId = document.getElementById('case-selector').value;

            if (!caseId) {
                log('‚ö†Ô∏è Please select a case first!', 'warning');
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Processing...';

            const replyTexts = {
                denial: "Your request is denied. The records you requested are exempt from disclosure under 5 U.S.C. ¬ß 552(b)(7)(A) as they are part of an ongoing law enforcement investigation.",
                fee: "Your request has been received. The estimated cost for processing and copying the requested records is $500. Please confirm if you wish to proceed with payment.",
                clarification: "We need more specific information to process your request. Please clarify: 1) What is the exact date range? 2) What specific incident are you referring to? 3) Are you requesting body camera footage or just reports?",
                approval: "Your request has been approved. The requested records will be provided to you within 10 business days. Thank you for your patience."
            };

            log(`üí¨ Simulating ${type} reply for case ${caseId}...`);

            try {
                const result = await apiCall('/test/simulate-reply', 'POST', {
                    case_id: parseInt(caseId),
                    reply_text: replyTexts[type],
                    reply_type: type
                });

                if (result.success) {
                    log(`‚úÖ ${type} reply sent!`, 'success');
                    log(`üìä Analysis: ${result.analysis?.intent || 'pending'}`, 'info');

                    if (result.agent_handled) {
                        log(`ü§ñ Agent is handling this case...`, 'info');
                        log(`üîÑ Agent took ${result.agent_iterations || 0} iterations`, 'info');
                    } else {
                        log(`üìã Using deterministic flow (agent disabled or simple case)`, 'info');
                    }

                    await refreshStats();

                    // Auto-refresh decisions after 2 seconds
                    setTimeout(viewAgentDecisions, 2000);
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // View Agent Decisions
        async function viewAgentDecisions() {
            log('üìä Loading agent decisions...');

            try {
                const result = await apiCall('/test/agent/decisions');
                const container = document.getElementById('decisions-table');

                if (!result.decisions || result.decisions.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No agent decisions yet. Send a test and simulate a reply!</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Case ID</th><th>Case Name</th><th>Action</th><th>Reasoning</th><th>Confidence</th><th>Time</th>';
                html += '</tr></thead><tbody>';

                result.decisions.forEach(d => {
                    const confidenceClass = d.confidence >= 0.8 ? 'success' : d.confidence >= 0.5 ? 'warning' : 'danger';
                    html += '<tr>';
                    html += `<td>${d.case_id}</td>`;
                    html += `<td>${d.case_name || 'Unknown'}</td>`;
                    html += `<td>${d.action_taken}</td>`;
                    html += `<td>${d.reasoning.substring(0, 100)}...</td>`;
                    html += `<td><span class="badge ${confidenceClass}">${(d.confidence * 100).toFixed(0)}%</span></td>`;
                    html += `<td>${new Date(d.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                log(`‚úÖ Loaded ${result.decisions.length} agent decisions`, 'success');
            } catch (error) {
                log(`‚ùå Failed to load decisions: ${error.message}`, 'error');
            }
        }

        // View Escalations
        async function viewEscalations() {
            log('üö® Loading escalations...');

            try {
                const result = await apiCall('/test/agent/escalations');
                const container = document.getElementById('escalations-table');

                if (!result.escalations || result.escalations.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No escalations yet. Try sending a high fee reply!</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Case ID</th><th>Case Name</th><th>Reason</th><th>Urgency</th><th>Suggested Action</th><th>Status</th><th>Created</th>';
                html += '</tr></thead><tbody>';

                result.escalations.forEach(e => {
                    const urgencyClass = e.urgency === 'high' ? 'danger' : e.urgency === 'medium' ? 'warning' : 'info';
                    html += '<tr>';
                    html += `<td>${e.case_id}</td>`;
                    html += `<td>${e.case_name || 'Unknown'}</td>`;
                    html += `<td>${e.reason}</td>`;
                    html += `<td><span class="badge ${urgencyClass}">${e.urgency.toUpperCase()}</span></td>`;
                    html += `<td>${e.suggested_action || 'None'}</td>`;
                    html += `<td>${e.status}</td>`;
                    html += `<td>${new Date(e.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                log(`‚úÖ Loaded ${result.escalations.length} escalations`, 'success');
            } catch (error) {
                log(`‚ùå Failed to load escalations: ${error.message}`, 'error');
            }
        }

        // View All Cases
        async function viewAllCases() {
            await loadCaseMonitor({ manual: true, announce: true });
            log('üìÅ Scroll to the Live Case Monitor table for full details.', 'info');
        }

        // View Portal Runs
        async function viewPortalRuns() {
            log('üåê Loading portal automation runs...');

            try {
                const result = await apiCall('/test/portal-runs');
                const container = document.getElementById('portal-runs-table');

                if (!result.runs || result.runs.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No portal runs yet. Trigger one from the CLI.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Time</th><th>Status</th><th>Engine</th><th>Case</th><th>Portal</th><th>Details</th>';
                html += '</tr></thead><tbody>';

                result.runs.forEach(run => {
                    const meta = run.metadata || {};
                    const status = run.event_type.replace('portal_run_', '');
                    const statusClass = status === 'completed' ? 'success' : status === 'failed' ? 'danger' : 'info';
                    const caseLabel = meta.case_id ? `Case ${meta.case_id}` : 'Test';
                    const portalLabel = meta.portal_url || 'Unknown';
                    const details = meta.error || meta.final_url || run.description || '';
                    const engineLabel = meta.engine || '‚Äî';

                    html += '<tr>';
                    html += `<td>${new Date(run.created_at).toLocaleString()}</td>`;
                    html += `<td><span class="badge ${statusClass}">${status.toUpperCase()}</span></td>`;
                    html += `<td>${engineLabel}</td>`;
                    html += `<td>${caseLabel}</td>`;
                    html += `<td style="word-break: break-all;">${portalLabel}</td>`;
                    html += `<td>${details}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                log(`‚úÖ Loaded ${result.runs.length} portal runs`, 'success');
            } catch (error) {
                log(`‚ùå Failed to load portal runs: ${error.message}`, 'error');
            }
        }

        // Run Migration
        async function runMigration() {
            if (!confirm('Run database migration? This will create agent_decisions and escalations tables.')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running...';

            log('‚öôÔ∏è Running database migration...');

            try {
                const result = await apiCall('/test/run-migration', 'POST');

                if (result.success) {
                    log('‚úÖ Migration completed successfully!', 'success');
                    result.tables?.forEach(t => log(`  ‚úì Created table: ${t}`, 'success'));
                    result.views?.forEach(v => log(`  ‚úì Created view: ${v}`, 'success'));
                } else {
                    log(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">‚öôÔ∏è</span> Run Migration';
            }
        }

        // Retrigger Analysis
        async function retriggerAnalysis(caseId) {
            if (!confirm(`Re-trigger analysis and auto-reply for case #${caseId}?`)) {
                return;
            }

            log(`üîÑ Re-triggering analysis for case #${caseId}...`);

            try {
                const result = await apiCall('/test/retrigger-analysis', 'POST', {
                    case_id: caseId
                });

                if (result.success) {
                    log(`‚úÖ Case #${caseId} re-queued for analysis!`, 'success');
                    log(`   From: ${result.from_email}`, 'info');
                    log(`   Subject: ${result.subject}`, 'info');
                    log(`   ${result.note}`, 'info');
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Clear Database
        async function clearDatabase() {
            if (!confirm('‚ö†Ô∏è This will DELETE ALL cases, messages, and agent data. Are you sure?')) {
                return;
            }

            if (!confirm('Really sure? This cannot be undone!')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Clearing...';

            log('üóëÔ∏è Clearing database...');

            try {
                const result = await apiCall('/test/clear-all-cases', 'POST', {
                    confirm: 'DELETE_ALL_CASES'
                });

                if (result.success) {
                    log('‚úÖ Database cleared!', 'success');
                    log(`üìä Deleted ${result.deleted.cases} cases, ${result.deleted.messages} messages`, 'info');

                    await refreshStats();
                    await loadCaseSelector();

                    document.getElementById('decisions-table').innerHTML = '<p style="color: #718096;">No decisions yet...</p>';
                    document.getElementById('escalations-table').innerHTML = '<p style="color: #718096;">No escalations yet...</p>';
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üóëÔ∏è</span> Clear All Cases';
            }
        }

        // Auto-refresh stats every 30 seconds
        setInterval(refreshStats, 30000);
    </script>
</body>
</html>
