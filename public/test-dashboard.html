<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOIA Agent Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: radial-gradient(circle at top, rgba(56,189,248,0.15) 0%, rgba(8,47,73,0.4) 35%, #020617 80%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 24px;
        }

        a {
            color: #38bdf8;
        }

        a:hover {
            color: #7dd3fc;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #0f172a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.6);
        }

        .header h1 {
            color: #f8fafc;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #94a3b8;
            font-size: 16px;
        }

        .status-bar {
            background: #0f172a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(15, 118, 110, 0.1);
            border: 1px solid rgba(15, 118, 110, 0.3);
        }

        .status-item.active {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .status-item.inactive {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.4);
        }

        .status-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #f8fafc;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #0b1220;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 20px 45px -20px rgba(15, 23, 42, 0.8);
        }

        .card h2 {
            color: #f1f5f9;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #38bdf8, #6366f1);
            border-radius: 2px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-info {
            background: #0ea5e9;
            color: white;
        }

        .btn-secondary {
            background: #475569;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            padding: 10px 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .output-box {
            background: #020617;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
        }

        .output-box:empty::before {
            content: 'No output yet...';
            color: #475569;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 10px 12px;
            border-left: 3px solid #38bdf8;
            background: #0b1220;
            border-radius: 6px;
        }

        .log-entry.success {
            border-left-color: #22c55e;
        }

        .log-entry.error {
            border-left-color: #f87171;
        }

        .log-entry.warning {
            border-left-color: #fbbf24;
        }

        .timestamp {
            color: #a0aec0;
            font-size: 10px;
            margin-right: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge.success {
            background: rgba(34, 197, 94, 0.15);
            color: #bbf7d0;
        }

        .badge.danger {
            background: rgba(248, 113, 113, 0.15);
            color: #fecdd3;
        }

        .badge.warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fde68a;
        }

        .badge.info {
            background: rgba(14, 165, 233, 0.15);
            color: #bae6fd;
        }

        .activity-log-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 360px;
            overflow-y: auto;
        }

        .activity-log-entry {
            padding: 12px 14px;
            border-radius: 10px;
            background: #0f172a;
            border-left: 4px solid #38bdf8;
        }

        .activity-log-entry h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #f8fafc;
        }

        .activity-log-entry p {
            margin: 0;
            font-size: 13px;
            color: #cbd5f5;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table-scroll {
            width: 100%;
            overflow-x: auto;
        }

        .table th {
            background: #111c2f;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #cbd5f5;
            font-weight: 600;
            border-bottom: 2px solid rgba(148, 163, 184, 0.3);
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            font-size: 14px;
            color: #e2e8f0;
            vertical-align: top;
        }

        .table tr:hover {
            background: rgba(59, 130, 246, 0.08);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .emoji {
            font-size: 16px;
        }

        .case-monitor-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .case-search-input {
            flex: 1;
            min-width: 220px;
            padding: 10px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            font-size: 14px;
            background: #0f172a;
            color: #f8fafc;
        }

        .case-search-input:focus {
            outline: none;
            border-color: #38bdf8;
        }

        .case-monitor-meta {
            font-size: 12px;
            color: #94a3b8;
            margin-left: auto;
        }

        .case-title {
            font-weight: 600;
            color: #f8fafc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 260px;
        }

        .case-meta {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .case-preview {
            margin-top: 6px;
            color: #cbd5f5;
            font-size: 13px;
            max-width: 360px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        .case-subtitle {
            font-size: 12px;
            color: #94a3b8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 260px;
        }

        .case-title-link a,
        .case-link-text {
            color: #38bdf8;
            cursor: pointer;
            text-decoration: none;
        }

        .case-link-text:hover,
        .case-title-link a:hover {
            color: #7dd3fc;
        }

        .case-link-text:focus-visible {
            outline: 2px solid #38bdf8;
            border-radius: 4px;
        }

        .case-link-text.link-loading {
            opacity: 0.6;
            position: relative;
        }

        .case-link-text.link-loading::after {
            content: '';
            display: inline-block;
            margin-left: 6px;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(148, 163, 184, 0.7);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .portal-section-heading {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #4a5568;
            margin-top: 10px;
        }

        .portal-details {
            margin-top: 6px;
            font-size: 12px;
            color: #2d3748;
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
        }

        .portal-details-row {
            display: flex;
            flex-direction: column;
            min-width: 140px;
        }

        .portal-details-row span.label {
            font-size: 10px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .portal-details-row span.value {
            margin-top: 2px;
        }

        .portal-timeline {
            margin-top: 8px;
            padding-left: 12px;
            border-left: 2px solid #cbd5f5;
        }

        .portal-timeline-item {
            margin-bottom: 8px;
        }

        .portal-timeline-label {
            font-size: 12px;
            font-weight: 600;
            color: #1a202c;
        }

        .portal-timeline-time {
            font-size: 11px;
            color: #718096;
            margin-left: 6px;
        }

        .portal-timeline-description {
            font-size: 11px;
            color: #4a5568;
            margin-top: 2px;
        }

        .portal-error {
            color: #c53030;
            font-weight: 600;
        }

        .portal-review-block {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            max-height: 240px;
            overflow-y: auto;
        }

        .message-cell {
            min-width: 240px;
            max-width: 380px;
        }

        .portal-timeline-collapsible {
            margin-top: 8px;
        }

        .portal-timeline-collapsible summary {
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .portal-timeline-collapsible summary::-webkit-details-marker {
            display: none;
        }

        .portal-timeline-collapsible summary::before {
            content: '‚ñ∏';
            font-size: 10px;
            color: #4a5568;
            transition: transform 0.2s;
        }

        .portal-timeline-collapsible[open] summary::before {
            transform: rotate(90deg);
        }

        .case-preview {
            margin-top: 6px;
            color: #2d3748;
            font-size: 13px;
            max-width: 360px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        .fee-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .fee-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fee-card h4 {
            margin: 0;
            font-size: 16px;
            color: #1a202c;
        }

        .fee-metadata {
            font-size: 12px;
            color: #4a5568;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .fee-response-preview {
            background: #f7fafc;
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
            color: #2d3748;
            white-space: pre-wrap;
        }

        .fee-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .fee-actions textarea {
            flex: 1;
            min-height: 80px;
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            padding: 10px;
            font-size: 13px;
            resize: vertical;
        }

        .fee-actions select {
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            padding: 8px;
            font-size: 13px;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            background: #edf2f7;
            color: #2d3748;
        }

        .status-pill.ready_to_send { background: #bee3f8; color: #2b6cb0; }
        .status-pill.awaiting_response { background: #faf089; color: #b7791f; }
        .status-pill.closed { background: #c6f6d5; color: #276749; }
        .status-pill.follow_up_scheduled { background: #e9d8fd; color: #553c9a; }

        .status-chip {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .status-chip.warn {
            background: rgba(249, 115, 22, 0.18);
            color: #9a3412;
        }

        .status-chip.info {
            background: rgba(14, 165, 233, 0.18);
            color: #075985;
        }

        .status-chip.success {
            background: rgba(34, 197, 94, 0.18);
            color: #166534;
        }

        .status-chip.muted {
            background: rgba(148, 163, 184, 0.25);
            color: #475569;
        }

        .status-chip.danger {
            background: rgba(248, 113, 113, 0.2);
            color: #991b1b;
        }

        .message-direction {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-direction.inbound {
            background: rgba(34, 197, 94, 0.2);
            color: #bbf7d0;
        }

        .message-direction.outbound {
            background: rgba(14, 165, 233, 0.2);
            color: #bae6fd;
        }

        .message-direction.neutral {
            background: rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }

        .table-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #2563eb;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }

        .table-btn:hover {
            opacity: 0.9;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: min(900px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #4a5568;
        }

        .thread-message {
            border-left: 4px solid #667eea;
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .thread-message.inbound {
            border-left-color: #48bb78;
        }

        .thread-message.outbound {
            border-left-color: #4299e1;
        }

        .thread-message-meta {
            font-size: 12px;
            color: #4a5568;
            margin-bottom: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .thread-message-body {
            font-size: 14px;
            color: #1a202c;
            white-space: pre-wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-field label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #94a3b8;
        }

        .form-field input {
            padding: 10px;
            border: 2px solid rgba(148, 163, 184, 0.35);
            border-radius: 8px;
            font-size: 14px;
            background: #0f172a;
            color: #f8fafc;
        }

        .form-field input:focus {
            outline: none;
            border-color: #38bdf8;
        }

        .inline-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #cbd5f5;
        }

        .inline-checkbox input {
            width: auto;
        }

        .utility-actions {
            margin-top: 30px;
            padding: 16px;
            border-radius: 12px;
            background: #0b1220;
            border: 1px solid rgba(148,163,184,0.2);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: flex-end;
        }

        .utility-actions button {
            padding: 10px 16px;
            font-size: 13px;
        }

        .utility-result {
            width: 100%;
            font-size: 13px;
            color: #cbd5f5;
        }

        .review-card-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .review-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 18px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .review-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
        }

        .review-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
        }

        .review-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .review-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 12px 18px;
        }

        .review-meta-item span.label {
            font-size: 11px;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.04em;
        }

        .review-meta-item span.value {
            display: block;
            margin-top: 4px;
            color: #1f2937;
            font-size: 13px;
        }

        .review-portal-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .review-portal-links {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
        }

        .review-note {
            width: 100%;
            border-radius: 10px;
            border: 1px solid #cbd5f5;
            padding: 10px;
            font-size: 13px;
            min-height: 70px;
            resize: vertical;
        }

        .review-actions-primary {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .review-advanced {
            background: #f8fafc;
            border-radius: 10px;
            padding: 10px;
        }

        .review-advanced summary {
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #475569;
        }

        .review-advanced-content {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .review-advanced-content select,
        .review-advanced-content input {
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            padding: 8px;
            font-size: 13px;
        }

        .fee-card-header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .fee-card-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .fee-card-quote {
            font-size: 13px;
            color: #1a202c;
            text-align: right;
        }

        .fee-card-quote strong {
            display: block;
            font-size: 18px;
        }

        .fee-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        .fee-card-note {
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
            color: #1f2937;
        }

        .live-log-card {
            background: #0b1220;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
        }

        .live-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .live-log-list {
            max-height: 260px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .live-log-entry {
            background: #0f172a;
            border-left: 4px solid #38bdf8;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .live-log-entry.error {
            border-left-color: #f87171;
        }

        .live-log-entry.warn {
            border-left-color: #fb923c;
        }

        .live-log-entry.success {
            border-left-color: #22c55e;
        }

        .live-log-entry .live-log-meta {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .live-log-entry strong {
            color: #f8fafc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ FOIA Agent Test Dashboard</h1>
            <p class="subtitle">Test the autonomous agent with real scenarios - no commands needed!</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item" id="agent-status">
                <div class="status-label">Agent Status</div>
                <div class="status-value">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Cases Created</div>
                <div class="status-value" id="cases-count">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Agent Decisions</div>
                <div class="status-value" id="decisions-count">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Escalations</div>
                <div class="status-value" id="escalations-count">0</div>
            </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid">
            

            

            

            <div class="card full-width">
                <h2>üí∞ Pending Fee Responses</h2>
                <p class="muted">
                    Every time an agency sends a fee estimate the AI drafts a reply, but nothing is sent until you approve it here.
                    Add guidance, regenerate, or approve to send instantly.
                </p>
                <div id="fee-response-container">
                    <p style="color:#718096;">No fee responses queued yet.</p>
                </div>
            </div>

            <div class="card full-width">
                <h2>üßë‚Äç‚öñÔ∏è Human Review Queue</h2>
                <div id="human-review-container">
                    <p style="color:#718096;">No cases need human review.</p>
                </div>
            </div>

            <div class="live-log-card">
                <div class="live-log-header">
                    <h3 style="color:#f1f5f9;font-size:18px;">‚ö° Live Case Logs</h3>
                    <small style="color:#94a3b8;" id="live-log-meta">Refreshing‚Ä¶</small>
                </div>
                <div id="live-log-list" class="live-log-list">
                    <p style="color:#718096;">Collecting recent events‚Ä¶</p>
                </div>
            </div>

            <!-- Live Case Monitor -->
            <div class="card full-width">
                <h2>üì° Live Case Monitor</h2>
                <div class="case-monitor-controls">
                    <input id="case-search" type="text" class="case-search-input" placeholder="Search by case name, agency, or email..." />
                    <select id="status-filter" class="case-search-input" style="max-width: 220px;">
                        <option value="all">All statuses</option>
                        <option value="ready_to_send">Ready to Send</option>
                        <option value="awaiting_response">Awaiting Response</option>
                        <option value="follow_up_scheduled">Follow-up Scheduled</option>
                        <option value="closed">Closed</option>
                    </select>
                    <button class="btn-info" onclick="loadCaseMonitor({ manual: true, announce: true })">
                        <span class="emoji">üîç</span> Search
                    </button>
                    <div class="case-monitor-meta" id="case-monitor-meta">Live view auto-refreshes every 30s</div>
                </div>
                <div id="case-monitor-table" class="table-scroll">
                    <p style="color: #718096;">Loading case overview...</p>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card full-width">
                <h2>üìù Activity Log</h2>
                <div id="activity-log-list" class="activity-log-list">
                    <p style="color:#718096;">Loading recent activity...</p>
                </div>
            </div>

            <!-- Console Output -->
            <div class="card full-width">
                <h2>üõ† Console</h2>
                <div id="console-output" class="output-box"></div>
            </div>

            <!-- Agent Decisions Table -->
            <div class="card full-width">
                <h2>ü§ñ Recent Agent Decisions</h2>
                <div id="decisions-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "View Agent Decisions" to load...</p>
                </div>
            </div>

            <!-- Escalations Table -->
            <div class="card full-width">
                <h2>üö® Pending Escalations</h2>
                <div id="escalations-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "View Escalations" to load...</p>
                </div>
            </div>

            <!-- Portal Runs Table -->
            <div class="card full-width">
                <h2>üåê Portal Automation Runs</h2>
                <div id="portal-runs-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "Portal Runs" to load...</p>
                </div>
            </div>

            <div class="utility-actions">
                <div class="utility-result" id="force-sync-result"></div>
                <div class="utility-result" id="portal-refresh-result"></div>
                <button class="btn-secondary" onclick="sendTestEmail(event)">
                    <span class="emoji">üì§</span> Send Test Email
                </button>
                <button class="btn-secondary" onclick="refreshPortalInfo(event)">
                    <span class="emoji">üßπ</span> Refresh Portal Info
                </button>
                <button class="btn-info" onclick="forceNotionSync(event)">
                    <span class="emoji">üîÑ</span> Sync Ready Cases
                </button>
            </div>
        </div>
    </div>

    <!-- Thread Modal -->
    <div id="thread-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close" onclick="closeThreadModal()" aria-label="Close">&times;</button>
            <h3 id="thread-modal-title" style="margin-bottom: 6px;">Case Thread</h3>
            <p id="thread-modal-summary" class="case-meta" style="margin-bottom: 20px;"></p>
            <div id="thread-modal-body"></div>
        </div>
    </div>

    <script>
        let caseMonitorTimer = null;
        let latestCaseMonitorCount = 0;
        const notionLinkCache = new Map();
        let liveLogTimer = null;
        let lastLiveLogTimestamp = null;
        const LIVE_LOG_EVENTS = {
            portal_run_started: 'info',
            portal_workflow_triggered: 'info',
            portal_stage_completed: 'success',
            portal_stage_failed: 'error',
            portal_submission: 'success',
            portal_submission_failed: 'error',
            portal_requires_human: 'warn',
            portal_status_synced: 'info',
            email_sent: 'success',
            generate_job_failed: 'error',
            generation_failed: 'error',
            notion_sync: 'info',
            case_imported: 'info',
            case_status_changed: 'info',
            portal_status_failed: 'error',
            portal_instruction_received: 'warn'
        };
        const LOG_METADATA_LABELS = {
            run_id: 'Run ID',
            task_id: 'Task ID',
            task_url: 'Skyvern Run',
            recording_url: 'Replay',
            portal_url: 'Portal',
            portal_provider: 'Provider',
            stage: 'Stage',
            engine: 'Engine',
            status: 'Status',
            submission_status: 'Submission',
            confirmation_number: 'Confirmation #',
            error: 'Error',
            message_id: 'Message',
            instructions: 'Instructions',
            case_id: 'Case ID'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Dashboard loaded', 'success');
            refreshStats();
            loadActivityLog();
            loadAgentDecisions();
            loadEscalations();
            loadPortalRuns();
            loadFeeResponses();
            loadHumanReviews();
            loadLiveLogs();
            setupCaseMonitorControls();
            loadCaseMonitor();
            scheduleCaseMonitorRefresh();
            scheduleLiveLogRefresh();

            const modal = document.getElementById('thread-modal');
            if (modal) {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeThreadModal();
                    }
                });
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeThreadModal();
            }
        });

        // Logging / Console
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            if (!output) {
                console[type === 'error' ? 'error' : 'log'](message);
                return;
            }

            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            const output = document.getElementById('console-output');
            if (output) {
                output.innerHTML = '';
            }
        }

        function setupCaseMonitorControls() {
            const searchInput = document.getElementById('case-search');
            const statusFilter = document.getElementById('status-filter');

            if (searchInput) {
                searchInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        loadCaseMonitor({ manual: true, announce: true });
                    }
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', () => loadCaseMonitor({ manual: true }));
            }
        }

        function scheduleCaseMonitorRefresh() {
            if (caseMonitorTimer) {
                clearInterval(caseMonitorTimer);
            }
            caseMonitorTimer = setInterval(() => loadCaseMonitor(), 30000);
        }

        function scheduleLiveLogRefresh() {
            if (liveLogTimer) {
                clearInterval(liveLogTimer);
            }
            liveLogTimer = setInterval(() => loadLiveLogs(), 15000);
        }

        function formatRelativeTime(value) {
            if (!value) return '‚Äî';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '‚Äî';

            const diffMs = Date.now() - date.getTime();
            const minutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMs / 3600000);
            const days = Math.floor(diffMs / 86400000);

            if (diffMs < 45000) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function formatDateTime(value) {
            if (!value) return '‚Äî';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '‚Äî';
            return date.toLocaleString();
        }

        function buildNotionUrl(pageId) {
            if (!pageId) return null;
            return `https://www.notion.so/${String(pageId).replace(/-/g, '')}`;
        }

        function formatSubjectPreview(name = '') {
            if (!name) return '';
            const clean = name.replace(/\s+/g, ' ').trim();
            if (!clean) return '';
            const separators = [',', ';', ' and ', ' & '];
            for (const sep of separators) {
                if (clean.toLowerCase().includes(sep.trim())) {
                    const parts = clean.split(new RegExp(sep, 'i'));
                    if (parts.length) {
                        return parts[0].trim() || clean;
                    }
                }
            }
            return clean;
        }

        function normalizeLogMetadata(metadata) {
            if (!metadata) return {};
            if (typeof metadata === 'object') {
                return metadata;
            }
            try {
                return JSON.parse(metadata);
            } catch (error) {
                return {};
            }
        }

        function renderMetadataChip(label, value, options = {}) {
            if (!value && value !== 0) return '';
            const variant = options.variant || 'muted';
            const content = options.link
                ? `<a href="${escapeHtml(String(value))}" target="_blank" rel="noopener">${escapeHtml(options.linkLabel || label)}</a>`
                : `${escapeHtml(label)}: ${escapeHtml(String(value))}`;
            return `<span class="status-chip ${variant}">${content}</span>`;
        }

        function renderLogMetadata(entry) {
            const metadata = normalizeLogMetadata(entry?.metadata);
            const keys = Object.keys(metadata || {});
            if (!keys.length) {
                return '';
            }

            const chips = [];
            const details = [];

            const portalUrl = metadata.portal_url;
            if (portalUrl) {
                chips.push(renderMetadataChip('Portal', portalUrl, { link: portalUrl, variant: 'info', linkLabel: 'Portal' }));
            }

            const taskUrl = metadata.task_url;
            if (taskUrl) {
                const label = /workflow/i.test(taskUrl) ? 'Workflow' : 'Task';
                chips.push(renderMetadataChip(label, taskUrl, { link: taskUrl, variant: 'info', linkLabel: label }));
            }

            const recordingUrl = metadata.recording_url;
            if (recordingUrl) {
                chips.push(renderMetadataChip('Replay', recordingUrl, { link: recordingUrl, variant: 'info', linkLabel: 'Replay' }));
            }

            const runId = metadata.run_id || metadata.task_id;
            if (runId) {
                chips.push(renderMetadataChip('Run ID', runId, { variant: 'muted' }));
            }

            const engine = metadata.engine;
            if (engine) {
                chips.push(renderMetadataChip('Engine', engine, { variant: 'muted' }));
            }

            const submissionStatus = metadata.submission_status || metadata.status;
            if (submissionStatus) {
                chips.push(renderMetadataChip('Status', submissionStatus, { variant: 'muted' }));
            }

            const confirmation = metadata.confirmation_number;
            if (confirmation) {
                chips.push(renderMetadataChip('Confirmation', confirmation, { variant: 'success' }));
            }

            const stage = metadata.stage;
            if (stage) {
                details.push(`Stage: ${escapeHtml(String(stage))}`);
            }

            const error = metadata.error;
            if (error) {
                chips.push(`<span class="status-chip danger">${escapeHtml(String(error))}</span>`);
            }

            const highlightKeys = new Set([
                'portal_url',
                'task_url',
                'recording_url',
                'run_id',
                'task_id',
                'engine',
                'status',
                'submission_status',
                'confirmation_number',
                'stage',
                'error'
            ]);

            const extras = Object.entries(metadata)
                .filter(([key, value]) => !highlightKeys.has(key) && value !== null && value !== undefined && value !== '')
                .slice(0, 4)
                .map(([key, value]) => `${escapeHtml(LOG_METADATA_LABELS[key] || key)}: ${escapeHtml(String(value))}`);

            const chipRow = chips.length
                ? `<div class="review-portal-summary" style="margin-top:6px;">${chips.join('')}</div>`
                : '';
            const detailRow = extras.length
                ? `<div class="case-meta">${extras.join(' ‚Ä¢ ')}</div>`
                : details.length
                    ? `<div class="case-meta">${details.join(' ‚Ä¢ ')}</div>`
                    : '';

            return chipRow || detailRow ? `${chipRow}${detailRow}` : '';
        }

        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function stripHtml(html = '') {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function normalizePortalUrl(url) {
            if (!url) return null;
            if (/^https?:\/\//i.test(url)) {
                return url;
            }
            return `https://${url}`;
        }

        function truncateText(text = '', maxLength = 160) {
            if (!text) return '';
            const clean = text.trim();
            if (clean.length <= maxLength) return clean;
            return `${clean.substring(0, maxLength - 1)}‚Ä¶`;
        }

        function renderPortalLinks(entity = {}) {
            const links = [];
            const portalUrl = normalizePortalUrl(entity.portal_url);
            const normalizedTask = entity.last_portal_task_url ? normalizePortalUrl(entity.last_portal_task_url) : null;
            const taskUrl = normalizedTask && normalizedTask !== portalUrl ? normalizedTask : null;
            const normalizedRecording = entity.last_portal_recording_url ? normalizePortalUrl(entity.last_portal_recording_url) : null;
            const recordingUrl = normalizedRecording && normalizedRecording !== portalUrl ? normalizedRecording : null;

            if (portalUrl) {
                const providerLabel = entity.portal_provider ? `${entity.portal_provider} portal` : 'Portal';
                links.push(`<a href="${escapeHtml(portalUrl)}" target="_blank" rel="noopener">${escapeHtml(providerLabel)}</a>`);
            }
            if (entity.last_portal_details?.portal_ticket_url) {
                links.push(`<a href="${escapeHtml(entity.last_portal_details.portal_ticket_url)}" target="_blank" rel="noopener">Ticket</a>`);
            }
            if (taskUrl) {
                const taskLabel = /workflow/i.test(taskUrl) ? 'Skyvern Workflow' : 'Skyvern Task';
                links.push(`<a href="${escapeHtml(taskUrl)}" target="_blank" rel="noopener">${escapeHtml(taskLabel)}</a>`);
            }
            if (recordingUrl) {
                links.push(`<a href="${escapeHtml(recordingUrl)}" target="_blank" rel="noopener">Skyvern Replay</a>`);
            }
            return links.length ? `<div class="case-meta portal-links">${links.join(' ‚Ä¢ ')}</div>` : '';
        }

        function renderPortalDetails(details, options = {}) {
            if (!details) return '';
            const rows = [];

            const addRow = (label, value) => {
                if (!value && value !== 0) return;
                rows.push(`
                    <div class="portal-details-row">
                        <span class="label">${escapeHtml(label)}</span>
                        <span class="value">${value}</span>
                    </div>
                `);
            };

            if (details.submission_status) {
                addRow('Status', escapeHtml(truncateText(details.submission_status, 80)));
            }
            if (details.confirmation_number) {
                addRow('Confirmation #', `<code>${escapeHtml(details.confirmation_number)}</code>`);
            }
            if (details.submission_timestamp) {
                addRow('Submitted', escapeHtml(formatDateTime(details.submission_timestamp)));
            }
            if (typeof details.login_success === 'boolean') {
                addRow('Login', details.login_success ? 'Successful' : 'Failed');
            }
            if (details.verification_required) {
                addRow('Verification', escapeHtml(truncateText(details.verification_reason || 'Required', 80)));
            }
            if (details.request_form_url) {
                addRow('Request Form', `<a href="${escapeHtml(details.request_form_url)}" target="_blank" rel="noopener">Open form</a>`);
            }
            if (details.submission_page_url) {
                addRow('Submission Page', `<a href="${escapeHtml(details.submission_page_url)}" target="_blank" rel="noopener">Open submission</a>`);
            }
            if (rows.length === 0) {
                return '';
            }

            const heading = options.heading
                ? `<div class="portal-section-heading">${escapeHtml(options.heading)}</div>`
                : '';

            return `${heading}<div class="portal-details">${rows.join('')}</div>`;
        }

        function normalizePortalMetadata(metadata) {
            if (!metadata) {
                return {};
            }
            if (typeof metadata === 'object') {
                return metadata;
            }
            try {
                return JSON.parse(metadata);
            } catch {
                return {};
            }
        }

        function formatPortalEventLabel(event = {}) {
            const type = event.event_type || 'portal_event';
            const normalizedMeta = normalizePortalMetadata(event.metadata);
            const metadataStage = normalizedMeta.stage;
            const titleCase = (str = '') => str.replace(/\b\w/g, (char) => char.toUpperCase());
            const cleanStage = metadataStage ? titleCase(metadataStage.replace(/_/g, ' ')) : null;

            let suffix = '';
            if (/_failed$/i.test(type)) {
                suffix = 'Failed';
            } else if (/_completed$/i.test(type)) {
                suffix = 'Completed';
            } else if (/_started$/i.test(type)) {
                suffix = 'Started';
            }

            const base = cleanStage || titleCase(type.replace(/^portal_/, '').replace(/_/g, ' '));
            return [base, suffix].filter(Boolean).join(' ').trim();
        }

        function renderPortalTimeline(events, options = {}) {
            if (!events || !events.length) {
                return '';
            }

            const limit = options.limit || 4;
            const heading = options.heading || 'Portal Activity';

            const items = events.slice(0, limit).map((event) => {
                const metadata = normalizePortalMetadata(event.metadata);
                const label = formatPortalEventLabel(event);
                const timeAgo = event.created_at ? formatRelativeTime(event.created_at) : '‚Äî';
                const description = event.description
                    ? `<div class="portal-timeline-description">${escapeHtml(truncateText(event.description, 160))}</div>`
                    : '';
                const errorDetail = metadata.error
                    ? `<div class="portal-timeline-description portal-error">${escapeHtml(truncateText(metadata.error, 160))}</div>`
                    : '';
                return `
                    <div class="portal-timeline-item">
                        <div>
                            <span class="portal-timeline-label">${escapeHtml(label)}</span>
                            <span class="portal-timeline-time">${escapeHtml(timeAgo)}</span>
                        </div>
                        ${description}
                        ${errorDetail}
                    </div>
                `;
            }).join('');

            return `
                <details class="portal-timeline-collapsible">
                    <summary>${escapeHtml(heading)} (${events.length})</summary>
                    <div class="portal-timeline">${items}</div>
                </details>
            `;
        }

        function renderPortalStatusCell(c) {
            const status = c.last_portal_status ? escapeHtml(c.last_portal_status) : '‚Äî';
            const metaParts = [];
            if (c.last_portal_status_at) {
                metaParts.push(formatRelativeTime(c.last_portal_status_at));
            }
            if (c.last_portal_engine) {
                metaParts.push(`via ${escapeHtml(c.last_portal_engine)}`);
            }
            const metaHtml = metaParts.length ? `<div class="case-meta">${metaParts.join(' ‚Ä¢ ')}</div>` : '';
            const provider = c.portal_provider ? `<div class="case-meta">Provider: ${escapeHtml(c.portal_provider)}</div>` : '';
            const linksHtml = renderPortalLinks(c);
            const detailsHtml = renderPortalDetails(c.last_portal_details || null);
            const timelineHtml = renderPortalTimeline(c.portal_events || []);
            const accountHtml = c.last_portal_account_email
                ? `<div class="case-meta">Login Email: ${escapeHtml(c.last_portal_account_email)} (password stored securely)</div>`
                : '';
            const runMeta = c.last_portal_run_id ? `<div class="case-meta">Run: ${escapeHtml(String(c.last_portal_run_id))}</div>` : '';
            const completionWarning = c.last_portal_status && /completed|submitted|success/i.test(c.last_portal_status) && c.status && c.status !== 'sent'
                ? `<div class="case-meta"><span class="status-chip warn">Portal done ‚Ä¢ Case ${escapeHtml(c.status)}</span></div>`
                : '';
            return `<div class="case-title">${status}</div>${metaHtml}${provider}${runMeta}${linksHtml}${accountHtml}${completionWarning}${detailsHtml}${timelineHtml}`;
        }

        function renderStatusPill(status, substatus) {
            if (!status) return '<span class="status-pill">Unknown</span>';
            const className = `status-pill ${status}`;
            const label = escapeHtml(status.replace(/_/g, ' '));
            const sub = substatus ? `<div class="case-meta">${escapeHtml(substatus)}</div>` : '';
            return `<div><span class="${className}">${label}</span>${sub}</div>`;
        }

        function renderDirectionBadge(direction) {
            if (!direction) {
                return '<span class="message-direction neutral">No messages</span>';
            }
            const dir = direction === 'inbound' ? 'inbound' : direction === 'outbound' ? 'outbound' : 'neutral';
            const label = direction.charAt(0).toUpperCase() + direction.slice(1);
            return `<span class="message-direction ${dir}">${label}</span>`;
        }

        async function loadCaseMonitor(options = {}) {
            const container = document.getElementById('case-monitor-table');
            const meta = document.getElementById('case-monitor-meta');
            if (!container) return;

            const searchInput = document.getElementById('case-search');
            const statusFilter = document.getElementById('status-filter');
            const params = new URLSearchParams();

            if (searchInput && searchInput.value.trim().length > 0) {
                params.set('search', searchInput.value.trim());
            }
            if (statusFilter && statusFilter.value !== 'all') {
                params.set('status', statusFilter.value);
            }
            params.set('limit', '100');

            const queryString = params.toString();
            const endpoint = `/test/cases${queryString ? `?${queryString}` : ''}`;

            if (options.manual || options.announce) {
                log('üì° Refreshing live case monitor...');
            }

            try {
                const result = await apiCall(endpoint);
                const cases = result.cases || [];
                latestCaseMonitorCount = cases.length;
                renderCaseMonitor(cases);

                if (meta) {
                    meta.textContent = `Updated ${new Date().toLocaleTimeString()} ‚Ä¢ Showing ${cases.length} case${cases.length === 1 ? '' : 's'}`;
                }

                if (options.manual || options.announce) {
                    log(`‚úÖ Loaded ${cases.length} cases`, 'success');
                }
            } catch (error) {
                container.innerHTML = `<p style="color: #e53e3e;">Failed to load cases: ${escapeHtml(error.message)}</p>`;
                if (options.manual || options.announce) {
                    log(`‚ùå Failed to load case monitor: ${error.message}`, 'error');
                }
            }
        }

        function renderCaseMonitor(cases = []) {
            const container = document.getElementById('case-monitor-table');
            if (!container) return;

            if (!cases.length) {
                container.innerHTML = '<p style="color: #718096;">No cases match the current filters.</p>';
                return;
            }

            let html = '<table class="table"><thead><tr>';
            html += '<th>Case</th><th>Agency</th><th>Status</th><th>Portal</th><th>Last Response</th><th>Messages</th><th>Next Step</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            cases.forEach((c) => {
                const primaryName = escapeHtml(c.case_name || c.subject_name || 'Untitled case');
                const hasSecondary = c.subject_name && c.case_name && c.subject_name !== c.case_name;
                const subjectPreview = hasSecondary ? formatSubjectPreview(c.subject_name || '') : '';
                const hasMoreSubjects = hasSecondary && subjectPreview && subjectPreview.length < (c.subject_name || '').trim().length;
                const secondaryLine = hasSecondary
                    ? `<div class="case-subtitle" title="${escapeHtml(c.subject_name)}">Subject: ${escapeHtml(subjectPreview || c.subject_name)}${hasMoreSubjects ? ' +' : ''}</div>`
                    : '';
                const agency = escapeHtml(c.agency_name || 'Unknown agency');
                const caseNotionUrl = buildNotionUrl(c.notion_page_id);
                const caseTitleClass = caseNotionUrl ? 'case-title case-title-link' : 'case-title';
                const caseTitleContent = caseNotionUrl
                    ? `<a class="case-link-text" href="${escapeHtml(caseNotionUrl)}" target="_blank" rel="noopener">${primaryName}</a>`
                    : primaryName;
                const agencyTitleClass = 'case-title case-agency-link';
                const agencyTitleContent = `<span class="case-link-text" role="link" tabindex="0" onclick="openAgencyCard(event, ${c.id})" onkeydown="handleAgencyLinkKey(event, ${c.id})">${agency}</span>`;
                const statusHtml = renderStatusPill(c.status, c.substatus);
                const directionBadge = renderDirectionBadge(c.last_message_direction);
                const preview = escapeHtml(c.last_message_preview || 'No correspondence yet.');
                const lastActivity = c.last_message_at
                    ? formatRelativeTime(c.last_message_at)
                    : formatRelativeTime(c.updated_at);
                const totalMessages = c.total_messages || 0;
                const inboundMeta = c.last_inbound_at ? formatRelativeTime(c.last_inbound_at) : '‚Äî';
                const outboundMeta = c.last_outbound_at ? formatRelativeTime(c.last_outbound_at) : '‚Äî';
                const followupText = c.next_followup_date
                    ? `${formatDateTime(c.next_followup_date)} (${formatRelativeTime(c.next_followup_date)})`
                    : '‚Äî';
                const followupStatus = c.followup_status ? `<div class="case-meta">Status: ${escapeHtml(c.followup_status)}</div>` : '';

                html += '<tr>';
                html += `<td>
                    <div class="${caseTitleClass}" title="${primaryName}">${caseTitleContent}</div>
                    ${secondaryLine}
                    <div class="case-meta">#${c.id} ‚Ä¢ Created ${formatRelativeTime(c.created_at)}</div>
                </td>`;
                html += `<td>
                    <div class="${agencyTitleClass}" title="${agency}">${agencyTitleContent}</div>
                    <div class="case-meta">${escapeHtml(c.agency_email || '‚Äî')}</div>
                </td>`;
                const portalCell = renderPortalStatusCell(c);

                html += `<td>${statusHtml}</td>`;
                html += `<td>${portalCell}</td>`;
                html += `<td class="message-cell">
                    ${directionBadge}
                    <div class="case-meta">${lastActivity}</div>
                    <div class="case-preview">${preview}</div>
                </td>`;
                html += `<td><div class="case-title">${totalMessages} message${totalMessages === 1 ? '' : 's'}</div><div class="case-meta">Inbound: ${inboundMeta} ‚Ä¢ Outbound: ${outboundMeta}</div></td>`;
                html += `<td><div class="case-title">${followupText}</div>${followupStatus}</td>`;
                html += `<td>
                    <button class="table-btn" onclick="openThreadModal(${c.id})">View Thread</button>
                    <button class="table-btn" onclick="retriggerAnalysis(${c.id})" style="background: #ed8936; margin-top: 5px;">Retrigger</button>
                </td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function loadLiveLogs() {
            try {
                const result = await apiCall('/test/activity?limit=80');
                renderLiveLogs(result.activity || []);
            } catch (error) {
                const container = document.getElementById('live-log-list');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load logs: ${escapeHtml(error.message)}</p>`;
                }
                const meta = document.getElementById('live-log-meta');
                if (meta) {
                    meta.textContent = 'Failed to refresh';
                }
            }
        }

        function renderLiveLogs(entries = []) {
            const container = document.getElementById('live-log-list');
            const meta = document.getElementById('live-log-meta');
            if (!container) return;

            const relevant = entries
                .filter((entry) => entry && LIVE_LOG_EVENTS[entry.event_type])
                .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))
                .slice(0, 25);

            if (!relevant.length) {
                container.innerHTML = '<p style="color:#718096;">No recent automation logs.</p>';
                if (meta) {
                    meta.textContent = `Updated ${new Date().toLocaleTimeString()} ‚Ä¢ No recent logs`;
                }
                return;
            }

            let newestTimestamp = lastLiveLogTimestamp || 0;
            const html = relevant.map((entry) => {
                const severity = LIVE_LOG_EVENTS[entry.event_type] || 'info';
                const timestamp = entry.created_at ? new Date(entry.created_at) : null;
                const timeLabel = timestamp ? timestamp.toLocaleTimeString() : '';
                const caseLabel = entry.case_name
                    ? `${escapeHtml(entry.case_name)}`
                    : entry.case_id
                        ? `Case ${entry.case_id}`
                        : '‚Äî';
                const description = escapeHtml(entry.description || '');
                const eventLabel = escapeHtml(entry.event_type.replace(/_/g, ' '));
                const isNew = timestamp && timestamp.getTime() > (lastLiveLogTimestamp || 0);
                if (timestamp) {
                    newestTimestamp = Math.max(newestTimestamp, timestamp.getTime());
                }
                return `
                    <div class="live-log-entry ${severity}">
                        <div class="live-log-meta">
                            <span>${eventLabel}</span>
                            <span>${timeLabel}</span>
                            <span>${caseLabel}</span>
                            ${isNew ? '<span class="status-chip info">new</span>' : ''}
                        </div>
                        <div>${description || '<em>No details</em>'}</div>
                        ${renderLogMetadata(entry)}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            lastLiveLogTimestamp = newestTimestamp;
            if (meta) {
                meta.textContent = `Updated ${new Date().toLocaleTimeString()} ‚Ä¢ Showing ${relevant.length}`;
            }
        }

        async function openAgencyCard(event, caseId) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            if (!caseId) {
                return;
            }

            const target = event?.currentTarget || null;
            if (target) {
                target.classList.add('link-loading');
            }

            try {
                let linkInfo = notionLinkCache.get(caseId);
                if (!linkInfo) {
                    const response = await apiCall(`/test/cases/${caseId}/notion-links`);
                    if (!response.success) {
                        throw new Error(response.error || 'Unable to load Notion links');
                    }
                    notionLinkCache.set(caseId, response);
                    linkInfo = response;
                }

                if (linkInfo.agency_url) {
                    const newWindow = window.open(linkInfo.agency_url, '_blank');
                    if (newWindow) {
                        newWindow.opener = null;
                    }
                } else {
                    log('‚ö†Ô∏è No police department card is linked on Notion for this case.', 'warning');
                }
            } catch (error) {
                log(`‚ùå Failed to open police department card: ${error.message}`, 'error');
            } finally {
                if (target) {
                    target.classList.remove('link-loading');
                }
            }
        }

        function handleAgencyLinkKey(event, caseId) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openAgencyCard(event, caseId);
            }
        }

        async function openThreadModal(caseId) {
            const modal = document.getElementById('thread-modal');
            const title = document.getElementById('thread-modal-title');
            const summary = document.getElementById('thread-modal-summary');
            const body = document.getElementById('thread-modal-body');

            if (!modal || !body) return;

            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            body.innerHTML = '<p style="color: #718096;">Loading correspondence...</p>';

            try {
                const result = await apiCall(`/test/cases/${caseId}/messages`);
                const caseData = result.case || {};
                title.textContent = `${caseData.case_name || 'Case'} (#${caseData.id || caseId})`;
                summary.textContent = [
                    caseData.agency_name || 'Unknown agency',
                    caseData.agency_email || 'No email',
                    caseData.status ? `Status: ${caseData.status.replace(/_/g, ' ')}` : ''
                ].filter(Boolean).join(' ‚Ä¢ ');

                renderThreadMessages(result.messages || []);
            } catch (error) {
                body.innerHTML = `<p style="color: #e53e3e;">${escapeHtml(error.message)}</p>`;
            }
        }

        function closeThreadModal() {
            const modal = document.getElementById('thread-modal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function renderThreadMessages(messages = []) {
            const body = document.getElementById('thread-modal-body');
            if (!body) return;

            if (!messages.length) {
                body.innerHTML = '<p style="color: #718096;">No correspondence yet for this case.</p>';
                return;
            }

            const html = messages.map((msg) => {
                const direction = msg.direction || 'neutral';
                const subject = escapeHtml(msg.subject || '(No subject)');
                const timestamp = formatDateTime(msg.message_timestamp);
                const fallbackText = msg.body_text && msg.body_text.trim().length > 0
                    ? msg.body_text
                    : stripHtml(msg.body_html || '');
                const content = escapeHtml(fallbackText || '').replace(/\n/g, '<br>');

                return `
                    <div class="thread-message ${direction}">
                        <div class="thread-message-meta">
                            <span class="message-direction ${direction}">${direction.toUpperCase()}</span>
                            <span>${timestamp}</span>
                            <span>${subject}</span>
                        </div>
                        <div class="thread-message-body">${content || '<em>No content</em>'}</div>
                    </div>
                `;
            }).join('');

            body.innerHTML = html;
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(`/api${endpoint}`, options);
                const data = await response.json();
                return data;
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Refresh Stats
        async function refreshStats() {
            log('üîÑ Refreshing statistics...');

            try {
                // Agent is always enabled (hardcoded)
                const statusDiv = document.getElementById('agent-status');
                statusDiv.className = 'status-item active';
                statusDiv.querySelector('.status-value').textContent = 'ENABLED ‚úÖ';

                // Get stats
                const stats = await apiCall('/test/stats');
                document.getElementById('cases-count').textContent = stats.total_cases || 0;
                document.getElementById('decisions-count').textContent = stats.agent_decisions || 0;
                document.getElementById('escalations-count').textContent = stats.escalations || 0;

                log('‚úÖ Stats refreshed', 'success');
            } catch (error) {
                log(`‚ùå Failed to refresh stats: ${error.message}`, 'error');
            }
        }

        // Send Test Email
        async function sendTestEmail(evt) {
            const btn = evt?.target?.closest('button');
            if (!btn) return;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Sending...';

            log('üì§ Sending test email...');

            try {
                const result = await apiCall('/test/send-and-reply', 'POST');

                if (result.success) {
                    log(`‚úÖ Test email sent! Case ID: ${result.case_id}`, 'success');
                    log(`üìß Email sent to: ${result.sent_to}`, 'info');
                    log(`üìã Message ID: ${result.message_id}`, 'info');

                    await refreshStats();
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üì§</span> Send Test Email';
            }
        }

        // Force Notion Sync
        async function forceNotionSync(evt) {
            const btn = evt?.target?.closest('button');
            if (!btn) return;
            const resultBox = document.getElementById('force-sync-result');

            if (!confirm('Sync all "Ready to Send" cases from Notion and queue them for sending?')) {
                return;
            }

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Syncing...';
            resultBox.innerHTML = '<p style="color:#718096;">Syncing from Notion...</p>';

            try {
                log('üîÑ Force syncing cases from Notion...', 'info');
                const result = await apiCall('/test/force-notion-sync', 'POST', {});

                if (result.success) {
                    const lines = [];
                    lines.push(`<strong>‚úÖ Synced ${result.synced_count} cases from Notion</strong>`);
                    lines.push(`üì§ Queued for sending: ${result.queued_count}`);
                    lines.push(`‚ö†Ô∏è Flagged for review: ${result.review_count}`);

                    if (result.results && result.results.length > 0) {
                        lines.push('<br><strong>Details:</strong>');
                        result.results.forEach(r => {
                            const icon = r.status === 'queued' ? '‚úÖ' : '‚ö†Ô∏è';
                            lines.push(`${icon} Case ${r.id}: ${escapeHtml(r.case_name || 'Untitled')} - ${escapeHtml(r.message)}`);
                        });
                    }

                    resultBox.innerHTML = lines.map(line => `<div style="margin-bottom:4px;">${line}</div>`).join('');
                    log(`‚úÖ Synced ${result.synced_count} cases - ${result.queued_count} queued, ${result.review_count} flagged`, 'success');

                    // Refresh the case monitor
                    await loadCaseMonitor({ manual: true });
                    await refreshStats();
                } else {
                    resultBox.innerHTML = `<span style="color:#e53e3e;">Failed: ${escapeHtml(result.error || 'Unknown error')}</span>`;
                    log(`‚ùå Force sync failed: ${result.error}`, 'error');
                }
            } catch (error) {
                resultBox.innerHTML = `<span style="color:#e53e3e;">${escapeHtml(error.message)}</span>`;
                log(`‚ùå Force sync error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Refresh PD info / portal links
        async function refreshPortalInfo(evt) {
            const btn = evt?.target?.closest('button');
            if (!btn) return;
            const resultBox = document.getElementById('portal-refresh-result');

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Refreshing...';
            if (resultBox) {
                resultBox.innerHTML = '<p style="color:#718096;">Re-importing police department info...</p>';
            }

            try {
                log('üßπ Re-importing PD info for cases missing portal URLs...', 'info');
                const result = await apiCall('/test/cases/reimport-pd-info', 'POST', {});

                const lines = [];
                lines.push(`<strong>Processed:</strong> ${result.processed || 0}`);
                lines.push(`<strong>Updated:</strong> ${result.updated || 0}`);
                if (result.message) {
                    lines.push(escapeHtml(result.message));
                }

                if (result.results && result.results.length) {
                    const detailLines = result.results.slice(0, 5).map((entry) => {
                        const icon = entry.status === 'updated'
                            ? '‚úÖ'
                            : entry.status === 'error'
                                ? '‚ùå'
                                : '‚ÑπÔ∏è';
                        const name = escapeHtml(entry.case_name || `Case ${entry.case_id}`);
                        const status = escapeHtml(entry.status || 'unknown');
                        return `${icon} ${name}: ${status}${entry.error ? ` - ${escapeHtml(entry.error)}` : ''}`;
                    });
                    lines.push('<strong>Details:</strong>');
                    lines.push(detailLines.join('<br>'));
                }

                if (resultBox) {
                    resultBox.innerHTML = lines.map((line) => `<div style="margin-bottom:4px;">${line}</div>`).join('');
                }

                log(`‚úÖ PD refresh complete - processed ${result.processed || 0}, updated ${result.updated || 0}`, 'success');
                await loadCaseMonitor({ manual: true });
            } catch (error) {
                if (resultBox) {
                    resultBox.innerHTML = `<p style="color:#f87171;">${escapeHtml(error.message || 'Failed to refresh portal info')}</p>`;
                }
                log(`‚ùå Failed to refresh PD info: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Fee response workflow
        async function loadFeeResponses() {
            try {
                const result = await apiCall('/test/fee-responses');
                renderFeeResponses(result.items || []);
            } catch (error) {
                log(`‚ùå Failed to load fee responses: ${error.message}`, 'error');
            }
        }

        async function loadHumanReviews() {
            try {
                const result = await apiCall('/test/human-reviews');
                renderHumanReviews(result.cases || []);
            } catch (error) {
                const container = document.getElementById('human-review-container');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load human reviews: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        function renderHumanReviews(items) {
            const container = document.getElementById('human-review-container');
            if (!container) return;

            if (!items.length) {
                container.innerHTML = '<p style="color:#718096;">No cases are waiting for human review.</p>';
                return;
            }

            const html = items.map((item) => {
                const statusLabel = escapeHtml((item.status || 'needs_review').replace(/_/g, ' '));
                const substatusLabel = item.substatus
                    ? escapeHtml(item.substatus.replace(/_/g, ' '))
                    : null;
                const issueChips = [];
                if (substatusLabel) {
                    issueChips.push(`<span class="status-chip warn">${substatusLabel}</span>`);
                }
                if (!item.portal_url) {
                    issueChips.push('<span class="status-chip danger">Portal missing</span>');
                }
                if (!item.agency_email) {
                    issueChips.push('<span class="status-chip warn">No agency email</span>');
                }

                const portalUrl = item.portal_url ? normalizePortalUrl(item.portal_url) : null;
                const portalSummary = `
                    <div class="review-portal-summary">
                        ${portalUrl ? `<a href="${escapeHtml(portalUrl)}" target="_blank" rel="noopener">${escapeHtml(item.portal_provider || 'Open portal')}</a>` : '<span class="status-chip danger">No portal link stored</span>'}
                        ${item.last_portal_account_email ? `<span class="status-chip info">Login: ${escapeHtml(item.last_portal_account_email)}</span>` : ''}
                        ${item.last_portal_status ? `<span class="status-chip muted">Skyvern: ${escapeHtml(item.last_portal_status)}</span>` : ''}
                        ${item.last_portal_engine ? `<span class="status-chip muted">${escapeHtml(item.last_portal_engine)}</span>` : ''}
                    </div>
                    <div class="review-portal-links">
                        ${renderPortalLinks(item)}
                        ${item.last_portal_task_url ? `<a href="${escapeHtml(item.last_portal_task_url)}" target="_blank" rel="noopener">Latest Skyvern task</a>` : ''}
                        ${item.last_portal_recording_url && !item.last_portal_task_url ? `<a href="${escapeHtml(item.last_portal_recording_url)}" target="_blank" rel="noopener">Skyvern recording</a>` : ''}
                    </div>
                `;

                const lastActivity = item.last_activity_description
                    ? `<div class="review-meta-item"><span class="label">Last Activity</span><span class="value">${escapeHtml(item.last_activity_description)}</span></div>`
                    : '';

                const lastMessage = item.last_message_body
                    ? `<div class="review-meta-item"><span class="label">Latest message</span><span class="value">${escapeHtml(item.last_message_body.substring(0, 320))}${item.last_message_body.length > 320 ? '‚Ä¶' : ''}</span></div>`
                    : '';

                const portalDetailsHtml = renderPortalDetails(item.last_portal_details || null, { heading: 'Portal Submission' });
                const portalTimelineHtml = renderPortalTimeline(item.portal_events || [], { heading: 'Portal Activity', limit: 5 });
                const portalInfoHtml = (portalDetailsHtml || portalTimelineHtml)
                    ? `<div class="portal-review-block">${portalDetailsHtml}${portalTimelineHtml}</div>`
                    : '';
                const headerAction = portalUrl
                    ? `<a class="btn-secondary" href="${escapeHtml(portalUrl)}" target="_blank" rel="noopener"><span class="emoji">üåê</span> Open Portal</a>`
                    : `<button class="btn-secondary" onclick="openThreadModal(${item.id})"><span class="emoji">üì®</span> View Thread</button>`;

                return `
                    <div class="review-card" id="human-review-${item.id}">
                        <div class="review-header">
                            <div>
                                <div class="review-title">Case ${item.id}: ${escapeHtml(item.case_name || 'Untitled')}</div>
                                <div class="review-badges">
                                    <span class="status-chip info">${statusLabel}</span>
                                    ${issueChips.join('')}
                                </div>
                            </div>
                            <div class="review-portal-links">
                                ${headerAction}
                            </div>
                        </div>
                        <div class="review-meta-grid">
                            <div class="review-meta-item">
                                <span class="label">Agency</span>
                                <span class="value">${escapeHtml(item.agency_name || 'Unknown')} ‚Ä¢ ${escapeHtml(item.agency_email || 'No email')}</span>
                            </div>
                            <div class="review-meta-item">
                                <span class="label">Reason</span>
                                <span class="value">${substatusLabel || 'Needs review'}</span>
                            </div>
                            ${lastActivity}
                            ${lastMessage}
                        </div>
                        ${portalSummary}
                        ${portalInfoHtml}
                        <textarea class="review-note" data-review-note="${item.id}" placeholder="Add context or instructions..."></textarea>
                        <div class="review-actions-primary">
                            <button class="btn-success" onclick="submitHumanReviewDecision(${item.id}, this, { action: 'approve' })">
                                <span class="emoji">‚úÖ</span> Approve & Queue
                            </button>
                            <button class="btn-danger" onclick="submitHumanReviewDecision(${item.id}, this, { action: 'reject' })">
                                <span class="emoji">‚õî</span> Reject
                            </button>
                            <button class="btn-warning" onclick="submitHumanReviewDecision(${item.id}, this, { action: 'change', nextStatus: 'manual_followup' })">
                                <span class="emoji">üõ†</span> Manual Follow-up
                            </button>
                            <button class="btn-secondary" onclick="openThreadModal(${item.id})">
                                <span class="emoji">üì®</span> View Thread
                            </button>
                        </div>
                        <details class="review-advanced">
                            <summary>Advanced options</summary>
                            <div class="review-advanced-content">
                                <select data-review-action="${item.id}">
                                    <option value="approve">Approve</option>
                                    <option value="reject">Reject</option>
                                    <option value="change">Change</option>
                                </select>
                                <input data-review-next-status="${item.id}" placeholder="Next status (optional)" />
                            </div>
                        </details>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="review-card-grid">${html}</div>`;
        }

        async function submitHumanReviewDecision(caseId, buttonEl, overrides = {}) {
            const noteEl = document.querySelector(`[data-review-note="${caseId}"]`);
            const actionEl = document.querySelector(`[data-review-action="${caseId}"]`);
            const nextStatusEl = document.querySelector(`[data-review-next-status="${caseId}"]`);

            if (overrides.action && actionEl) {
                actionEl.value = overrides.action;
            }
            if (overrides.nextStatus && nextStatusEl) {
                nextStatusEl.value = overrides.nextStatus;
            }

            const action = overrides.action || (actionEl ? actionEl.value : 'approve');
            const note = overrides.note !== undefined
                ? overrides.note
                : (noteEl ? noteEl.value.trim() : '');
            const nextStatus = overrides.nextStatus !== undefined
                ? overrides.nextStatus
                : (nextStatusEl && nextStatusEl.value.trim() ? nextStatusEl.value.trim() : undefined);

            const payload = {
                action,
                note,
                next_status: nextStatus
            };

            const btn = buttonEl || (typeof event !== 'undefined' ? event.target.closest('button') : null);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Saving...';
            }

            try {
                const result = await apiCall(`/test/human-reviews/${caseId}/decision`, 'POST', payload);
                if (result.success) {
                    log(`‚úÖ Recorded human review decision for case ${caseId}`, 'success');
                    await loadHumanReviews();
                    await loadCaseMonitor({ manual: true });
                    await loadActivityLog();
                } else {
                    log(`‚ùå Failed to record decision: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error recording decision: ${error.message}`, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="emoji">‚úÖ</span> Submit Decision';
                }
            }
        }

        function renderFeeResponses(items) {
            const container = document.getElementById('fee-response-container');
            if (!container) return;

            if (!items.length) {
                container.innerHTML = '<p style="color:#718096;">No fee responses awaiting approval.</p>';
                return;
            }

            const html = items.map(item => {
                const metadata = item.metadata || {};
                const amount = metadata.fee_amount ? `$${Number(metadata.fee_amount).toFixed(2)}` : '‚Äî';
                const recommendedAction = metadata.recommended_action || 'negotiate';
                const actionLabel = recommendedAction.replace(/_/g, ' ');
                const instructions = metadata.instructions || '';
                const original = item.original_message ? escapeHtml(item.original_message.substring(0, 300)) + (item.original_message.length > 300 ? '‚Ä¶' : '') : '‚Äî';
                const status = escapeHtml(item.status);
                const replyPreview = escapeHtml(item.generated_reply || '').replace(/\n/g, '<br>');

                return `
                    <div class="fee-card" id="fee-card-${item.id}">
                        <div class="fee-card-header">
                            <div class="fee-card-title">
                                <span class="status-chip warn">${status}</span>
                                <span>Case ${item.case_id}: ${escapeHtml(item.case_name || 'Untitled')}</span>
                            </div>
                            <div class="fee-card-quote">
                                <span>Quoted</span>
                                <strong>${amount}</strong>
                            </div>
                        </div>
                        <div class="fee-card-tags">
                            <span class="status-chip info">Recommended: ${escapeHtml(actionLabel)}</span>
                            ${metadata.deadline ? `<span class="status-chip muted">Deadline ${escapeHtml(metadata.deadline)}</span>` : ''}
                        </div>
                        ${instructions ? `<div class="fee-card-note"><strong>Guidance</strong><br>${escapeHtml(instructions)}</div>` : ''}
                        <div class="fee-response-preview">${replyPreview || '<em>No draft generated</em>'}</div>
                        <details>
                            <summary style="cursor:pointer; font-size:12px; color:#4a5568;">View agency quote</summary>
                            <div style="margin-top:8px; font-size:12px; color:#2d3748;">${original}</div>
                        </details>
                        <div class="fee-actions">
                            <textarea data-fee-instructions="${item.id}" data-original-instructions="${escapeHtml(instructions)}" placeholder="Edit instructions before regenerating...">${escapeHtml(instructions)}</textarea>
                            <div style="display:flex; flex-direction:column; gap:8px; min-width:200px;">
                                <label style="font-size:12px; text-transform:uppercase; color:#4a5568;">Action</label>
                                <select data-fee-action="${item.id}" data-original-action="${recommendedAction}">
                                    ${['accept','negotiate','escalate'].map(opt => `<option value="${opt}" ${ recommendedAction === opt ? 'selected' : '' }>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('')}
                                </select>
                                <button class="btn-secondary" onclick="openThreadModal(${item.case_id})">
                                    <span class="emoji">üì®</span> View Thread
                                </button>
                                <button class="btn-info" onclick="regenerateFeeResponse(${item.id}, this)">
                                    <span class="emoji">‚ôªÔ∏è</span> Regenerate
                                </button>
                                <button class="btn-success" onclick="approveFeeResponse(${item.id}, this)">
                                    <span class="emoji">‚úÖ</span> Approve & Send
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="fee-card-grid">${html}</div>`;
        }

        async function approveFeeResponse(id, buttonEl) {
            const btn = buttonEl || null;
            if (!btn) return;

            const instructionsEl = document.querySelector(`[data-fee-instructions="${id}"]`);
            const actionEl = document.querySelector(`[data-fee-action="${id}"]`);
            const currentInstructions = instructionsEl ? instructionsEl.value.trim() : '';
            const originalInstructions = instructionsEl ? (instructionsEl.dataset.originalInstructions || '') : '';
            const currentAction = actionEl ? actionEl.value : null;
            const originalAction = actionEl ? (actionEl.dataset.originalAction || 'negotiate') : 'negotiate';

            if ((currentInstructions !== originalInstructions) || (currentAction !== originalAction)) {
                log('‚úèÔ∏è Detected changes to instructions/action. Regenerating draft before sending...', 'warning');
                const regenSuccess = await regenerateFeeResponse(id, null, {
                    instructions: currentInstructions,
                    action: currentAction,
                    silent: true
                });
                if (regenSuccess) {
                    log('üìù Draft updated. Review the new text, then click "Approve & Send" when ready.', 'info');
                }
                return;
            }

            const original = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Sending...';

            try {
                const result = await apiCall(`/test/fee-responses/${id}/approve`, 'POST', {});
                if (result.success) {
                    log(`‚úÖ Fee response ${id} approved and sent`, 'success');
                    await loadFeeResponses();
                    await refreshStats();
                } else {
                    log(`‚ùå Failed to approve fee response: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error approving fee response: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = original;
            }
        }

        async function regenerateFeeResponse(id, buttonEl, opts = {}) {
            const instructionsEl = document.querySelector(`[data-fee-instructions="${id}"]`);
            const actionEl = document.querySelector(`[data-fee-action="${id}"]`);
            const instructions = opts.instructions !== undefined
                ? opts.instructions
                : (instructionsEl ? instructionsEl.value.trim() : '');
            const action = opts.action !== undefined
                ? opts.action
                : (actionEl ? actionEl.value : null);
            const silent = opts.silent === true;

            const btn = buttonEl || null;
            const original = btn ? btn.innerHTML : null;
            if (!silent && btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Updating...';
            }

            try {
                const result = await apiCall(`/test/fee-responses/${id}/regenerate`, 'POST', {
                    instructions,
                    action
                });

                if (result.success) {
                    if (!silent) {
                        log(`‚ôªÔ∏è Fee response ${id} regenerated`, 'info');
                    }
                    await loadFeeResponses();
                    return true;
                } else {
                    log(`‚ùå Failed to regenerate: ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error regenerating fee response: ${error.message}`, 'error');
                return false;
            } finally {
                if (!silent && btn) {
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            }
        }

        // Activity feed
        async function loadActivityLog() {
            try {
                const result = await apiCall('/test/activity?limit=50');
                renderActivityLog(result.activity || []);
            } catch (error) {
                const container = document.getElementById('activity-log-list');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load activity: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        function renderActivityLog(entries) {
            const container = document.getElementById('activity-log-list');
            if (!container) return;

            if (!entries.length) {
                container.innerHTML = '<p style="color:#718096;">No recent activity yet.</p>';
                return;
            }

            const html = entries.map(entry => {
                const caseLabel = entry.case_name ? `${escapeHtml(entry.case_name)} ‚Ä¢ ` : '';
                const description = escapeHtml(entry.description || '');
                const timestamp = new Date(entry.created_at).toLocaleString();
                return `
                    <div class="activity-log-entry">
                        <h4>${caseLabel}${escapeHtml(entry.event_type || 'event')}</h4>
                        <p>${description}</p>
                        <p style="font-size:12px;color:#718096;margin-top:6px;">${timestamp}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Agent decisions table
        async function loadAgentDecisions() {
            try {
                const result = await apiCall('/test/agent/decisions');
                const container = document.getElementById('decisions-table');

                if (!container) return;

                if (!result.decisions || result.decisions.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No agent decisions yet.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Case</th><th>Action</th><th>Reasoning</th><th>Confidence</th><th>Time</th>';
                html += '</tr></thead><tbody>';

                result.decisions.forEach(d => {
                    const confidenceClass = d.confidence >= 0.8 ? 'success' : d.confidence >= 0.5 ? 'warning' : 'danger';
                    html += '<tr>';
                    html += `<td>${d.case_id} ‚Äî ${escapeHtml(d.case_name || 'Unknown')}</td>`;
                    html += `<td>${escapeHtml(d.action_taken || '')}</td>`;
                    html += `<td>${escapeHtml(d.reasoning || '').substring(0, 120)}${d.reasoning?.length > 120 ? '‚Ä¶' : ''}</td>`;
                    html += `<td><span class="badge ${confidenceClass}">${(d.confidence * 100).toFixed(0)}%</span></td>`;
                    html += `<td>${new Date(d.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('decisions-table');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load decisions: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        // Escalations table
        async function loadEscalations() {
            try {
                const result = await apiCall('/test/agent/escalations');
                const container = document.getElementById('escalations-table');
                if (!container) return;

                if (!result.escalations || result.escalations.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No escalations yet.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Case</th><th>Reason</th><th>Urgency</th><th>Suggested Action</th><th>Status</th><th>Created</th>';
                html += '</tr></thead><tbody>';

                result.escalations.forEach(e => {
                    const urgencyClass = e.urgency === 'high' ? 'danger' : e.urgency === 'medium' ? 'warning' : 'info';
                    html += '<tr>';
                    html += `<td>${e.case_id} ‚Äî ${escapeHtml(e.case_name || 'Unknown')}</td>`;
                    html += `<td>${escapeHtml(e.reason || '')}</td>`;
                    html += `<td><span class="badge ${urgencyClass}">${(e.urgency || '').toUpperCase()}</span></td>`;
                    html += `<td>${escapeHtml(e.suggested_action || 'None')}</td>`;
                    html += `<td>${escapeHtml(e.status || '')}</td>`;
                    html += `<td>${new Date(e.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('escalations-table');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load escalations: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        // Portal runs table
        async function loadPortalRuns() {
            try {
                const result = await apiCall('/test/portal-runs');
                const container = document.getElementById('portal-runs-table');
                if (!container) return;

                if (!result.runs || result.runs.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No portal runs yet.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Time</th><th>Event</th><th>Engine</th><th>Case</th><th>Portal</th><th>Details</th>';
                html += '</tr></thead><tbody>';

                result.runs.forEach(run => {
                    const meta = run.metadata || {};
                    const eventLabel = formatPortalEventLabel(run);
                    let statusClass = 'info';
                    if (/failed/i.test(run.event_type)) {
                        statusClass = 'danger';
                    } else if (/completed/i.test(run.event_type) || /portal_submission$/i.test(run.event_type)) {
                        statusClass = 'success';
                    }

                    const caseId = meta.case_id || meta.caseId || null;
                    const caseLabel = caseId ? `Case ${caseId}` : '‚Äî';
                    const portalRaw = meta.portal_url || meta.portalUrl || '';
                    const portalHref = portalRaw ? normalizePortalUrl(portalRaw) : null;
                    const portalCell = portalHref
                        ? `<a href="${escapeHtml(portalHref)}" target="_blank" rel="noopener">${escapeHtml(portalRaw)}</a>`
                        : '‚Äî';

                    const detailParts = [];
                    const stageLabel = meta.stage
                        ? meta.stage.replace(/_/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase())
                        : null;
                    if (stageLabel) {
                        detailParts.push(`Stage: ${stageLabel}`);
                    }
                    if (meta.submission_status) {
                        detailParts.push(`Status: ${meta.submission_status}`);
                    }
                    if (meta.confirmation_number) {
                        detailParts.push(`Confirmation #: ${meta.confirmation_number}`);
                    }
                    if (meta.verification_required) {
                        detailParts.push(`Verification required: ${meta.verification_reason || 'Awaiting code'}`);
                    }
                    if (run.description) {
                        detailParts.push(truncateText(run.description, 160));
                    }
                    if (meta.error) {
                        detailParts.push(`Error: ${truncateText(meta.error, 160)}`);
                    }

                    const detailHtml = detailParts.length
                        ? detailParts.map(line => `<div class="portal-timeline-description">${escapeHtml(line)}</div>`).join('')
                        : '';

                    const linkParts = [];
                    if (meta.task_url) {
                        linkParts.push(`<a href="${escapeHtml(meta.task_url)}" target="_blank" rel="noopener">Skyvern Task</a>`);
                    }
                    if (meta.recording_url) {
                        linkParts.push(`<a href="${escapeHtml(meta.recording_url)}" target="_blank" rel="noopener">Skyvern Replay</a>`);
                    }
                    if (meta.portal_ticket_url) {
                        linkParts.push(`<a href="${escapeHtml(meta.portal_ticket_url)}" target="_blank" rel="noopener">Portal Ticket</a>`);
                    }
                    if (meta.submission_page_url) {
                        linkParts.push(`<a href="${escapeHtml(meta.submission_page_url)}" target="_blank" rel="noopener">Submission Page</a>`);
                    }
                    const linksHtml = linkParts.length ? `<div class="case-meta">${linkParts.join(' ‚Ä¢ ')}</div>` : '';

                    const details = detailHtml || linksHtml
                        ? `${detailHtml}${linksHtml}`
                        : '‚Äî';

                    const engineLabel = meta.engine || meta.portal_engine || '‚Äî';

                    html += '<tr>';
                    html += `<td>${new Date(run.created_at).toLocaleString()}</td>`;
                    html += `<td><span class="badge ${statusClass}">${escapeHtml(eventLabel)}</span></td>`;
                    html += `<td>${escapeHtml(engineLabel)}</td>`;
                    html += `<td>${escapeHtml(caseLabel)}</td>`;
                    html += `<td style="word-break: break-all;">${portalCell}</td>`;
                    html += `<td>${details}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('portal-runs-table');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load portal runs: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        // Run Migration
        async function runMigration() {
            if (!confirm('Run database migration? This will create agent_decisions and escalations tables.')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running...';

            log('‚öôÔ∏è Running database migration...');

            try {
                const result = await apiCall('/test/run-migration', 'POST');

                if (result.success) {
                    log('‚úÖ Migration completed successfully!', 'success');
                    result.tables?.forEach(t => log(`  ‚úì Created table: ${t}`, 'success'));
                    result.views?.forEach(v => log(`  ‚úì Created view: ${v}`, 'success'));
                } else {
                    log(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">‚öôÔ∏è</span> Run Migration';
            }
        }

        // Retrigger Analysis
        async function retriggerAnalysis(caseId) {
            if (!confirm(`Re-trigger analysis and auto-reply for case #${caseId}?`)) {
                return;
            }

            log(`üîÑ Re-triggering analysis for case #${caseId}...`);

            try {
                const result = await apiCall('/test/retrigger-analysis', 'POST', {
                    case_id: caseId
                });

                if (result.success) {
                    log(`‚úÖ Case #${caseId} re-queued for analysis!`, 'success');
                    log(`   From: ${result.from_email}`, 'info');
                    log(`   Subject: ${result.subject}`, 'info');
                    log(`   ${result.note}`, 'info');
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Run Migration 007
        async function runMigration007() {
            if (!confirm('Run migration 007? This will add UNIQUE constraint to auto_reply_queue.message_id to fix the auto-reply error.')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running...';

            log('üîß Running migration 007...');

            try {
                const result = await apiCall('/test/run-migration-007', 'POST');

                if (result.success) {
                    log('‚úÖ Migration 007 completed!', 'success');
                    log(`   ${result.message}`, 'success');
                    if (result.note) {
                        log(`   ${result.note}`, 'info');
                    }
                } else {
                    log(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üîß</span> Fix Auto-Reply Queue';
            }
        }

        // Clear Database
        async function clearDatabase() {
            if (!confirm('‚ö†Ô∏è This will DELETE ALL cases, messages, and agent data. Are you sure?')) {
                return;
            }

            if (!confirm('Really sure? This cannot be undone!')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Clearing...';

            log('üóëÔ∏è Clearing database...');

            try {
                const result = await apiCall('/test/clear-all-cases', 'POST', {
                    confirm: 'DELETE_ALL_CASES'
                });

                if (result.success) {
                    log('‚úÖ Database cleared!', 'success');
                    log(`üìä Deleted ${result.deleted.cases} cases, ${result.deleted.messages} messages`, 'info');

                    await refreshStats();
                    await loadCaseMonitor({ manual: true });
                    await loadHumanReviews();
                    await loadActivityLog();
                    await loadAgentDecisions();
                    await loadEscalations();
                    await loadPortalRuns();
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üóëÔ∏è</span> Clear All Cases';
            }
        }

        // Auto-refresh stats + data
        setInterval(refreshStats, 30000);
        setInterval(loadFeeResponses, 45000);
        setInterval(loadHumanReviews, 45000);
        setInterval(loadActivityLog, 60000);
        setInterval(loadAgentDecisions, 60000);
        setInterval(loadEscalations, 60000);
        setInterval(loadPortalRuns, 60000);
    </script>
</body>
</html>
