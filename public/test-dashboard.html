<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOIA Agent Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1a202c;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 16px;
        }

        .status-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border-radius: 8px;
            background: #f7fafc;
        }

        .status-item.active {
            background: #c6f6d5;
        }

        .status-item.inactive {
            background: #fed7d7;
        }

        .status-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a202c;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #1a202c;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .output-box {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
        }

        .output-box:empty::before {
            content: 'No output yet...';
            color: #718096;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #667eea;
            background: #2d3748;
            border-radius: 4px;
        }

        .log-entry.success {
            border-left-color: #48bb78;
        }

        .log-entry.error {
            border-left-color: #f56565;
        }

        .log-entry.warning {
            border-left-color: #ed8936;
        }

        .timestamp {
            color: #a0aec0;
            font-size: 10px;
            margin-right: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge.danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .activity-log-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 360px;
            overflow-y: auto;
        }

        .activity-log-entry {
            padding: 10px 12px;
            border-radius: 8px;
            background: #f7fafc;
            border-left: 4px solid #667eea;
        }

        .activity-log-entry h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #1a202c;
        }

        .activity-log-entry p {
            margin: 0;
            font-size: 13px;
            color: #2d3748;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #2d3748;
        }

        .table tr:hover {
            background: #f7fafc;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .emoji {
            font-size: 16px;
        }

        .case-monitor-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .case-search-input {
            flex: 1;
            min-width: 220px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .case-search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .case-monitor-meta {
            font-size: 12px;
            color: #718096;
            margin-left: auto;
        }

        .case-title {
            font-weight: 600;
            color: #1a202c;
        }

        .case-meta {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .case-preview {
            margin-top: 6px;
            color: #2d3748;
            font-size: 13px;
        }

        .fee-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .fee-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fee-card h4 {
            margin: 0;
            font-size: 16px;
            color: #1a202c;
        }

        .fee-metadata {
            font-size: 12px;
            color: #4a5568;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .fee-response-preview {
            background: #f7fafc;
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
            color: #2d3748;
            white-space: pre-wrap;
        }

        .fee-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .fee-actions textarea {
            flex: 1;
            min-height: 80px;
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            padding: 10px;
            font-size: 13px;
            resize: vertical;
        }

        .fee-actions select {
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            padding: 8px;
            font-size: 13px;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            background: #edf2f7;
            color: #2d3748;
        }

        .status-pill.ready_to_send { background: #bee3f8; color: #2b6cb0; }
        .status-pill.awaiting_response { background: #faf089; color: #b7791f; }
        .status-pill.closed { background: #c6f6d5; color: #276749; }
        .status-pill.follow_up_scheduled { background: #e9d8fd; color: #553c9a; }

        .message-direction {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-direction.inbound {
            background: #c6f6d5;
            color: #22543d;
        }

        .message-direction.outbound {
            background: #bee3f8;
            color: #2c5282;
        }

        .message-direction.neutral {
            background: #edf2f7;
            color: #4a5568;
        }

        .table-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #667eea;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }

        .table-btn:hover {
            opacity: 0.9;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: min(900px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #4a5568;
        }

        .thread-message {
            border-left: 4px solid #667eea;
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .thread-message.inbound {
            border-left-color: #48bb78;
        }

        .thread-message.outbound {
            border-left-color: #4299e1;
        }

        .thread-message-meta {
            font-size: 12px;
            color: #4a5568;
            margin-bottom: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .thread-message-body {
            font-size: 14px;
            color: #1a202c;
            white-space: pre-wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-field label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #4a5568;
        }

        .form-field input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .inline-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #4a5568;
        }

        .inline-checkbox input {
            width: auto;
        }

        .dry-run-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ FOIA Agent Test Dashboard</h1>
            <p class="subtitle">Test the autonomous agent with real scenarios - no commands needed!</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item" id="agent-status">
                <div class="status-label">Agent Status</div>
                <div class="status-value">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Cases Created</div>
                <div class="status-value" id="cases-count">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Agent Decisions</div>
                <div class="status-value" id="decisions-count">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Escalations</div>
                <div class="status-value" id="escalations-count">0</div>
            </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid">
            <!-- Test Scenarios -->
            <div class="card">
                <h2>üìß Send Test Emails</h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="sendTestEmail()">
                        <span class="emoji">üì§</span> Send Test Email
                    </button>
                    <p style="color: #718096; font-size: 12px; margin-top: 10px;">
                        Creates a new test case and sends email to overlord1pvp@gmail.com
                    </p>
                </div>
            </div>

            <!-- Dry Run Portal -->
            <div class="card">
                <h2>üß™ Dry Run Portal</h2>
                <div class="form-field">
                    <label for="dry-run-portal-input">Portal URL</label>
                    <input id="dry-run-portal-input" type="url" class="dry-run-input" placeholder="https://example.govqa.us/..." />
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="runDryRunPortal(event)">
                        <span class="emoji">üß™</span> Run Dry Portal Test
                    </button>
                    <p style="color:#718096; font-size:12px; margin-top:10px;">
                        Fills the portal form using test data, stops before final submission, and gives you a link to review the Skyvern replay.
                    </p>
                </div>
                <div id="dry-run-portal-result" class="case-meta" style="margin-top:10px;"></div>
            </div>

            <!-- Force Notion Sync -->
            <div class="card">
                <h2>üîÑ Force Notion Sync</h2>
                <div class="button-group">
                    <button class="btn-success" onclick="forceNotionSync(event)">
                        <span class="emoji">üîÑ</span> Sync & Send All Cases
                    </button>
                    <p style="color:#718096; font-size:12px; margin-top:10px;">
                        Syncs all "Ready to Send" cases from Notion and immediately queues them for sending. Cases missing contact info will be flagged for review.
                    </p>
                </div>
                <div id="force-sync-result" style="margin-top:10px;"></div>
            </div>

            <!-- Notion Launch -->
            <div class="card full-width">
                <h2>üóÇÔ∏è Launch Outreach From Notion</h2>
                <div class="form-grid">
                    <div class="form-field" style="grid-column: span 2;">
                        <label for="notion-link-input">Notion Page Link or ID</label>
                        <input id="notion-link-input" type="text" placeholder="https://www.notion.so/... or 6f5c2d90c0b24b3e9f6a..." />
                    </div>
                    <div class="form-field">
                        <label for="notion-email-input">Override Agency Email (optional)</label>
                        <input id="notion-email-input" type="email" placeholder="agency@example.gov" />
                    </div>
                    <div class="form-field">
                        <label>Send Mode</label>
                        <div class="inline-checkbox">
                            <input id="notion-instant-checkbox" type="checkbox" checked />
                            <span>Instant mode (no delay)</span>
                        </div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="processNotionCase(event)">
                        <span class="emoji">üöÄ</span> Launch Outreach
                    </button>
                    <p style="color: #718096; font-size: 12px;">
                        Paste any Notion request card link/ID to queue drafting + sending automatically. Finished case will appear in the Live Case Monitor below.
                    </p>
                </div>
            </div>

            <div class="card full-width">
                <h2>üí∞ Pending Fee Responses</h2>
                <p class="muted">
                    Every time an agency sends a fee estimate the AI drafts a reply, but nothing is sent until you approve it here.
                    Add guidance, regenerate, or approve to send instantly.
                </p>
                <div id="fee-response-container">
                    <p style="color:#718096;">No fee responses queued yet.</p>
                </div>
            </div>

            <div class="card full-width">
                <h2>üßë‚Äç‚öñÔ∏è Human Review Queue</h2>
                <div id="human-review-container">
                    <p style="color:#718096;">No cases need human review.</p>
                </div>
            </div>

            <!-- Live Case Monitor -->
            <div class="card full-width">
                <h2>üì° Live Case Monitor</h2>
                <div class="case-monitor-controls">
                    <input id="case-search" type="text" class="case-search-input" placeholder="Search by case name, agency, or email..." />
                    <select id="status-filter" class="case-search-input" style="max-width: 220px;">
                        <option value="all">All statuses</option>
                        <option value="ready_to_send">Ready to Send</option>
                        <option value="awaiting_response">Awaiting Response</option>
                        <option value="follow_up_scheduled">Follow-up Scheduled</option>
                        <option value="closed">Closed</option>
                    </select>
                    <button class="btn-info" onclick="loadCaseMonitor({ manual: true, announce: true })">
                        <span class="emoji">üîç</span> Search
                    </button>
                    <div class="case-monitor-meta" id="case-monitor-meta">Live view auto-refreshes every 30s</div>
                </div>
                <div id="case-monitor-table" class="table-scroll">
                    <p style="color: #718096;">Loading case overview...</p>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card full-width">
                <h2>üìù Activity Log</h2>
                <div id="activity-log-list" class="activity-log-list">
                    <p style="color:#718096;">Loading recent activity...</p>
                </div>
            </div>

            <!-- Console Output -->
            <div class="card full-width">
                <h2>üõ† Console</h2>
                <div id="console-output" class="output-box"></div>
            </div>

            <!-- Agent Decisions Table -->
            <div class="card full-width">
                <h2>ü§ñ Recent Agent Decisions</h2>
                <div id="decisions-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "View Agent Decisions" to load...</p>
                </div>
            </div>

            <!-- Escalations Table -->
            <div class="card full-width">
                <h2>üö® Pending Escalations</h2>
                <div id="escalations-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "View Escalations" to load...</p>
                </div>
            </div>

            <!-- Portal Runs Table -->
            <div class="card full-width">
                <h2>üåê Portal Automation Runs</h2>
                <div id="portal-runs-table" style="overflow-x: auto;">
                    <p style="color: #718096;">Click "Portal Runs" to load...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Thread Modal -->
    <div id="thread-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close" onclick="closeThreadModal()" aria-label="Close">&times;</button>
            <h3 id="thread-modal-title" style="margin-bottom: 6px;">Case Thread</h3>
            <p id="thread-modal-summary" class="case-meta" style="margin-bottom: 20px;"></p>
            <div id="thread-modal-body"></div>
        </div>
    </div>

    <script>
        let caseMonitorTimer = null;
        let latestCaseMonitorCount = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Dashboard loaded', 'success');
            refreshStats();
            loadActivityLog();
            loadAgentDecisions();
            loadEscalations();
            loadPortalRuns();
            loadFeeResponses();
            loadHumanReviews();
            setupCaseMonitorControls();
            setupNotionFormControls();
            loadCaseMonitor();
            scheduleCaseMonitorRefresh();

            const modal = document.getElementById('thread-modal');
            if (modal) {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeThreadModal();
                    }
                });
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeThreadModal();
            }
        });

        // Logging / Console
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            if (!output) {
                console[type === 'error' ? 'error' : 'log'](message);
                return;
            }

            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            const output = document.getElementById('console-output');
            if (output) {
                output.innerHTML = '';
            }
        }

        function setupCaseMonitorControls() {
            const searchInput = document.getElementById('case-search');
            const statusFilter = document.getElementById('status-filter');

            if (searchInput) {
                searchInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        loadCaseMonitor({ manual: true, announce: true });
                    }
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', () => loadCaseMonitor({ manual: true }));
            }
        }

        function setupNotionFormControls() {
            const notionInput = document.getElementById('notion-link-input');
            const emailInput = document.getElementById('notion-email-input');

            [notionInput, emailInput].forEach((input) => {
                if (!input) return;
                input.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        processNotionCase(event);
                    }
                });
            });
        }

        function scheduleCaseMonitorRefresh() {
            if (caseMonitorTimer) {
                clearInterval(caseMonitorTimer);
            }
            caseMonitorTimer = setInterval(() => loadCaseMonitor(), 30000);
        }

        function formatRelativeTime(value) {
            if (!value) return '‚Äî';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '‚Äî';

            const diffMs = Date.now() - date.getTime();
            const minutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMs / 3600000);
            const days = Math.floor(diffMs / 86400000);

            if (diffMs < 45000) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function formatDateTime(value) {
            if (!value) return '‚Äî';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '‚Äî';
            return date.toLocaleString();
        }

        function extractNotionPageId(input) {
            if (!input) return null;
            const trimmed = input.trim();
            if (!trimmed) return null;

            const hyphenated = trimmed.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i);
            if (hyphenated) {
                return hyphenated[0].replace(/-/g, '').toLowerCase();
            }

            const plain = trimmed.match(/[0-9a-f]{32}/i);
            if (plain) {
                return plain[0].toLowerCase();
            }

            const queryIndex = trimmed.indexOf('?');
            if (queryIndex !== -1) {
                try {
                    const search = new URLSearchParams(trimmed.substring(queryIndex + 1));
                    const paramId = search.get('p') || search.get('pageId');
                    if (paramId) {
                        const cleaned = paramId.replace(/-/g, '');
                        if (/^[0-9a-f]{32}$/i.test(cleaned)) {
                            return cleaned.toLowerCase();
                        }
                    }
                } catch {
                    // ignore malformed query params
                }
            }

            return null;
        }

        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function stripHtml(html = '') {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function normalizePortalUrl(url) {
            if (!url) return null;
            if (/^https?:\/\//i.test(url)) {
                return url;
            }
            return `https://${url}`;
        }

        function renderPortalStatusCell(c) {
            const status = c.last_portal_status ? escapeHtml(c.last_portal_status) : '‚Äî';
            const metaParts = [];
            if (c.last_portal_status_at) {
                metaParts.push(formatRelativeTime(c.last_portal_status_at));
            }
            if (c.last_portal_engine) {
                metaParts.push(`via ${escapeHtml(c.last_portal_engine)}`);
            }
            const metaHtml = metaParts.length ? `<div class="case-meta">${metaParts.join(' ‚Ä¢ ')}</div>` : '';
            const portalUrl = normalizePortalUrl(c.portal_url);
            const provider = c.portal_provider ? `<div class="case-meta">Provider: ${escapeHtml(c.portal_provider)}</div>` : '';
            const links = [];
            if (portalUrl) {
                links.push(`<a href="${portalUrl}" target="_blank" rel="noopener">Portal</a>`);
            }
            if (c.last_portal_task_url) {
                links.push(`<a href="${c.last_portal_task_url}" target="_blank" rel="noopener">Skyvern Task</a>`);
            } else if (c.last_portal_recording_url) {
                links.push(`<a href="${c.last_portal_recording_url}" target="_blank" rel="noopener">Skyvern Replay</a>`);
            }
            const linksHtml = links.length ? `<div class="case-meta">${links.join(' ‚Ä¢ ')}</div>` : '';
            const accountHtml = c.last_portal_account_email
                ? `<div class="case-meta">Login Email: ${escapeHtml(c.last_portal_account_email)} (password stored securely)</div>`
                : '';
            return `<div class="case-title">${status}</div>${metaHtml}${provider}${linksHtml}${accountHtml}`;
        }

        function renderStatusPill(status, substatus) {
            if (!status) return '<span class="status-pill">Unknown</span>';
            const className = `status-pill ${status}`;
            const label = escapeHtml(status.replace(/_/g, ' '));
            const sub = substatus ? `<div class="case-meta">${escapeHtml(substatus)}</div>` : '';
            return `<div><span class="${className}">${label}</span>${sub}</div>`;
        }

        function renderDirectionBadge(direction) {
            if (!direction) {
                return '<span class="message-direction neutral">No messages</span>';
            }
            const dir = direction === 'inbound' ? 'inbound' : direction === 'outbound' ? 'outbound' : 'neutral';
            const label = direction.charAt(0).toUpperCase() + direction.slice(1);
            return `<span class="message-direction ${dir}">${label}</span>`;
        }

        async function processNotionCase(clickEvent) {
            const notionInput = document.getElementById('notion-link-input');
            const emailInput = document.getElementById('notion-email-input');
            const instantCheckbox = document.getElementById('notion-instant-checkbox');

            if (!notionInput || !notionInput.value.trim()) {
                log('‚ùå Please paste a Notion link or ID first.', 'error');
                return;
            }

            const pageId = extractNotionPageId(notionInput.value);
            if (!pageId) {
                log('‚ùå Could not parse a Notion page ID from that input.', 'error');
                return;
            }

            const payload = {
                notion_page_id: pageId,
                instant_mode: instantCheckbox ? instantCheckbox.checked : true
            };

            if (emailInput && emailInput.value.trim()) {
                payload.test_email = emailInput.value.trim();
            }

            const btn = clickEvent?.target?.closest('button');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Launching...';
            }

            log(`üöÄ Launching outreach for Notion page ${pageId}...`);

            try {
                const result = await apiCall('/test/process-notion', 'POST', payload);
                if (result.success) {
                    log(`‚úÖ Case ${result.case_id} queued (instant mode: ${result.instant_mode})`, 'success');
                    await refreshStats();
                    await loadCaseMonitor({ manual: true });
                } else {
                    log(`‚ùå Failed to queue case: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error launching outreach: ${error.message}`, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="emoji">üöÄ</span> Launch Outreach';
                }
            }
        }

        async function loadCaseMonitor(options = {}) {
            const container = document.getElementById('case-monitor-table');
            const meta = document.getElementById('case-monitor-meta');
            if (!container) return;

            const searchInput = document.getElementById('case-search');
            const statusFilter = document.getElementById('status-filter');
            const params = new URLSearchParams();

            if (searchInput && searchInput.value.trim().length > 0) {
                params.set('search', searchInput.value.trim());
            }
            if (statusFilter && statusFilter.value !== 'all') {
                params.set('status', statusFilter.value);
            }
            params.set('limit', '100');

            const queryString = params.toString();
            const endpoint = `/test/cases${queryString ? `?${queryString}` : ''}`;

            if (options.manual || options.announce) {
                log('üì° Refreshing live case monitor...');
            }

            try {
                const result = await apiCall(endpoint);
                const cases = result.cases || [];
                latestCaseMonitorCount = cases.length;
                renderCaseMonitor(cases);

                if (meta) {
                    meta.textContent = `Updated ${new Date().toLocaleTimeString()} ‚Ä¢ Showing ${cases.length} case${cases.length === 1 ? '' : 's'}`;
                }

                if (options.manual || options.announce) {
                    log(`‚úÖ Loaded ${cases.length} cases`, 'success');
                }
            } catch (error) {
                container.innerHTML = `<p style="color: #e53e3e;">Failed to load cases: ${escapeHtml(error.message)}</p>`;
                if (options.manual || options.announce) {
                    log(`‚ùå Failed to load case monitor: ${error.message}`, 'error');
                }
            }
        }

        function renderCaseMonitor(cases = []) {
            const container = document.getElementById('case-monitor-table');
            if (!container) return;

            if (!cases.length) {
                container.innerHTML = '<p style="color: #718096;">No cases match the current filters.</p>';
                return;
            }

            let html = '<table class="table"><thead><tr>';
            html += '<th>Case</th><th>Agency</th><th>Status</th><th>Portal</th><th>Last Response</th><th>Messages</th><th>Next Step</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            cases.forEach((c) => {
                const name = escapeHtml(c.case_name || 'Untitled case');
                const agency = escapeHtml(c.agency_name || 'Unknown agency');
                const statusHtml = renderStatusPill(c.status, c.substatus);
                const directionBadge = renderDirectionBadge(c.last_message_direction);
                const preview = escapeHtml(c.last_message_preview || 'No correspondence yet.');
                const lastActivity = c.last_message_at
                    ? formatRelativeTime(c.last_message_at)
                    : formatRelativeTime(c.updated_at);
                const totalMessages = c.total_messages || 0;
                const inboundMeta = c.last_inbound_at ? formatRelativeTime(c.last_inbound_at) : '‚Äî';
                const outboundMeta = c.last_outbound_at ? formatRelativeTime(c.last_outbound_at) : '‚Äî';
                const followupText = c.next_followup_date
                    ? `${formatDateTime(c.next_followup_date)} (${formatRelativeTime(c.next_followup_date)})`
                    : '‚Äî';
                const followupStatus = c.followup_status ? `<div class="case-meta">Status: ${escapeHtml(c.followup_status)}</div>` : '';

                html += '<tr>';
                html += `<td><div class="case-title">${name}</div><div class="case-meta">#${c.id} ‚Ä¢ Created ${formatRelativeTime(c.created_at)}</div></td>`;
                html += `<td><div class="case-title">${agency}</div><div class="case-meta">${escapeHtml(c.agency_email || '‚Äî')}</div></td>`;
                const portalCell = renderPortalStatusCell(c);

                html += `<td>${statusHtml}</td>`;
                html += `<td>${portalCell}</td>`;
                html += `<td>${directionBadge}<div class="case-meta">${lastActivity}</div><div class="case-preview">${preview}</div></td>`;
                html += `<td><div class="case-title">${totalMessages} message${totalMessages === 1 ? '' : 's'}</div><div class="case-meta">Inbound: ${inboundMeta} ‚Ä¢ Outbound: ${outboundMeta}</div></td>`;
                html += `<td><div class="case-title">${followupText}</div>${followupStatus}</td>`;
                html += `<td>
                    <button class="table-btn" onclick="openThreadModal(${c.id})">View Thread</button>
                    <button class="table-btn" onclick="retriggerAnalysis(${c.id})" style="background: #ed8936; margin-top: 5px;">Retrigger</button>
                </td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function openThreadModal(caseId) {
            const modal = document.getElementById('thread-modal');
            const title = document.getElementById('thread-modal-title');
            const summary = document.getElementById('thread-modal-summary');
            const body = document.getElementById('thread-modal-body');

            if (!modal || !body) return;

            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            body.innerHTML = '<p style="color: #718096;">Loading correspondence...</p>';

            try {
                const result = await apiCall(`/test/cases/${caseId}/messages`);
                const caseData = result.case || {};
                title.textContent = `${caseData.case_name || 'Case'} (#${caseData.id || caseId})`;
                summary.textContent = [
                    caseData.agency_name || 'Unknown agency',
                    caseData.agency_email || 'No email',
                    caseData.status ? `Status: ${caseData.status.replace(/_/g, ' ')}` : ''
                ].filter(Boolean).join(' ‚Ä¢ ');

                renderThreadMessages(result.messages || []);
            } catch (error) {
                body.innerHTML = `<p style="color: #e53e3e;">${escapeHtml(error.message)}</p>`;
            }
        }

        function closeThreadModal() {
            const modal = document.getElementById('thread-modal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function renderThreadMessages(messages = []) {
            const body = document.getElementById('thread-modal-body');
            if (!body) return;

            if (!messages.length) {
                body.innerHTML = '<p style="color: #718096;">No correspondence yet for this case.</p>';
                return;
            }

            const html = messages.map((msg) => {
                const direction = msg.direction || 'neutral';
                const subject = escapeHtml(msg.subject || '(No subject)');
                const timestamp = formatDateTime(msg.message_timestamp);
                const fallbackText = msg.body_text && msg.body_text.trim().length > 0
                    ? msg.body_text
                    : stripHtml(msg.body_html || '');
                const content = escapeHtml(fallbackText || '').replace(/\n/g, '<br>');

                return `
                    <div class="thread-message ${direction}">
                        <div class="thread-message-meta">
                            <span class="message-direction ${direction}">${direction.toUpperCase()}</span>
                            <span>${timestamp}</span>
                            <span>${subject}</span>
                        </div>
                        <div class="thread-message-body">${content || '<em>No content</em>'}</div>
                    </div>
                `;
            }).join('');

            body.innerHTML = html;
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(`/api${endpoint}`, options);
                const data = await response.json();
                return data;
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Refresh Stats
        async function refreshStats() {
            log('üîÑ Refreshing statistics...');

            try {
                // Agent is always enabled (hardcoded)
                const statusDiv = document.getElementById('agent-status');
                statusDiv.className = 'status-item active';
                statusDiv.querySelector('.status-value').textContent = 'ENABLED ‚úÖ';

                // Get stats
                const stats = await apiCall('/test/stats');
                document.getElementById('cases-count').textContent = stats.total_cases || 0;
                document.getElementById('decisions-count').textContent = stats.agent_decisions || 0;
                document.getElementById('escalations-count').textContent = stats.escalations || 0;

                log('‚úÖ Stats refreshed', 'success');
            } catch (error) {
                log(`‚ùå Failed to refresh stats: ${error.message}`, 'error');
            }
        }

        // Send Test Email
        async function sendTestEmail() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Sending...';

            log('üì§ Sending test email...');

            try {
                const result = await apiCall('/test/send-and-reply', 'POST');

                if (result.success) {
                    log(`‚úÖ Test email sent! Case ID: ${result.case_id}`, 'success');
                    log(`üìß Email sent to: ${result.sent_to}`, 'info');
                    log(`üìã Message ID: ${result.message_id}`, 'info');

                    await refreshStats();
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üì§</span> Send Test Email';
            }
        }

        async function runDryRunPortal(event) {
            const input = document.getElementById('dry-run-portal-input');
            const resultBox = document.getElementById('dry-run-portal-result');
            const btn = event.target.closest('button');

            if (!input || !input.value.trim()) {
                log('‚ö†Ô∏è Please enter a portal URL to dry run.', 'warning');
                return;
            }

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Running...';
            resultBox.textContent = 'Dry run in progress...';

            try {
                const portalUrl = input.value.trim();
                const payload = {
                    portal_url: portalUrl,
                    dry_run: true
                };
                const result = await apiCall('/test/portal-agent', 'POST', payload);

                if (result.success === false && !result.taskId) {
                    resultBox.innerHTML = `<span style="color:#e53e3e;">Failed to run: ${escapeHtml(result.error || 'Unknown error')}</span>`;
                    log(`‚ùå Dry run failed: ${result.error || 'Unknown error'}`, 'error');
                    return;
                }

                const lines = [];
                lines.push(`Status: ${escapeHtml(result.status || (result.success ? 'completed' : 'stopped'))}`);
                if (result.portalUrl) {
                    lines.push(`Portal: <a href="${result.portalUrl}" target="_blank" rel="noopener">${escapeHtml(result.portalUrl)}</a>`);
                }
                if (result.taskId) {
                    const taskLink = `https://app.skyvern.com/tasks/${result.taskId}`;
                    lines.push(`Skyvern Task: <a href="${taskLink}" target="_blank" rel="noopener">${taskLink}</a>`);
                }
                if (result.recording_url) {
                    lines.push(`Replay: <a href="${result.recording_url}" target="_blank" rel="noopener">${result.recording_url}</a>`);
                }
                lines.push(`Steps Completed: ${result.steps || 0}`);
                lines.push(`Dry Run: ${result.dryRun === false ? 'No' : 'Yes'}`);

                resultBox.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
                log('‚úÖ Portal dry run finished. Check the links for the full walkthrough.', 'success');
            } catch (error) {
                resultBox.innerHTML = `<span style="color:#e53e3e;">${escapeHtml(error.message)}</span>`;
                log(`‚ùå Dry run error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Force Notion Sync
        async function forceNotionSync(event) {
            const btn = event.target.closest('button');
            const resultBox = document.getElementById('force-sync-result');

            if (!confirm('Sync all "Ready to Send" cases from Notion and queue them for sending?')) {
                return;
            }

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Syncing...';
            resultBox.innerHTML = '<p style="color:#718096;">Syncing from Notion...</p>';

            try {
                log('üîÑ Force syncing cases from Notion...', 'info');
                const result = await apiCall('/test/force-notion-sync', 'POST', {});

                if (result.success) {
                    const lines = [];
                    lines.push(`<strong>‚úÖ Synced ${result.synced_count} cases from Notion</strong>`);
                    lines.push(`üì§ Queued for sending: ${result.queued_count}`);
                    lines.push(`‚ö†Ô∏è Flagged for review: ${result.review_count}`);

                    if (result.results && result.results.length > 0) {
                        lines.push('<br><strong>Details:</strong>');
                        result.results.forEach(r => {
                            const icon = r.status === 'queued' ? '‚úÖ' : '‚ö†Ô∏è';
                            lines.push(`${icon} Case ${r.id}: ${escapeHtml(r.case_name || 'Untitled')} - ${escapeHtml(r.message)}`);
                        });
                    }

                    resultBox.innerHTML = lines.map(line => `<div style="margin-bottom:4px;">${line}</div>`).join('');
                    log(`‚úÖ Synced ${result.synced_count} cases - ${result.queued_count} queued, ${result.review_count} flagged`, 'success');

                    // Refresh the case monitor
                    await loadCaseMonitor({ manual: true });
                    await refreshStats();
                } else {
                    resultBox.innerHTML = `<span style="color:#e53e3e;">Failed: ${escapeHtml(result.error || 'Unknown error')}</span>`;
                    log(`‚ùå Force sync failed: ${result.error}`, 'error');
                }
            } catch (error) {
                resultBox.innerHTML = `<span style="color:#e53e3e;">${escapeHtml(error.message)}</span>`;
                log(`‚ùå Force sync error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Fee response workflow
        async function loadFeeResponses() {
            try {
                const result = await apiCall('/test/fee-responses');
                renderFeeResponses(result.items || []);
            } catch (error) {
                log(`‚ùå Failed to load fee responses: ${error.message}`, 'error');
            }
        }

        async function loadHumanReviews() {
            try {
                const result = await apiCall('/test/human-reviews');
                renderHumanReviews(result.cases || []);
            } catch (error) {
                const container = document.getElementById('human-review-container');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load human reviews: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        function renderHumanReviews(items) {
            const container = document.getElementById('human-review-container');
            if (!container) return;

            if (!items.length) {
                container.innerHTML = '<p style="color:#718096;">No cases are waiting for human review.</p>';
                return;
            }

            const html = items.map(item => {
                const caseMeta = `
                    <div class="case-meta">
                        <strong>Status:</strong> ${escapeHtml(item.status)} ‚Ä¢
                        <strong>Substatus:</strong> ${escapeHtml(item.substatus || '‚Äî')}
                    </div>
                    <div class="case-meta">
                        <strong>Agency:</strong> ${escapeHtml(item.agency_name || 'Unknown')} ‚Äî ${escapeHtml(item.agency_email || 'No email')}
                    </div>
                `;

                const lastActivity = item.last_activity_description
                    ? `<div class="case-meta"><strong>Last Activity:</strong> ${escapeHtml(item.last_activity_description)}</div>`
                    : '';

                const lastMessage = item.last_message_body
                    ? `<details><summary style="cursor:pointer;font-size:12px;color:#4a5568;">Latest message</summary><div style="margin-top:6px;font-size:12px;color:#2d3748;">${escapeHtml(item.last_message_body.substring(0, 400))}${item.last_message_body.length > 400 ? '‚Ä¶' : ''}</div></details>`
                    : '';

                return `
                    <div class="fee-card" id="human-review-${item.id}">
                        <h4>Case ${item.id}: ${escapeHtml(item.case_name || 'Untitled')}</h4>
                        ${caseMeta}
                        ${lastActivity}
                        ${lastMessage}
                        <div class="fee-actions">
                            <textarea data-review-note="${item.id}" placeholder="Add context or instructions..."></textarea>
                            <div style="display:flex;flex-direction:column;gap:8px;min-width:200px;">
                                <label style="font-size:12px;text-transform:uppercase;color:#4a5568;">Decision</label>
                                <select data-review-action="${item.id}">
                                    <option value="approve">Approve</option>
                                    <option value="reject">Reject</option>
                                    <option value="change">Change</option>
                                </select>
                                <input data-review-next-status="${item.id}" placeholder="Next status (optional)" style="padding:8px;border-radius:8px;border:1px solid #cbd5f5;" />
                                <button class="btn-secondary" onclick="openThreadModal(${item.id})">
                                    <span class="emoji">üì®</span> View Thread
                                </button>
                                <button class="btn-success" onclick="submitHumanReviewDecision(${item.id}, this)">
                                    <span class="emoji">‚úÖ</span> Submit Decision
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="fee-card-grid">${html}</div>`;
        }

        async function submitHumanReviewDecision(caseId, buttonEl) {
            const noteEl = document.querySelector(`[data-review-note="${caseId}"]`);
            const actionEl = document.querySelector(`[data-review-action="${caseId}"]`);
            const nextStatusEl = document.querySelector(`[data-review-next-status="${caseId}"]`);

            const payload = {
                action: actionEl ? actionEl.value : 'approve',
                note: noteEl ? noteEl.value.trim() : '',
                next_status: nextStatusEl && nextStatusEl.value.trim() ? nextStatusEl.value.trim() : undefined
            };

            const btn = buttonEl || event.target.closest('button');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Saving...';
            }

            try {
                const result = await apiCall(`/test/human-reviews/${caseId}/decision`, 'POST', payload);
                if (result.success) {
                    log(`‚úÖ Recorded human review decision for case ${caseId}`, 'success');
                    await loadHumanReviews();
                    await loadCaseMonitor({ manual: true });
                    await loadActivityLog();
                } else {
                    log(`‚ùå Failed to record decision: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error recording decision: ${error.message}`, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="emoji">‚úÖ</span> Submit Decision';
                }
            }
        }

        function renderFeeResponses(items) {
            const container = document.getElementById('fee-response-container');
            if (!container) return;

            if (!items.length) {
                container.innerHTML = '<p style="color:#718096;">No fee responses awaiting approval.</p>';
                return;
            }

            const html = items.map(item => {
                const metadata = item.metadata || {};
                const amount = metadata.fee_amount ? `$${Number(metadata.fee_amount).toFixed(2)}` : '‚Äî';
                const action = (metadata.recommended_action || 'negotiate').replace(/_/g, ' ');
                const instructions = metadata.instructions || '';
                const original = item.original_message ? escapeHtml(item.original_message.substring(0, 220)) + (item.original_message.length > 220 ? '‚Ä¶' : '') : '‚Äî';
                const status = escapeHtml(item.status);
                const replyPreview = escapeHtml(item.generated_reply || '').replace(/\n/g, '<br>');

                return `
                    <div class="fee-card" id="fee-card-${item.id}">
                        <div class="fee-metadata">
                            <span class="status-pill">${status}</span>
                            <span>Case ${item.case_id}: ${escapeHtml(item.case_name || '')}</span>
                            <span>Quoted: ${amount}</span>
                            <span>Action: ${escapeHtml(action)}</span>
                        </div>
                        <div class="fee-response-preview">${replyPreview || '<em>No draft generated</em>'}</div>
                        <details>
                            <summary style="cursor:pointer; font-size:12px; color:#4a5568;">View agency quote</summary>
                            <div style="margin-top:8px; font-size:12px; color:#2d3748;">${original}</div>
                        </details>
                        <div class="fee-actions">
                            <textarea data-fee-instructions="${item.id}" data-original-instructions="${escapeHtml(instructions)}" placeholder="Add instructions before regenerating...">${escapeHtml(instructions)}</textarea>
                            <div style="display:flex; flex-direction:column; gap:8px; min-width:180px;">
                                <label style="font-size:12px; text-transform:uppercase; color:#4a5568;">Action</label>
                                <select data-fee-action="${item.id}" data-original-action="${metadata.recommended_action || 'negotiate'}">
                                    ${['accept','negotiate','escalate'].map(opt => `<option value="${opt}" ${ (metadata.recommended_action || 'negotiate') === opt ? 'selected' : '' }>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('')}
                                </select>
                                <button class="btn-secondary" onclick="openThreadModal(${item.case_id})">
                                    <span class="emoji">üì®</span> View Thread
                                </button>
                                <button class="btn-info" onclick="regenerateFeeResponse(${item.id}, this)">
                                    <span class="emoji">‚ôªÔ∏è</span> Regenerate
                                </button>
                                <button class="btn-success" onclick="approveFeeResponse(${item.id}, this)">
                                    <span class="emoji">‚úÖ</span> Approve & Send
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="fee-card-grid">${html}</div>`;
        }

        async function approveFeeResponse(id, buttonEl) {
            const btn = buttonEl || null;
            if (!btn) return;

            const instructionsEl = document.querySelector(`[data-fee-instructions="${id}"]`);
            const actionEl = document.querySelector(`[data-fee-action="${id}"]`);
            const currentInstructions = instructionsEl ? instructionsEl.value.trim() : '';
            const originalInstructions = instructionsEl ? (instructionsEl.dataset.originalInstructions || '') : '';
            const currentAction = actionEl ? actionEl.value : null;
            const originalAction = actionEl ? (actionEl.dataset.originalAction || 'negotiate') : 'negotiate';

            if ((currentInstructions !== originalInstructions) || (currentAction !== originalAction)) {
                log('‚úèÔ∏è Detected changes to instructions/action. Regenerating draft before sending...', 'warning');
                const regenSuccess = await regenerateFeeResponse(id, null, {
                    instructions: currentInstructions,
                    action: currentAction,
                    silent: true
                });
                if (regenSuccess) {
                    log('üìù Draft updated. Review the new text, then click "Approve & Send" when ready.', 'info');
                }
                return;
            }

            const original = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Sending...';

            try {
                const result = await apiCall(`/test/fee-responses/${id}/approve`, 'POST', {});
                if (result.success) {
                    log(`‚úÖ Fee response ${id} approved and sent`, 'success');
                    await loadFeeResponses();
                    await refreshStats();
                } else {
                    log(`‚ùå Failed to approve fee response: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error approving fee response: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = original;
            }
        }

        async function regenerateFeeResponse(id, buttonEl, opts = {}) {
            const instructionsEl = document.querySelector(`[data-fee-instructions="${id}"]`);
            const actionEl = document.querySelector(`[data-fee-action="${id}"]`);
            const instructions = opts.instructions !== undefined
                ? opts.instructions
                : (instructionsEl ? instructionsEl.value.trim() : '');
            const action = opts.action !== undefined
                ? opts.action
                : (actionEl ? actionEl.value : null);
            const silent = opts.silent === true;

            const btn = buttonEl || null;
            const original = btn ? btn.innerHTML : null;
            if (!silent && btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Updating...';
            }

            try {
                const result = await apiCall(`/test/fee-responses/${id}/regenerate`, 'POST', {
                    instructions,
                    action
                });

                if (result.success) {
                    if (!silent) {
                        log(`‚ôªÔ∏è Fee response ${id} regenerated`, 'info');
                    }
                    await loadFeeResponses();
                    return true;
                } else {
                    log(`‚ùå Failed to regenerate: ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error regenerating fee response: ${error.message}`, 'error');
                return false;
            } finally {
                if (!silent && btn) {
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            }
        }

        // Activity feed
        async function loadActivityLog() {
            try {
                const result = await apiCall('/test/activity?limit=50');
                renderActivityLog(result.activity || []);
            } catch (error) {
                const container = document.getElementById('activity-log-list');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load activity: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        function renderActivityLog(entries) {
            const container = document.getElementById('activity-log-list');
            if (!container) return;

            if (!entries.length) {
                container.innerHTML = '<p style="color:#718096;">No recent activity yet.</p>';
                return;
            }

            const html = entries.map(entry => {
                const caseLabel = entry.case_name ? `${escapeHtml(entry.case_name)} ‚Ä¢ ` : '';
                const description = escapeHtml(entry.description || '');
                const timestamp = new Date(entry.created_at).toLocaleString();
                return `
                    <div class="activity-log-entry">
                        <h4>${caseLabel}${escapeHtml(entry.event_type || 'event')}</h4>
                        <p>${description}</p>
                        <p style="font-size:12px;color:#718096;margin-top:6px;">${timestamp}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Agent decisions table
        async function loadAgentDecisions() {
            try {
                const result = await apiCall('/test/agent/decisions');
                const container = document.getElementById('decisions-table');

                if (!container) return;

                if (!result.decisions || result.decisions.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No agent decisions yet.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Case</th><th>Action</th><th>Reasoning</th><th>Confidence</th><th>Time</th>';
                html += '</tr></thead><tbody>';

                result.decisions.forEach(d => {
                    const confidenceClass = d.confidence >= 0.8 ? 'success' : d.confidence >= 0.5 ? 'warning' : 'danger';
                    html += '<tr>';
                    html += `<td>${d.case_id} ‚Äî ${escapeHtml(d.case_name || 'Unknown')}</td>`;
                    html += `<td>${escapeHtml(d.action_taken || '')}</td>`;
                    html += `<td>${escapeHtml(d.reasoning || '').substring(0, 120)}${d.reasoning?.length > 120 ? '‚Ä¶' : ''}</td>`;
                    html += `<td><span class="badge ${confidenceClass}">${(d.confidence * 100).toFixed(0)}%</span></td>`;
                    html += `<td>${new Date(d.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('decisions-table');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load decisions: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        // Escalations table
        async function loadEscalations() {
            try {
                const result = await apiCall('/test/agent/escalations');
                const container = document.getElementById('escalations-table');
                if (!container) return;

                if (!result.escalations || result.escalations.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No escalations yet.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Case</th><th>Reason</th><th>Urgency</th><th>Suggested Action</th><th>Status</th><th>Created</th>';
                html += '</tr></thead><tbody>';

                result.escalations.forEach(e => {
                    const urgencyClass = e.urgency === 'high' ? 'danger' : e.urgency === 'medium' ? 'warning' : 'info';
                    html += '<tr>';
                    html += `<td>${e.case_id} ‚Äî ${escapeHtml(e.case_name || 'Unknown')}</td>`;
                    html += `<td>${escapeHtml(e.reason || '')}</td>`;
                    html += `<td><span class="badge ${urgencyClass}">${(e.urgency || '').toUpperCase()}</span></td>`;
                    html += `<td>${escapeHtml(e.suggested_action || 'None')}</td>`;
                    html += `<td>${escapeHtml(e.status || '')}</td>`;
                    html += `<td>${new Date(e.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('escalations-table');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load escalations: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        // Portal runs table
        async function loadPortalRuns() {
            try {
                const result = await apiCall('/test/portal-runs');
                const container = document.getElementById('portal-runs-table');
                if (!container) return;

                if (!result.runs || result.runs.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No portal runs yet.</p>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Time</th><th>Status</th><th>Engine</th><th>Case</th><th>Portal</th><th>Details</th>';
                html += '</tr></thead><tbody>';

                result.runs.forEach(run => {
                    const meta = run.metadata || {};
                    const status = run.event_type.replace('portal_run_', '');
                    const statusClass = status === 'completed' ? 'success' : status === 'failed' ? 'danger' : 'info';
                    const caseLabel = meta.case_id ? `Case ${meta.case_id}` : 'Test';
                    const portalLabel = meta.portal_url || 'Unknown';
                    const detailText = meta.error || meta.final_url || run.description || '';
                    const detailHtml = detailText ? `<div>${escapeHtml(detailText)}</div>` : '';
                    const linkParts = [];
                    if (meta.task_url) {
                        linkParts.push(`<a href="${meta.task_url}" target="_blank" rel="noopener">Skyvern Task</a>`);
                    } else if (meta.recording_url) {
                        linkParts.push(`<a href="${meta.recording_url}" target="_blank" rel="noopener">Skyvern Replay</a>`);
                    }
                    const linksHtml = linkParts.length ? `<div class="case-meta">${linkParts.join(' ‚Ä¢ ')}</div>` : '';
                    const details = `${detailHtml}${linksHtml}`;
                    const engineLabel = meta.engine || '‚Äî';

                    html += '<tr>';
                    html += `<td>${new Date(run.created_at).toLocaleString()}</td>`;
                    html += `<td><span class="badge ${statusClass}">${status.toUpperCase()}</span></td>`;
                    html += `<td>${engineLabel}</td>`;
                    html += `<td>${caseLabel}</td>`;
                    html += `<td style="word-break: break-all;">${portalLabel}</td>`;
                    html += `<td>${details}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('portal-runs-table');
                if (container) {
                    container.innerHTML = `<p style="color:#e53e3e;">Failed to load portal runs: ${escapeHtml(error.message)}</p>`;
                }
            }
        }

        // Run Migration
        async function runMigration() {
            if (!confirm('Run database migration? This will create agent_decisions and escalations tables.')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running...';

            log('‚öôÔ∏è Running database migration...');

            try {
                const result = await apiCall('/test/run-migration', 'POST');

                if (result.success) {
                    log('‚úÖ Migration completed successfully!', 'success');
                    result.tables?.forEach(t => log(`  ‚úì Created table: ${t}`, 'success'));
                    result.views?.forEach(v => log(`  ‚úì Created view: ${v}`, 'success'));
                } else {
                    log(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">‚öôÔ∏è</span> Run Migration';
            }
        }

        // Retrigger Analysis
        async function retriggerAnalysis(caseId) {
            if (!confirm(`Re-trigger analysis and auto-reply for case #${caseId}?`)) {
                return;
            }

            log(`üîÑ Re-triggering analysis for case #${caseId}...`);

            try {
                const result = await apiCall('/test/retrigger-analysis', 'POST', {
                    case_id: caseId
                });

                if (result.success) {
                    log(`‚úÖ Case #${caseId} re-queued for analysis!`, 'success');
                    log(`   From: ${result.from_email}`, 'info');
                    log(`   Subject: ${result.subject}`, 'info');
                    log(`   ${result.note}`, 'info');
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Run Migration 007
        async function runMigration007() {
            if (!confirm('Run migration 007? This will add UNIQUE constraint to auto_reply_queue.message_id to fix the auto-reply error.')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running...';

            log('üîß Running migration 007...');

            try {
                const result = await apiCall('/test/run-migration-007', 'POST');

                if (result.success) {
                    log('‚úÖ Migration 007 completed!', 'success');
                    log(`   ${result.message}`, 'success');
                    if (result.note) {
                        log(`   ${result.note}`, 'info');
                    }
                } else {
                    log(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üîß</span> Fix Auto-Reply Queue';
            }
        }

        // Clear Database
        async function clearDatabase() {
            if (!confirm('‚ö†Ô∏è This will DELETE ALL cases, messages, and agent data. Are you sure?')) {
                return;
            }

            if (!confirm('Really sure? This cannot be undone!')) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Clearing...';

            log('üóëÔ∏è Clearing database...');

            try {
                const result = await apiCall('/test/clear-all-cases', 'POST', {
                    confirm: 'DELETE_ALL_CASES'
                });

                if (result.success) {
                    log('‚úÖ Database cleared!', 'success');
                    log(`üìä Deleted ${result.deleted.cases} cases, ${result.deleted.messages} messages`, 'info');

                    await refreshStats();
                    await loadCaseMonitor({ manual: true });
                    await loadHumanReviews();
                    await loadActivityLog();
                    await loadAgentDecisions();
                    await loadEscalations();
                    await loadPortalRuns();
                } else {
                    log(`‚ùå Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üóëÔ∏è</span> Clear All Cases';
            }
        }

        // Auto-refresh stats + data
        setInterval(refreshStats, 30000);
        setInterval(loadFeeResponses, 45000);
        setInterval(loadHumanReviews, 45000);
        setInterval(loadActivityLog, 60000);
        setInterval(loadAgentDecisions, 60000);
        setInterval(loadEscalations, 60000);
        setInterval(loadPortalRuns, 60000);
    </script>
</body>
</html>
