<!DOCTYPE html>
<html>
<head>
    <title>AI Decision Lessons</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
        h1 { font-size: 18px; margin-bottom: 16px; color: #58a6ff; }
        .controls { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; }
        .controls select, .controls input { background: #161b22; border: 1px solid #30363d; color: #c9d1d9; padding: 6px 10px; border-radius: 4px; font-size: 13px; }
        .controls input { flex: 1; }
        button { background: #238636; border: none; color: #fff; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        button:hover { background: #2ea043; }
        button.danger { background: #da3633; }
        button.danger:hover { background: #f85149; }
        button.secondary { background: #30363d; }
        button.secondary:hover { background: #484f58; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 8px; border-bottom: 2px solid #30363d; color: #8b949e; font-weight: 600; }
        td { padding: 8px; border-bottom: 1px solid #21262d; vertical-align: top; }
        tr:hover { background: #161b22; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; }
        .badge.manual { background: #1f6feb33; color: #58a6ff; }
        .badge.auto { background: #23863633; color: #3fb950; }
        .badge.portal { background: #da363333; color: #f85149; }
        .badge.denial { background: #a371f733; color: #d2a8ff; }
        .badge.fee { background: #d2992233; color: #e3b341; }
        .badge.general { background: #30363d; color: #8b949e; }
        .badge.followup { background: #1f6feb33; color: #58a6ff; }
        .badge.agency { background: #23863633; color: #3fb950; }
        .editable { cursor: text; min-height: 20px; padding: 4px; border-radius: 3px; }
        .editable:hover { background: #1c2128; }
        .editable:focus { background: #1c2128; outline: 1px solid #58a6ff; }
        .priority-cell { width: 50px; text-align: center; }
        .actions-cell { width: 80px; white-space: nowrap; }
        .source-cell { width: 70px; }
        .category-cell { width: 90px; }
        .applied-cell { width: 50px; text-align: center; color: #8b949e; }
        .add-form { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 16px; margin-bottom: 16px; display: none; }
        .add-form .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .add-form label { display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px; }
        .add-form input, .add-form select, .add-form textarea { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 6px 10px; border-radius: 4px; font-size: 13px; font-family: inherit; }
        .add-form textarea { resize: vertical; min-height: 60px; }
        .stats { color: #8b949e; font-size: 12px; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: #238636; color: #fff; padding: 10px 16px; border-radius: 6px; font-size: 13px; display: none; z-index: 100; }
    </style>
</head>
<body>
    <h1>AI Decision Lessons</h1>

    <div class="controls">
        <button onclick="toggleAddForm()">+ Add Lesson</button>
        <select id="filterCategory" onchange="render()">
            <option value="">All categories</option>
            <option value="denial">denial</option>
            <option value="portal">portal</option>
            <option value="fee">fee</option>
            <option value="followup">followup</option>
            <option value="agency">agency</option>
            <option value="general">general</option>
        </select>
        <select id="filterSource" onchange="render()">
            <option value="">All sources</option>
            <option value="manual">manual</option>
            <option value="auto">auto</option>
        </select>
        <input type="text" id="searchBox" placeholder="Search lessons..." oninput="render()">
        <span class="stats" id="stats"></span>
    </div>

    <div class="add-form" id="addForm">
        <div class="row">
            <div style="width:120px">
                <label>Category</label>
                <select id="newCategory">
                    <option value="denial">denial</option>
                    <option value="portal">portal</option>
                    <option value="fee">fee</option>
                    <option value="followup">followup</option>
                    <option value="agency">agency</option>
                    <option value="general" selected>general</option>
                </select>
            </div>
            <div style="width:80px">
                <label>Priority</label>
                <input type="number" id="newPriority" value="7" min="1" max="10">
            </div>
            <div style="flex:1">
                <label>Trigger Pattern (keywords that activate this lesson)</label>
                <input type="text" id="newTrigger" placeholder="e.g. denial ongoing investigation privacy">
            </div>
        </div>
        <div class="row">
            <div style="flex:1">
                <label>Lesson (what the AI should do)</label>
                <textarea id="newLesson" placeholder="e.g. When agency cites ongoing investigation, propose SEND_REBUTTAL requesting segregable portions."></textarea>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button onclick="addLesson()">Save Lesson</button>
            <button class="secondary" onclick="toggleAddForm()">Cancel</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th class="priority-cell">Pri</th>
                <th class="category-cell">Category</th>
                <th style="width:25%">Trigger Pattern</th>
                <th>Lesson</th>
                <th class="source-cell">Source</th>
                <th class="applied-cell">Used</th>
                <th class="actions-cell"></th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>

    <div id="toast"></div>

    <script>
        let lessons = [];

        async function load() {
            const res = await fetch('/monitor/lessons?active=false');
            const data = await res.json();
            lessons = data.lessons || [];
            render();
        }

        function render() {
            const cat = document.getElementById('filterCategory').value;
            const src = document.getElementById('filterSource').value;
            const q = document.getElementById('searchBox').value.toLowerCase();

            let filtered = lessons;
            if (cat) filtered = filtered.filter(l => l.category === cat);
            if (src) filtered = filtered.filter(l => l.source === src);
            if (q) filtered = filtered.filter(l =>
                l.lesson.toLowerCase().includes(q) ||
                l.trigger_pattern.toLowerCase().includes(q) ||
                l.category.toLowerCase().includes(q)
            );

            document.getElementById('stats').textContent = `${filtered.length} of ${lessons.length} lessons`;

            document.getElementById('rows').innerHTML = filtered.map(l => `
                <tr style="${l.active ? '' : 'opacity:0.4;'}">
                    <td class="priority-cell">
                        <span class="editable" contenteditable="true"
                            onblur="save(${l.id}, 'priority', parseInt(this.textContent) || ${l.priority})"
                            onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${l.priority}</span>
                    </td>
                    <td class="category-cell">
                        <span class="badge ${l.category}">${l.category}</span>
                    </td>
                    <td>
                        <span class="editable" contenteditable="true"
                            onblur="save(${l.id}, 'trigger_pattern', this.textContent)">${esc(l.trigger_pattern)}</span>
                    </td>
                    <td>
                        <span class="editable" contenteditable="true"
                            onblur="save(${l.id}, 'lesson', this.textContent)">${esc(l.lesson)}</span>
                    </td>
                    <td class="source-cell"><span class="badge ${l.source}">${l.source}</span></td>
                    <td class="applied-cell">${l.times_applied}</td>
                    <td class="actions-cell">
                        <button class="secondary" style="padding:3px 8px;font-size:11px;" onclick="toggleActive(${l.id}, ${l.active})">${l.active ? 'Disable' : 'Enable'}</button>
                        <button class="danger" style="padding:3px 8px;font-size:11px;" onclick="del(${l.id})">Del</button>
                    </td>
                </tr>
            `).join('');
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s || '';
            return d.innerHTML;
        }

        async function save(id, field, value) {
            const body = {};
            body[field] = value;
            await fetch(`/monitor/lessons/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            // Update local cache
            const l = lessons.find(x => x.id === id);
            if (l) l[field] = value;
            toast('Saved');
        }

        async function toggleActive(id, current) {
            await save(id, 'active', !current);
            await load();
        }

        async function del(id) {
            if (!confirm('Delete this lesson permanently?')) return;
            await fetch(`/monitor/lessons/${id}`, { method: 'DELETE' });
            toast('Deleted');
            await load();
        }

        function toggleAddForm() {
            const f = document.getElementById('addForm');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }

        async function addLesson() {
            const body = {
                category: document.getElementById('newCategory').value,
                trigger_pattern: document.getElementById('newTrigger').value.trim(),
                lesson: document.getElementById('newLesson').value.trim(),
                priority: parseInt(document.getElementById('newPriority').value) || 7
            };
            if (!body.trigger_pattern || !body.lesson) {
                alert('Trigger pattern and lesson are required');
                return;
            }
            await fetch('/monitor/lessons', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            document.getElementById('newTrigger').value = '';
            document.getElementById('newLesson').value = '';
            toggleAddForm();
            toast('Lesson added');
            await load();
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        load();
    </script>
</body>
</html>
