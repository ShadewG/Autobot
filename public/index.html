<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autobot MVP - KPI Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.85em;
            color: #22c55e;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .activity-feed {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .activity-item:hover {
            background: #e9ecef;
        }

        .activity-item.sent {
            border-left-color: #22c55e;
        }

        .activity-item.received {
            border-left-color: #3b82f6;
        }

        .activity-item.auto-reply {
            border-left-color: #f59e0b;
        }

        .activity-item.denial {
            border-left-color: #ef4444;
        }

        .queue-item {
            padding: 15px;
            border-left: 4px solid #f59e0b;
            margin-bottom: 15px;
            background: #fff9f0;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .queue-item:hover {
            background: #fef3c7;
        }

        .queue-item.generating {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .queue-item.sending-soon {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .queue-item-type {
            font-weight: bold;
            color: #333;
        }

        .queue-item-time {
            color: #f59e0b;
            font-weight: bold;
            font-size: 0.95em;
        }

        .queue-item-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .queue-empty {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .activity-description {
            color: #333;
            line-height: 1.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.sent {
            background: #dcfce7;
            color: #16a34a;
        }

        .badge.received {
            background: #dbeafe;
            color: #2563eb;
        }

        .badge.auto-reply {
            background: #fef3c7;
            color: #d97706;
        }

        .badge.denial {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge.pending {
            background: #e0e7ff;
            color: #6366f1;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .message-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .message-subject {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .message-type {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 4px;
            background: #667eea;
            color: white;
        }

        .message-meta {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .message-body {
            color: #555;
            line-height: 1.6;
            font-size: 0.9em;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .last-updated {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 20px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .test-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .test-button:active {
            transform: translateY(0);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .test-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .test-result h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .test-result pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 Autobot MVP Dashboard</h1>
        <p class="subtitle">Real-time monitoring of autonomous FOIA bot activity</p>

        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <button id="test-button" class="test-button" onclick="runAutoReplyTest()">
                🧪 Test Instant Auto-Reply
            </button>
            <button id="notion-sync-button" class="test-button" onclick="syncNotionNow()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                🔄 Sync Notion Now
            </button>
        </div>
        <div id="test-result"></div>
        <div id="notion-sync-result"></div>

        <div id="error-container"></div>

        <div id="metrics-container" class="metrics-grid">
            <div class="loading pulse">Loading metrics...</div>
        </div>

        <div class="section">
            <h2 class="section-title">📊 Message Statistics</h2>
            <div id="message-stats" class="stats-row">
                <div class="loading pulse">Loading...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">🎯 Denial Breakdown</h2>
            <div id="denial-stats" class="stats-row">
                <div class="loading pulse">Loading...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">⏳ Queued Messages (Pending)</h2>
            <div id="queued-messages">
                <div class="loading pulse">Loading queue...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">📬 Latest Bot Messages</h2>
            <div id="latest-messages">
                <div class="loading pulse">Loading messages...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">⚡ Recent Activity</h2>
            <div id="activity-feed" class="activity-feed">
                <div class="loading pulse">Loading activity...</div>
            </div>
        </div>

        <div class="last-updated">
            Last updated: <span id="last-updated">--</span>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';

        async function fetchKPIMetrics() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/kpi`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                renderMetrics(data.metrics);
                renderMessageStats(data.metrics.messages);
                renderDenialStats(data.metrics.denials);
                renderRecentActivity(data.metrics.recentActivity);

                document.getElementById('last-updated').textContent = new Date(data.metrics.lastUpdated).toLocaleString();
            } catch (error) {
                showError('Error loading KPI metrics: ' + error.message);
            }
        }

        async function fetchLatestMessages() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/messages?limit=10`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                renderLatestMessages(data.messages);
            } catch (error) {
                showError('Error loading messages: ' + error.message);
            }
        }

        async function fetchQueuedMessages() {
            try {
                const response = await fetch(`${API_BASE}/queue/pending`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                renderQueuedMessages(data.messages, data.queue_counts);
            } catch (error) {
                console.error('Error loading queue:', error);
                document.getElementById('queued-messages').innerHTML = `
                    <div class="queue-empty">Unable to load queue status</div>
                `;
            }
        }

        function renderQueuedMessages(messages, queueCounts) {
            const container = document.getElementById('queued-messages');

            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="queue-empty">
                        ✅ No messages queued - all caught up!
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                    <strong>Queue Status:</strong>
                    ${queueCounts.generation.active + queueCounts.generation.waiting} generating,
                    ${queueCounts.email.active + queueCounts.email.waiting + queueCounts.email.delayed} waiting to send
                </div>
            `;

            messages.forEach(msg => {
                const scheduledDate = new Date(msg.scheduled_for);
                const now = new Date();
                const delayMs = scheduledDate - now;

                let timeDisplay = '';
                if (msg.queue === 'generation') {
                    timeDisplay = '<span style="color: #3b82f6;">⚙️ Generating now...</span>';
                } else if (delayMs <= 0) {
                    timeDisplay = '<span style="color: #10b981;">📤 Sending now...</span>';
                } else if (delayMs < 60000) {
                    timeDisplay = `<span style="color: #10b981;">📤 Sending in ${Math.floor(delayMs / 1000)}s</span>`;
                } else if (delayMs < 3600000) {
                    timeDisplay = `<span style="color: #f59e0b;">⏳ Sending in ${Math.floor(delayMs / 60000)} min</span>`;
                } else {
                    const hours = Math.floor(delayMs / 3600000);
                    const mins = Math.floor((delayMs % 3600000) / 60000);
                    timeDisplay = `<span style="color: #f59e0b;">⏳ Sending in ${hours}h ${mins}m</span>`;
                }

                const itemClass = msg.queue === 'generation' ? 'generating' : (delayMs < 60000 ? 'sending-soon' : '');
                const testBadge = msg.is_test_mode ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">TEST</span>' : '';

                html += `
                    <div class="queue-item ${itemClass}">
                        <div class="queue-item-header">
                            <div class="queue-item-type">${msg.type}${testBadge}</div>
                            <div class="queue-item-time">${timeDisplay}</div>
                        </div>
                        <div class="queue-item-details">
                            <strong>Case:</strong> ${msg.case_name}<br>
                            <strong>To:</strong> ${msg.to}<br>
                            <strong>Subject:</strong> ${msg.subject}<br>
                            <small style="color: #999;">Scheduled: ${scheduledDate.toLocaleString()}</small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderMetrics(metrics) {
            const { totals, responses, autoReplies } = metrics;

            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Cases</div>
                    <div class="metric-value">${totals.total_cases || 0}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Requests Sent</div>
                    <div class="metric-value">${totals.requests_sent || 0}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Responses Received</div>
                    <div class="metric-value">${totals.responses_received || 0}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Auto-Replies Sent</div>
                    <div class="metric-value">${totals.auto_replies_sent || 0}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Denials Received</div>
                    <div class="metric-value">${totals.denials_received || 0}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Threads</div>
                    <div class="metric-value">${totals.active_threads || 0}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Response Rate</div>
                    <div class="metric-value">${((responses.cases_with_responses / totals.requests_sent * 100) || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-value">${responses.avg_response_time_days || 0}<span style="font-size: 0.5em;"> days</span></div>
                </div>
            `;

            document.getElementById('metrics-container').innerHTML = metricsHTML;
        }

        function renderMessageStats(stats) {
            const statsHTML = `
                <div class="stat-item">
                    <div class="stat-label">Sent (Last 7 Days)</div>
                    <div class="stat-value">${stats.sent_last_7_days || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Sent (Last 30 Days)</div>
                    <div class="stat-value">${stats.sent_last_30_days || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Received (Last 7 Days)</div>
                    <div class="stat-value">${stats.received_last_7_days || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Received (Last 30 Days)</div>
                    <div class="stat-value">${stats.received_last_30_days || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Auto-Replies (Last 7 Days)</div>
                    <div class="stat-value">${stats.auto_replies_last_7_days || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Auto-Replies (Last 30 Days)</div>
                    <div class="stat-value">${stats.auto_replies_last_30_days || 0}</div>
                </div>
            `;

            document.getElementById('message-stats').innerHTML = statsHTML;
        }

        function renderDenialStats(stats) {
            const total = stats.total_denials || 0;

            const statsHTML = `
                <div class="stat-item">
                    <div class="stat-label">Total Denials</div>
                    <div class="stat-value">${total}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Overly Broad</div>
                    <div class="stat-value">${stats.overly_broad || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ongoing Investigation</div>
                    <div class="stat-value">${stats.ongoing_investigation || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">No Records</div>
                    <div class="stat-value">${stats.no_records || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Privacy Exemption</div>
                    <div class="stat-value">${stats.privacy_exemption || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Excessive Fees</div>
                    <div class="stat-value">${stats.excessive_fees || 0}</div>
                </div>
            `;

            document.getElementById('denial-stats').innerHTML = statsHTML;
        }

        function renderLatestMessages(messages) {
            if (!messages || messages.length === 0) {
                document.getElementById('latest-messages').innerHTML = '<div class="loading">No messages yet</div>';
                return;
            }

            const messagesHTML = messages.map(msg => {
                const messageType = msg.message_type || 'unknown';
                const badge = messageType === 'auto_reply' ? 'auto-reply' : 'sent';
                const date = new Date(msg.sent_at).toLocaleString();

                return `
                    <div class="message-card">
                        <div class="message-header">
                            <div class="message-subject">${escapeHtml(msg.subject || 'No Subject')}</div>
                            <span class="message-type">${messageType.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="message-meta">
                            <strong>To:</strong> ${escapeHtml(msg.to_email)} |
                            <strong>Agency:</strong> ${escapeHtml(msg.agency_name || 'N/A')} |
                            <strong>Sent:</strong> ${date}
                            ${msg.denial_subtype ? `| <span class="badge denial">${msg.denial_subtype.replace(/_/g, ' ')}</span>` : ''}
                        </div>
                        <div class="message-body">${escapeHtml((msg.body_text || '').substring(0, 200))}...</div>
                    </div>
                `;
            }).join('');

            document.getElementById('latest-messages').innerHTML = messagesHTML;
        }

        function renderRecentActivity(activity) {
            if (!activity || activity.length === 0) {
                document.getElementById('activity-feed').innerHTML = '<div class="loading">No activity yet</div>';
                return;
            }

            const activityHTML = activity.map(item => {
                const date = new Date(item.created_at).toLocaleString();
                const eventClass = getEventClass(item.event_type);
                const badgeClass = getBadgeClass(item.event_type);

                return `
                    <div class="activity-item ${eventClass}">
                        <div class="activity-meta">
                            <span><span class="badge ${badgeClass}">${item.event_type.replace(/_/g, ' ')}</span> ${escapeHtml(item.case_name || 'Unknown Case')}</span>
                            <span>${date}</span>
                        </div>
                        <div class="activity-description">${escapeHtml(item.description || '')}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('activity-feed').innerHTML = activityHTML;
        }

        function getEventClass(eventType) {
            if (eventType.includes('sent')) return 'sent';
            if (eventType.includes('received')) return 'received';
            if (eventType.includes('auto_reply')) return 'auto-reply';
            if (eventType.includes('denial')) return 'denial';
            return '';
        }

        function getBadgeClass(eventType) {
            if (eventType.includes('sent')) return 'sent';
            if (eventType.includes('received')) return 'received';
            if (eventType.includes('auto_reply')) return 'auto-reply';
            if (eventType.includes('denial')) return 'denial';
            return 'pending';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        async function runAutoReplyTest() {
            const button = document.getElementById('test-button');
            const resultDiv = document.getElementById('test-result');

            // Disable button and show loading
            button.disabled = true;
            button.textContent = '⏳ Sending test email...';

            resultDiv.innerHTML = `
                <div class="test-result">
                    <h3>🧪 Running Auto-Reply Test</h3>
                    <p>Sending test email to overlord1pvp@gmail.com...</p>
                </div>
            `;

            try {
                // Call the test endpoint
                const response = await fetch('/api/test/send-and-reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="test-result">
                            <h3>✅ Test Email Sent Successfully!</h3>
                            <p><strong>Case ID:</strong> ${data.case_id}</p>
                            <p><strong>Sent to:</strong> ${data.sent_to}</p>
                            <p><strong>Message ID:</strong> ${data.message_id}</p>
                            <br>
                            <h4>📋 Next Steps:</h4>
                            <ol>
                                ${data.instructions.map(instr => `<li>${instr}</li>`).join('')}
                            </ol>
                            <br>
                            <p><em>⚠️ ${data.note}</em></p>
                            <br>
                            <p>Check the "Latest Bot Messages" section below to see when the auto-reply is sent!</p>
                        </div>
                    `;

                    // Refresh the dashboard to show the new test message
                    setTimeout(() => {
                        fetchKPIMetrics();
                        fetchLatestMessages();
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Test failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result" style="border-left: 4px solid #dc2626;">
                        <h3>❌ Test Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = '🧪 Test Instant Auto-Reply';
            }
        }

        async function syncNotionNow() {
            const button = document.getElementById('notion-sync-button');
            const resultDiv = document.getElementById('notion-sync-result');

            // Disable button and show loading
            button.disabled = true;
            button.textContent = '⏳ Syncing Notion...';

            resultDiv.innerHTML = `
                <div class="test-result">
                    <h3>🔄 Syncing Notion Cases</h3>
                    <p>Fetching cases with status "Ready to Send"...</p>
                </div>
            `;

            try {
                // Call the sync endpoint
                const response = await fetch('/api/test/sync-notion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    let resultsHtml = '';
                    if (data.results && data.results.length > 0) {
                        resultsHtml = `
                            <h4>📋 Results:</h4>
                            <ul>
                                ${data.results.map(r => `
                                    <li>
                                        <strong>${r.case_name || 'Unknown'}</strong>:
                                        <span style="color: ${r.status === 'queued' ? '#22c55e' : '#666'}">
                                            ${r.status}
                                        </span>
                                        ${r.case_id ? `(Case ID: ${r.case_id})` : ''}
                                        <br>
                                        <small>${r.reason}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }

                    resultDiv.innerHTML = `
                        <div class="test-result">
                            <h3>✅ Notion Sync Complete!</h3>
                            <p><strong>Total Found:</strong> ${data.summary.total_found} cases</p>
                            <p><strong>Imported:</strong> ${data.summary.imported} new cases</p>
                            <p><strong>Queued for Sending:</strong> ${data.summary.queued} cases</p>
                            <p><strong>Skipped:</strong> ${data.summary.skipped} (already exist)</p>
                            ${resultsHtml}
                            <br>
                            <p><em>📧 Queued cases will be processed shortly. Check "Latest Bot Messages" below!</em></p>
                        </div>
                    `;

                    // Refresh the dashboard to show new cases
                    setTimeout(() => {
                        fetchKPIMetrics();
                        fetchLatestMessages();
                        location.reload(); // Reload to update case list
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Sync failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result" style="border-left: 4px solid #dc2626;">
                        <h3>❌ Sync Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = '🔄 Sync Notion Now';
            }
        }

        // Load data on page load
        fetchKPIMetrics();
        fetchLatestMessages();
        fetchQueuedMessages();

        // Refresh KPIs and messages every 30 seconds
        setInterval(() => {
            fetchKPIMetrics();
            fetchLatestMessages();
        }, 30000);

        // Refresh queue every 5 seconds (more frequent for real-time queue updates)
        setInterval(() => {
            fetchQueuedMessages();
        }, 5000);
    </script>
</body>
</html>
