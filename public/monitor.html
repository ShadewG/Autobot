<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor - Autobot</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        h1 { color: #58a6ff; margin-bottom: 20px; }
        h2 { color: #8b949e; margin: 20px 0 10px; font-size: 14px; text-transform: uppercase; }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
        }
        .stat-box .label { color: #8b949e; font-size: 12px; }
        .stat-box .value { color: #58a6ff; font-size: 28px; font-weight: bold; }
        .stat-box.inbound .value { color: #3fb950; }
        .stat-box.outbound .value { color: #f0883e; }
        .stat-box.error .value { color: #f85149; }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }
        .tab {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            color: #8b949e;
        }
        .tab:hover { background: #30363d; }
        .tab.active { background: #238636; color: white; border-color: #238636; }

        .panel { display: none; }
        .panel.active { display: block; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
        }
        th {
            background: #161b22;
            color: #8b949e;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #161b22; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.inbound { background: #238636; color: white; }
        .badge.outbound { background: #1f6feb; color: white; }
        .badge.webhook { background: #8957e5; color: white; }
        .badge.agent { background: #f0883e; color: white; }
        .badge.error { background: #f85149; color: white; }

        .email-subject {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .email-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #8b949e;
            font-size: 12px;
        }
        .timestamp { color: #8b949e; font-size: 12px; }
        .case-link { color: #58a6ff; text-decoration: none; }
        .case-link:hover { text-decoration: underline; }

        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .refresh-btn:hover { background: #2ea043; }
        .refresh-btn:disabled { background: #21262d; cursor: not-allowed; }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        pre {
            background: #161b22;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-width: 400px;
        }

        .expandable {
            cursor: pointer;
        }
        .expandable:hover {
            color: #58a6ff;
        }
    </style>
</head>
<body>
    <h1>System Monitor</h1>

    <div class="refresh-bar">
        <div class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked>
            <label for="autoRefresh">Auto-refresh every</label>
            <select id="refreshInterval">
                <option value="5000">5s</option>
                <option value="10000" selected>10s</option>
                <option value="30000">30s</option>
                <option value="60000">60s</option>
            </select>
            <span id="lastUpdate"></span>
        </div>
        <button class="refresh-btn" onclick="loadData()">Refresh Now</button>
    </div>

    <div class="stats" id="stats">
        <div class="stat-box">
            <div class="label">Total Messages</div>
            <div class="value" id="totalMessages">-</div>
        </div>
        <div class="stat-box inbound">
            <div class="label">Inbound</div>
            <div class="value" id="inboundCount">-</div>
        </div>
        <div class="stat-box outbound">
            <div class="label">Outbound</div>
            <div class="value" id="outboundCount">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Gen)</div>
            <div class="value" id="queueGen">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Email)</div>
            <div class="value" id="queueEmail">-</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-panel="all">All Messages</div>
        <div class="tab" data-panel="inbound">Inbound</div>
        <div class="tab" data-panel="outbound">Outbound</div>
        <div class="tab" data-panel="activity">Activity Log</div>
        <div class="tab" data-panel="unmatched">Unmatched</div>
    </div>

    <div id="all" class="panel active">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Direction</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="allMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="inbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Case</th>
                        <th>Intent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="inboundMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="outbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Sent</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="outboundMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="activity" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Description</th>
                        <th>Case</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityLog"></tbody>
            </table>
        </div>
    </div>

    <div id="unmatched" class="panel">
        <p style="color: #f0883e; margin-bottom: 15px;">
            These emails arrived but couldn't be matched to any case (sender email didn't match any agency_email).
        </p>
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Body Preview</th>
                    </tr>
                </thead>
                <tbody id="unmatchedMessages"></tbody>
            </table>
        </div>
    </div>

    <script>
        let refreshTimer = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        // Format timestamp
        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        // Format relative time
        function relativeTime(ts) {
            if (!ts) return '-';
            const now = new Date();
            const then = new Date(ts);
            const diff = (now - then) / 1000;
            if (diff < 60) return Math.floor(diff) + 's ago';
            if (diff < 3600) return Math.floor(diff/60) + 'm ago';
            if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
            return Math.floor(diff/86400) + 'd ago';
        }

        // Truncate text
        function truncate(text, len = 50) {
            if (!text) return '-';
            return text.length > len ? text.slice(0, len) + '...' : text;
        }

        // Badge for direction
        function directionBadge(dir) {
            return `<span class="badge ${dir}">${dir}</span>`;
        }

        // Badge for event type
        function eventBadge(type) {
            const cls = type.includes('error') ? 'error' :
                       type.includes('webhook') || type.includes('ingest') ? 'webhook' :
                       type.includes('agent') ? 'agent' : 'inbound';
            return `<span class="badge ${cls}">${type}</span>`;
        }

        // Load all data
        async function loadData() {
            try {
                const [monitorRes, inboundRes, unmatchedRes] = await Promise.all([
                    fetch('/api/monitor?limit=100'),
                    fetch('/api/monitor/inbound?limit=100'),
                    fetch('/api/monitor/unmatched?limit=50')
                ]);

                const monitor = await monitorRes.json();
                const inboundData = await inboundRes.json();
                const unmatchedData = await unmatchedRes.json();

                // Update stats
                document.getElementById('totalMessages').textContent = monitor.summary.total_messages;
                document.getElementById('inboundCount').textContent = monitor.summary.inbound_count;
                document.getElementById('outboundCount').textContent = monitor.summary.outbound_count;
                document.getElementById('queueGen').textContent =
                    (monitor.queue.generation.waiting || 0) + (monitor.queue.generation.active || 0);
                document.getElementById('queueEmail').textContent =
                    (monitor.queue.email.waiting || 0) + (monitor.queue.email.active || 0);

                // All messages
                document.getElementById('allMessages').innerHTML = monitor.inbound.concat(monitor.outbound)
                    .sort((a, b) => new Date(b.received_at || b.sent_at || b.created_at) - new Date(a.received_at || a.sent_at || a.created_at))
                    .slice(0, 100)
                    .map(m => `
                        <tr>
                            <td class="timestamp">${relativeTime(m.received_at || m.sent_at || m.created_at)}</td>
                            <td>${directionBadge(m.direction)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 60)}</td>
                            <td>${m.case_id ? `<a class="case-link" href="/api/cases/${m.case_id}" target="_blank">#${m.case_id}</a>` : '-'}</td>
                        </tr>
                    `).join('');

                // Inbound with analysis
                document.getElementById('inboundMessages').innerHTML = inboundData.inbound.map(m => `
                    <tr>
                        <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                        <td>${truncate(m.from_email, 30)}</td>
                        <td class="email-subject">${truncate(m.subject, 50)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="/api/cases/${m.case_id}" target="_blank">${truncate(m.case_name, 30)}</a>` : '<span style="color:#f85149">UNMATCHED</span>'}</td>
                        <td>${m.intent ? `<span class="badge">${m.intent}</span>` : '-'}</td>
                        <td>${m.suggested_action || '-'}</td>
                    </tr>
                `).join('');

                // Outbound
                document.getElementById('outboundMessages').innerHTML = monitor.outbound.map(m => `
                    <tr>
                        <td class="timestamp">${relativeTime(m.sent_at || m.created_at)}</td>
                        <td>${truncate(m.to_email, 35)}</td>
                        <td class="email-subject">${truncate(m.subject, 60)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="/api/cases/${m.case_id}" target="_blank">#${m.case_id}</a>` : '-'}</td>
                    </tr>
                `).join('');

                // Activity log
                document.getElementById('activityLog').innerHTML = monitor.activity.map(a => `
                    <tr>
                        <td class="timestamp">${relativeTime(a.created_at)}</td>
                        <td>${eventBadge(a.event_type)}</td>
                        <td>${truncate(a.description, 50)}</td>
                        <td>${a.case_id ? `<a class="case-link" href="/api/cases/${a.case_id}" target="_blank">#${a.case_id}</a>` : '-'}</td>
                        <td class="expandable" onclick="this.innerHTML = this.innerHTML.includes('...') ? JSON.stringify(${JSON.stringify(a.metadata).replace(/"/g, '&quot;')}, null, 2) : '${truncate(JSON.stringify(a.metadata), 30)}'">${truncate(JSON.stringify(a.metadata), 30)}</td>
                    </tr>
                `).join('');

                // Unmatched
                document.getElementById('unmatchedMessages').innerHTML = unmatchedData.unmatched.length ?
                    unmatchedData.unmatched.map(m => `
                        <tr>
                            <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 40)}</td>
                            <td class="email-body">${truncate(m.body_text, 50)}</td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="5" style="text-align:center;color:#8b949e">No unmatched emails</td></tr>';

                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        // Auto-refresh setup
        function setupAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);

            if (document.getElementById('autoRefresh').checked) {
                const interval = parseInt(document.getElementById('refreshInterval').value);
                refreshTimer = setInterval(loadData, interval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('refreshInterval').addEventListener('change', setupAutoRefresh);

        // Initial load
        loadData();
        setupAutoRefresh();
    </script>
</body>
</html>
