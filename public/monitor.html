<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor - Autobot</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        h1 { color: #58a6ff; margin-bottom: 0; }
        .topline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .runtime-badges {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .runtime-badge {
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 11px;
            color: #8b949e;
            background: #161b22;
        }
        .runtime-badge.live {
            color: #3fb950;
            border-color: #2f6f44;
        }
        h2 { color: #8b949e; margin: 20px 0 10px; font-size: 14px; text-transform: uppercase; }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
        }
        .stat-box .label { color: #8b949e; font-size: 12px; }
        .stat-box .value { color: #58a6ff; font-size: 28px; font-weight: bold; }
        .stat-box.inbound .value { color: #3fb950; }
        .stat-box.outbound .value { color: #f0883e; }
        .stat-box.error .value { color: #f85149; }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .tab {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            color: #8b949e;
            flex: 0 0 auto;
        }
        .tab:hover { background: #30363d; }
        .tab.active { background: #238636; color: white; border-color: #238636; }

        .panel { display: none; }
        .panel.active { display: block; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
        }
        th {
            background: #161b22;
            color: #8b949e;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #161b22; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.inbound { background: #238636; color: white; }
        .badge.outbound { background: #1f6feb; color: white; }
        .badge.webhook { background: #8957e5; color: white; }
        .badge.agent { background: #f0883e; color: white; }
        .badge.error { background: #f85149; color: white; }
        .badge.route-email { background: #1f6feb; color: #fff; }
        .badge.route-portal { background: #f0883e; color: #0d1117; }
        .badge.route-hybrid { background: #8957e5; color: #fff; }
        .badge.route-none { background: #30363d; color: #c9d1d9; }

        .email-subject {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .email-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #8b949e;
            font-size: 12px;
        }
        .timestamp { color: #8b949e; font-size: 12px; }
        .case-link { color: #58a6ff; text-decoration: none; }
        .case-link:hover { text-decoration: underline; }

        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .refresh-btn:hover { background: #2ea043; }
        .refresh-btn:disabled { background: #21262d; cursor: not-allowed; }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        pre {
            background: #161b22;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-width: 400px;
        }

        .expandable {
            cursor: pointer;
        }
        .expandable:hover {
            color: #58a6ff;
        }

        /* Send Test Email Form */
        .send-form {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .send-form h3 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 13px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .send-btn {
            padding: 8px 20px;
            background: #1f6feb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .send-btn:hover { background: #388bfd; }
        .send-btn:disabled { background: #21262d; cursor: not-allowed; }
        .send-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .send-result.success {
            background: #238636;
            color: white;
            display: block;
        }
        .send-result.error {
            background: #f85149;
            color: white;
            display: block;
        }
        .config-info {
            color: #8b949e;
            font-size: 11px;
            margin-top: 10px;
        }
        .ops-panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .ops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .ops-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
        }
        .ops-card .label {
            color: #8b949e;
            font-size: 11px;
        }
        .ops-card .value {
            font-size: 20px;
            color: #58a6ff;
            font-weight: 700;
        }
        .ops-lists {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .ops-list {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .ops-list h4 {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .ops-item {
            padding: 6px 0;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
        }
        .ops-item:last-child {
            border-bottom: none;
        }
        .ops-item a {
            color: #58a6ff;
            text-decoration: none;
        }
        .ops-item a:hover {
            text-decoration: underline;
        }

        /* Message Drawer */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 1000;
        }
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: #0d1117;
            border-left: 1px solid #30363d;
            padding: 16px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
        .drawer.active, .drawer-backdrop.active {
            display: block;
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .drawer-title {
            font-size: 16px;
            color: #58a6ff;
        }
        .drawer-close {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
        }
        .drawer-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #21262d;
        }
        .drawer-label {
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .drawer-value {
            color: #c9d1d9;
            font-size: 13px;
            word-break: break-word;
        }
        .drawer-body {
            white-space: pre-wrap;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .drawer-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .drawer-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 12px;
        }
        .drawer-btn.primary { background: #238636; border-color: #238636; color: white; }
        .drawer-btn.warn { background: #f0883e; border-color: #f0883e; color: #0d1117; }
        .drawer-btn:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
        .drawer-input, .drawer-textarea, .drawer-select {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .drawer-textarea { min-height: 90px; resize: vertical; }
        .drawer-log {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 11px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 8px;
            border-radius: 6px;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .proposal-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .proposal-title {
            font-size: 12px;
            color: #58a6ff;
            margin-bottom: 6px;
        }
        .proposal-meta {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 6px;
        }
        .proposal-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .proposal-decision-note {
            font-size: 11px;
            color: #8b949e;
            margin-top: 6px;
        }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: #1f242b; }
        .case-inspector {
            margin-top: 14px;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #161b22;
            padding: 12px;
        }
        .case-inspector h3 {
            color: #58a6ff;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .case-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        .case-grid .cell {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
        }
        .case-grid .cell .k {
            color: #8b949e;
            display: block;
            font-size: 11px;
            margin-bottom: 2px;
        }
        .case-list {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            padding: 8px;
        }
        .case-list-item {
            font-size: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #21262d;
        }
        .case-list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="topline">
        <h1>System Monitor</h1>
        <div class="runtime-badges">
            <span class="runtime-badge live" id="runtimeMode">Execution: LIVE</span>
            <span class="runtime-badge" id="shadowMode">Shadow: OFF</span>
            <span class="runtime-badge" id="queueBadge">Queue: -</span>
        </div>
    </div>

    <div class="refresh-bar">
        <div class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked>
            <label for="autoRefresh">Auto-refresh every</label>
            <select id="refreshInterval">
                <option value="5000">5s</option>
                <option value="10000" selected>10s</option>
                <option value="30000">30s</option>
                <option value="60000">60s</option>
            </select>
            <span id="lastUpdate"></span>
        </div>
        <button class="refresh-btn" onclick="loadData()">Refresh Now</button>
    </div>

    <div class="stats" id="stats">
        <div class="stat-box">
            <div class="label">Total Messages</div>
            <div class="value" id="totalMessages">-</div>
        </div>
        <div class="stat-box inbound">
            <div class="label">Inbound</div>
            <div class="value" id="inboundCount">-</div>
        </div>
        <div class="stat-box outbound">
            <div class="label">Outbound</div>
            <div class="value" id="outboundCount">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Gen)</div>
            <div class="value" id="queueGen">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Email)</div>
            <div class="value" id="queueEmail">-</div>
        </div>
    </div>

    <!-- Send Test Email Form -->
    <div class="send-form">
        <h3>Send Test Email</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="emailTo">To Email</label>
                <input type="email" id="emailTo" placeholder="recipient@example.com">
            </div>
            <div class="form-group">
                <label for="emailSubject">Subject</label>
                <input type="text" id="emailSubject" placeholder="Test Email Subject" value="[TEST] Autobot Email Test">
            </div>
            <button class="send-btn" onclick="sendTestEmail()">Send Email</button>
        </div>
        <div class="form-group">
            <label for="emailBody">Body (optional)</label>
            <textarea id="emailBody" placeholder="This is a test email. Please reply to test inbound detection."></textarea>
        </div>
        <div id="sendResult" class="send-result"></div>
        <div class="config-info">
            From: <span id="configFrom">loading...</span> |
            Reply to this address to test inbound webhook
        </div>
    </div>

    <div class="ops-panel">
        <h3 style="color:#58a6ff; margin-bottom:8px; font-size:14px;">Live Operations</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="notionUrlInput">Notion Case Link</label>
                <input type="text" id="notionUrlInput" placeholder="https://www.notion.so/...">
            </div>
            <div class="form-group" style="max-width: 220px;">
                <label for="initialRouteMode">Initial Route</label>
                <select id="initialRouteMode">
                    <option value="">Require Decision</option>
                    <option value="email">Email Chain</option>
                    <option value="portal">Portal Task</option>
                </select>
            </div>
            <button class="send-btn" onclick="importNotionCase(true)">Import + Queue Initial (SUPERVISED)</button>
            <button class="send-btn" onclick="importNotionCase(false)">Import Only</button>
            <button class="send-btn" style="background:#f85149;" onclick="resetOperationalState()">Reset Active/Pending</button>
        </div>
        <div id="notionImportResult" class="send-result"></div>

        <div class="ops-grid">
            <div class="ops-card">
                <div class="label">Inbound (24h)</div>
                <div class="value" id="opsInbound24h">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Pending Approvals</div>
                <div class="value" id="opsPendingApprovals">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Unmatched Inbound</div>
                <div class="value" id="opsUnmatchedInbound">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Unprocessed Inbound</div>
                <div class="value" id="opsUnprocessedInbound">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Active Runs</div>
                <div class="value" id="opsActiveRuns">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Stuck Runs (&gt;2m)</div>
                <div class="value" id="opsStuckRuns">-</div>
            </div>
        </div>
        <div style="margin-top:8px;">
            <button class="send-btn" onclick="openCasesPanel()">Open All Cases</button>
        </div>

        <div class="ops-lists">
            <div class="ops-list">
                <h4>Pending Approval Queue</h4>
                <div id="opsPendingList"></div>
            </div>
            <div class="ops-list">
                <h4>Unmatched Inbound Queue</h4>
                <div id="opsUnmatchedList"></div>
            </div>
            <div class="ops-list">
                <h4>Unprocessed Inbound Queue</h4>
                <div id="opsUnprocessedList"></div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-panel="all">All Messages</div>
        <div class="tab" data-panel="cases">All Cases</div>
        <div class="tab" data-panel="inbound">Inbound</div>
        <div class="tab" data-panel="outbound">Outbound</div>
        <div class="tab" data-panel="activity">Activity Log</div>
        <div class="tab" data-panel="unmatched">Unmatched</div>
    </div>

    <div id="all" class="panel active">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Direction</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="allMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="inbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Case</th>
                        <th>Intent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="inboundMessages"></tbody>
            </table>
        </div>
    </div>

        <div id="cases" class="panel">
            <div class="scroll-container">
                <table>
                <thead>
                    <tr>
                        <th>Updated</th>
                        <th>Case</th>
                        <th>Agency</th>
                        <th>Routing</th>
                        <th>Status</th>
                        <th>Pending</th>
                        <th>Messages</th>
                        <th>Active Run</th>
                    </tr>
                </thead>
                <tbody id="caseRows"></tbody>
                </table>
            </div>
        <div id="caseInspector" class="case-inspector" style="display:none;">
            <h3 id="caseInspectorTitle">Case Inspector</h3>
            <div id="caseInspectorGrid" class="case-grid"></div>
            <div id="caseInspectorActions" style="margin-top:10px;"></div>
            <div id="caseInspectorActionResult" class="send-result" style="display:none; margin-top:8px;"></div>
            <div id="casePortalReview" style="display:none; margin-top:10px; border:1px solid #30363d; border-radius:8px; padding:10px;">
                <h3 style="margin-top:0;">Portal Submission Review</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="portalReviewCase">Case</label>
                        <input id="portalReviewCase" readonly>
                    </div>
                    <div class="form-group">
                        <label for="portalReviewAgency">Agency</label>
                        <input id="portalReviewAgency" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="portalReviewUrl">Portal URL</label>
                        <input id="portalReviewUrl" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="portalReviewProvider">Portal Provider (optional)</label>
                        <input id="portalReviewProvider" placeholder="GovQA / NextRequest / etc">
                    </div>
                </div>
                <div class="form-group">
                    <label for="portalReviewInstructions">Instructions sent to Skyvern</label>
                    <textarea id="portalReviewInstructions" placeholder="What to submit in the portal..."></textarea>
                </div>
                <div class="form-group">
                    <label for="portalReviewResearch">Case Research Snapshot (read-only)</label>
                    <textarea id="portalReviewResearch" readonly></textarea>
                </div>
                <div class="proposal-actions">
                    <button class="send-btn" onclick="confirmPortalSubmission()">Confirm + Submit Portal</button>
                    <button class="drawer-btn" onclick="hidePortalReview()">Cancel</button>
                </div>
            </div>
            <h3>Correspondence</h3>
            <div id="caseInspectorMessages" class="case-list"></div>
            <h3 style="margin-top:10px;">Runs</h3>
            <div id="caseInspectorRuns" class="case-list"></div>
            <h3 style="margin-top:10px;">Proposals</h3>
            <div id="caseInspectorProposals" class="case-list"></div>
        </div>
    </div>

    <div id="outbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Sent</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="outboundMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="activity" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Description</th>
                        <th>Case</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityLog"></tbody>
            </table>
        </div>
    </div>

    <div id="unmatched" class="panel">
        <p style="color: #f0883e; margin-bottom: 15px;">
            These emails arrived but couldn't be matched to any case (sender email didn't match any agency_email).
        </p>
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Body Preview</th>
                    </tr>
                </thead>
                <tbody id="unmatchedMessages"></tbody>
            </table>
        </div>
    </div>

    <!-- Message Drawer -->
    <div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
    <div id="messageDrawer" class="drawer">
        <div class="drawer-header">
            <div class="drawer-title">Message Details</div>
            <button class="drawer-close" onclick="closeDrawer()">Close</button>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">Subject</div>
            <div class="drawer-value" id="drawerSubject">-</div>
            <div class="drawer-label" style="margin-top:8px;">Message ID</div>
            <div class="drawer-value" id="drawerMessageId">-</div>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">From</div>
            <div class="drawer-value" id="drawerFrom">-</div>
            <div class="drawer-label" style="margin-top:8px;">To</div>
            <div class="drawer-value" id="drawerTo">-</div>
            <div class="drawer-label" style="margin-top:8px;">Direction</div>
            <div class="drawer-value" id="drawerDirection">-</div>
            <div class="drawer-label" style="margin-top:8px;">Case</div>
            <div class="drawer-value" id="drawerCase">-</div>
            <div class="drawer-label" style="margin-top:8px;">Routing Profile</div>
            <div class="drawer-value" id="drawerRoutingProfile">-</div>
            <div class="drawer-label" style="margin-top:8px;">Received/Sent</div>
            <div class="drawer-value" id="drawerTimestamp">-</div>
            <div class="drawer-label" style="margin-top:8px;">Source</div>
            <div class="drawer-value" id="drawerSource">-</div>
            <div class="drawer-label" style="margin-top:8px;">Message Type</div>
            <div class="drawer-value" id="drawerMessageType">-</div>
            <div class="drawer-label" style="margin-top:8px;">Processed At</div>
            <div class="drawer-value" id="drawerProcessedAt">-</div>
            <div class="drawer-label" style="margin-top:8px;">Processed Run</div>
            <div class="drawer-value" id="drawerProcessedRun">-</div>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">Body</div>
            <div class="drawer-body" id="drawerBody">-</div>
        </div>

        <div class="drawer-section" id="replySection" style="display:none;">
            <div class="drawer-label">Reply</div>
            <input class="drawer-input" id="replySubject" placeholder="Subject" />
            <textarea class="drawer-textarea" id="replyBody" placeholder="Type your reply..."></textarea>
            <div class="drawer-actions">
                <button class="drawer-btn primary" id="replySendBtn" onclick="sendReply()">Send Reply</button>
            </div>
            <div id="replyResult" class="send-result" style="margin-top:8px;"></div>
        </div>

        <div class="drawer-section" id="aiSection" style="display:none;">
            <div class="drawer-label">AI Processing</div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <select class="drawer-select" id="aiMode" disabled>
                    <option value="SUPERVISED">SUPERVISED</option>
                </select>
                <label style="font-size:12px;color:#8b949e;display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="aiForce" /> force new run
                </label>
            </div>
            <div class="drawer-actions">
                <button class="drawer-btn warn" id="aiTriggerBtn" onclick="triggerAI()">Trigger AI</button>
                <a class="drawer-btn" id="aiRunLink" href="#" target="_blank" style="display:none;">View Run</a>
                <a class="drawer-btn" id="aiMessageLink" href="#" target="_blank" style="display:none;">View Message API</a>
            </div>
            <div class="drawer-label" style="margin-top:10px;">Run Status</div>
            <div class="drawer-value" id="runStatusText">-</div>
            <div class="drawer-label" style="margin-top:10px;">Run Log</div>
            <div class="drawer-log" id="aiLog"></div>
        </div>

        <div class="drawer-section" id="simulationSection" style="display:none;">
            <div class="drawer-label">Simulation</div>
            <div class="form-group" style="margin-bottom:8px;">
                <label for="simCaseId">Case ID</label>
                <input class="drawer-input" id="simCaseId" placeholder="49" />
            </div>
            <div class="form-group" style="margin-bottom:8px;">
                <label for="simFrom">From</label>
                <input class="drawer-input" id="simFrom" placeholder="records@agency.gov" />
            </div>
            <div class="form-group" style="margin-bottom:8px;">
                <label for="simSubject">Subject</label>
                <input class="drawer-input" id="simSubject" placeholder="Re: Case..." />
            </div>
            <div class="form-group" style="margin-bottom:8px;">
                <label for="simBody">Body</label>
                <textarea class="drawer-textarea" id="simBody" placeholder="Manual inbound simulation text"></textarea>
            </div>
            <div class="drawer-actions">
                <button class="drawer-btn" id="simCreateBtn" onclick="simulateInbound(false)">Create Simulated Inbound</button>
                <button class="drawer-btn primary" id="simCreateTriggerBtn" onclick="simulateInbound(true)">Create + Trigger AI</button>
            </div>
            <div id="simResult" class="send-result" style="margin-top:8px;"></div>
        </div>

        <div class="drawer-section" id="proposalSection" style="display:none;">
            <div class="drawer-label">Proposals</div>
            <div id="proposalList"></div>
        </div>
    </div>

    <script>
        let refreshTimer = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        function openCasesPanel() {
            const tab = document.querySelector('.tab[data-panel="cases"]');
            const panel = document.getElementById('cases');
            if (!tab || !panel) return;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            panel.classList.add('active');
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Format timestamp
        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        // Format relative time
        function relativeTime(ts) {
            if (!ts) return '-';
            const now = new Date();
            const then = new Date(ts);
            const diff = (now - then) / 1000;
            if (diff < 60) return Math.floor(diff) + 's ago';
            if (diff < 3600) return Math.floor(diff/60) + 'm ago';
            if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
            return Math.floor(diff/86400) + 'd ago';
        }

        // Truncate text
        function truncate(text, len = 50) {
            if (!text) return '-';
            return text.length > len ? text.slice(0, len) + '...' : text;
        }

        // Badge for direction
        function directionBadge(dir) {
            return `<span class="badge ${dir}">${dir}</span>`;
        }

        function getRoutingProfile(data) {
            const hasPortal = !!data?.portal_url;
            const hasEmail = !!data?.agency_email;
            if (hasPortal && hasEmail) return 'HYBRID';
            if (hasPortal) return 'PORTAL';
            if (hasEmail) return 'EMAIL';
            return 'UNKNOWN';
        }

        function routeBadgeForRecord(data) {
            const profile = getRoutingProfile(data);
            if (profile === 'HYBRID') return '<span class="badge route-hybrid">HYBRID</span>';
            if (profile === 'PORTAL') return '<span class="badge route-portal">PORTAL</span>';
            if (profile === 'EMAIL') return '<span class="badge route-email">EMAIL</span>';
            return '<span class="badge route-none">NONE</span>';
        }

        // Badge for event type
        function eventBadge(type) {
            const cls = type.includes('error') ? 'error' :
                       type.includes('webhook') || type.includes('ingest') ? 'webhook' :
                       type.includes('agent') ? 'agent' : 'inbound';
            return `<span class="badge ${cls}">${type}</span>`;
        }

        let caseCache = [];

        // Load all data
        async function loadData() {
            try {
                const [monitorRes, inboundRes, unmatchedRes, liveRes, casesRes] = await Promise.all([
                    fetch('/api/monitor?limit=100'),
                    fetch('/api/monitor/inbound?limit=100'),
                    fetch('/api/monitor/unmatched?limit=50'),
                    fetch('/api/monitor/live-overview?limit=25'),
                    fetch('/api/monitor/cases?limit=300')
                ]);

                const monitor = await monitorRes.json();
                const inboundData = await inboundRes.json();
                const unmatchedData = await unmatchedRes.json();
                const live = await liveRes.json();
                const casesData = await casesRes.json();

                // Update stats
                document.getElementById('totalMessages').textContent = monitor.summary.total_messages;
                document.getElementById('inboundCount').textContent = monitor.summary.inbound_count;
                document.getElementById('outboundCount').textContent = monitor.summary.outbound_count;
                document.getElementById('queueGen').textContent =
                    (monitor.queue.generation.waiting || 0) + (monitor.queue.generation.active || 0);
                document.getElementById('queueEmail').textContent =
                    (monitor.queue.email.waiting || 0) + (monitor.queue.email.active || 0);

                // All messages
                document.getElementById('allMessages').innerHTML = monitor.inbound.concat(monitor.outbound)
                    .sort((a, b) => new Date(b.received_at || b.sent_at || b.created_at) - new Date(a.received_at || a.sent_at || a.created_at))
                    .slice(0, 100)
                    .map(m => `
                        <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                            <td class="timestamp">${relativeTime(m.received_at || m.sent_at || m.created_at)}</td>
                            <td>${directionBadge(m.direction)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 60)}</td>
                            <td>${m.case_id ? `<a class="case-link" href="#" onclick="openCase(${m.case_id});return false;">#${m.case_id}</a> ${routeBadgeForRecord(m)}` : '-'}</td>
                        </tr>
                    `).join('');

                // Inbound with analysis
                document.getElementById('inboundMessages').innerHTML = inboundData.inbound.map(m => `
                    <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                        <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                        <td>${truncate(m.from_email, 30)}</td>
                        <td class="email-subject">${truncate(m.subject, 50)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="#" onclick="openCase(${m.case_id});return false;">${truncate(m.case_name, 30)}</a> ${routeBadgeForRecord(m)}` : '<span style="color:#f85149">UNMATCHED</span>'}</td>
                        <td>${m.intent ? `<span class="badge">${m.intent}</span>` : '-'}</td>
                        <td>${m.suggested_action || '-'}</td>
                    </tr>
                `).join('');

                // Outbound
                document.getElementById('outboundMessages').innerHTML = monitor.outbound.map(m => `
                    <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                        <td class="timestamp">${relativeTime(m.sent_at || m.created_at)}</td>
                        <td>${truncate(m.to_email, 35)}</td>
                        <td class="email-subject">${truncate(m.subject, 60)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="#" onclick="openCase(${m.case_id});return false;">#${m.case_id}</a> ${routeBadgeForRecord(m)}` : '-'}</td>
                    </tr>
                `).join('');

                // Activity log
                document.getElementById('activityLog').innerHTML = monitor.activity.map(a => `
                    <tr>
                        <td class="timestamp">${relativeTime(a.created_at)}</td>
                        <td>${eventBadge(a.event_type)}</td>
                        <td>${truncate(a.description, 50)}</td>
                        <td>${a.case_id ? `<a class="case-link" href="#" onclick="openCase(${a.case_id});return false;">#${a.case_id}</a>` : '-'}</td>
                        <td class="expandable" onclick="this.innerHTML = this.innerHTML.includes('...') ? JSON.stringify(${JSON.stringify(a.metadata).replace(/"/g, '&quot;')}, null, 2) : '${truncate(JSON.stringify(a.metadata), 30)}'">${truncate(JSON.stringify(a.metadata), 30)}</td>
                    </tr>
                `).join('');

                // Unmatched
                document.getElementById('unmatchedMessages').innerHTML = unmatchedData.unmatched.length ?
                    unmatchedData.unmatched.map(m => `
                        <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                            <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 40)}</td>
                            <td class="email-body">${truncate(m.body_text, 50)}</td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="5" style="text-align:center;color:#8b949e">No unmatched emails</td></tr>';

                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                renderLiveOverview(live);
                renderCases(casesData);

            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        function renderCases(payload) {
            const rowsEl = document.getElementById('caseRows');
            if (!payload || !payload.success) {
                rowsEl.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#f85149">Failed to load cases</td></tr>';
                return;
            }
            caseCache = payload.cases || [];
            if (!caseCache.length) {
                rowsEl.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#8b949e">No cases found</td></tr>';
                return;
            }

            rowsEl.innerHTML = caseCache.map(c => `
                <tr class="clickable-row" onclick="openCase(${c.id})">
                    <td class="timestamp">${relativeTime(c.updated_at)}</td>
                    <td><a class="case-link" href="#" onclick="openCase(${c.id});return false;">#${c.id}</a> ${truncate(c.case_name, 40)}</td>
                    <td>${truncate(c.agency_name, 30)}</td>
                    <td>${routeBadgeForRecord(c)}</td>
                    <td>${truncate(c.status || '-', 24)}</td>
                    <td>${c.pending_approvals || 0}</td>
                    <td>${c.total_messages || 0} (in ${c.inbound_messages || 0} / out ${c.outbound_messages || 0})</td>
                    <td>${c.active_run_id ? `#${c.active_run_id} ${c.active_run_status}` : '-'}</td>
                </tr>
            `).join('');
        }

        function renderOpsList(listId, items, renderer) {
            const el = document.getElementById(listId);
            if (!el) return;
            if (!items || items.length === 0) {
                el.innerHTML = '<div class="timestamp">None</div>';
                return;
            }
            el.innerHTML = items.map(renderer).join('');
        }

        function renderLiveOverview(payload) {
            if (!payload || !payload.success) return;
            const s = payload.summary || {};
            document.getElementById('opsInbound24h').textContent = s.inbound_24h ?? 0;
            document.getElementById('opsPendingApprovals').textContent = s.pending_approvals_total ?? 0;
            document.getElementById('opsUnmatchedInbound').textContent = s.unmatched_inbound_total ?? 0;
            document.getElementById('opsUnprocessedInbound').textContent = s.unprocessed_inbound_total ?? 0;
            document.getElementById('opsActiveRuns').textContent = s.active_runs_total ?? 0;
            document.getElementById('opsStuckRuns').textContent = s.stuck_runs_total ?? 0;

            renderOpsList('opsPendingList', payload.pending_approvals, (p) => `
                <div class="ops-item">
                    <div><a href="/api/proposals/${p.id}" target="_blank">Proposal #${p.id}</a> · Case #${p.case_id || '-'}</div>
                    <div>${p.action_type || '-'} · msg ${p.trigger_message_id || '-'} · ${relativeTime(p.created_at)}</div>
                </div>
            `);

            renderOpsList('opsUnmatchedList', payload.unmatched_inbound, (m) => `
                <div class="ops-item">
                    <div><a href="#" onclick="openMessage(${m.id});return false;">Message #${m.id}</a> · ${truncate(m.from_email, 36)}</div>
                    <div>${truncate(m.subject, 70)} · ${relativeTime(m.received_at || m.created_at)}</div>
                </div>
            `);

            renderOpsList('opsUnprocessedList', payload.unprocessed_inbound, (m) => `
                <div class="ops-item">
                    <div><a href="#" onclick="openMessage(${m.id});return false;">Message #${m.id}</a> · Case #${m.case_id || '-'}</div>
                    <div>${truncate(m.subject, 70)} · ${relativeTime(m.received_at || m.created_at)}</div>
                </div>
            `);
        }

        // Auto-refresh setup
        function setupAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);

            if (document.getElementById('autoRefresh').checked) {
                const interval = parseInt(document.getElementById('refreshInterval').value);
                refreshTimer = setInterval(loadData, interval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('refreshInterval').addEventListener('change', setupAutoRefresh);

        // Load email config
        async function loadConfig() {
            try {
                const res = await fetch('/api/monitor/config');
                const config = await res.json();
                document.getElementById('configFrom').textContent = config.from_email;
                document.getElementById('runtimeMode').textContent = `Execution: ${config.execution_mode || 'LIVE'}`;
                document.getElementById('shadowMode').textContent = `Shadow: ${config.shadow_mode ? 'ON' : 'OFF'}`;
                const queueGen = (config.queue?.generation?.waiting || 0) + (config.queue?.generation?.active || 0);
                const queueEmail = (config.queue?.email?.waiting || 0) + (config.queue?.email?.active || 0);
                document.getElementById('queueBadge').textContent = `Queue G:${queueGen} E:${queueEmail}`;
                document.getElementById('aiMode').value = config.default_autopilot_mode || 'SUPERVISED';
            } catch (err) {
                document.getElementById('configFrom').textContent = 'Error loading config';
            }
        }

        async function importNotionCase(runInitial) {
            const notionUrl = document.getElementById('notionUrlInput').value.trim();
            const routeMode = document.getElementById('initialRouteMode').value;
            const resultDiv = document.getElementById('notionImportResult');
            if (!notionUrl) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Notion URL is required.';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.style.display = 'none';
            try {
                const importRes = await fetch('/api/cases/import-notion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notion_url: notionUrl, refresh_existing: true })
                });
                const importData = await importRes.json();
                if (!importRes.ok || !importData.success) {
                    throw new Error(importData.error || `Import failed (${importRes.status})`);
                }

                const caseId = importData.case_id || importData.case?.id;
                if (!caseId) {
                    throw new Error('Case import succeeded but no case_id returned');
                }

                if (!runInitial) {
                    resultDiv.className = 'send-result success';
                    const hasPortal = !!importData.case?.portal_url;
                    const hasEmail = !!importData.case?.agency_email;
                    const routeHint = hasPortal && hasEmail
                        ? ' Routing profile: HYBRID (both portal + email). Pick Initial Route before running initial.'
                        : hasPortal
                            ? ' Routing profile: PORTAL.'
                            : hasEmail
                                ? ' Routing profile: EMAIL.'
                                : ' Routing profile: UNKNOWN (missing contact channel).';
                    resultDiv.textContent = `Case imported: #${caseId}.${routeHint}`;
                    resultDiv.style.display = 'block';
                    await loadData();
                    return;
                }

                const runRes = await fetch(`/api/cases/${caseId}/run-initial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        autopilotMode: 'SUPERVISED',
                        route_mode: routeMode || undefined
                    })
                });
                const runData = await runRes.json();
                if (!runRes.ok || !runData.success) {
                    if (runData.requires_route_decision) {
                        throw new Error('Route decision required. Pick Initial Route: Email Chain or Portal Task, then run again.');
                    }
                    throw new Error(runData.error || `Initial run failed (${runRes.status})`);
                }

                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Case #${caseId} imported. Initial run queued: run #${runData.run?.id}${runData.route_mode ? ` (${runData.route_mode})` : ''}`;
                resultDiv.style.display = 'block';
                await loadData();
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Notion import failed';
                resultDiv.style.display = 'block';
            }
        }

        async function resetOperationalState() {
            const resultDiv = document.getElementById('notionImportResult');
            const ok = window.confirm('Reset active runs and pending approvals for clean-slate testing?');
            if (!ok) return;

            resultDiv.style.display = 'none';
            try {
                const res = await fetch('/api/monitor/reset-state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || `Reset failed (${res.status})`);
                }
                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Reset complete. Runs closed: ${data.runs_reset}. Proposals dismissed: ${data.proposals_dismissed}.`;
                resultDiv.style.display = 'block';
                await loadData();
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Reset failed';
                resultDiv.style.display = 'block';
            }
        }

        // Send test email
        async function sendTestEmail() {
            const to = document.getElementById('emailTo').value.trim();
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            const resultDiv = document.getElementById('sendResult');
            const sendBtn = document.querySelector('.send-btn');

            if (!to) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Please enter a recipient email address';
                return;
            }

            if (!subject) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Please enter a subject';
                return;
            }

            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            resultDiv.style.display = 'none';

            try {
                const res = await fetch('/api/monitor/send-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body: body || undefined })
                });

                const data = await res.json();

                if (data.success) {
                    resultDiv.className = 'send-result success';
                    resultDiv.textContent = `Email sent to ${to}! Message ID: ${data.message_id}. Reply to ${data.from} to test inbound.`;
                    // Refresh data to show new outbound
                    setTimeout(loadData, 1000);
                } else {
                    resultDiv.className = 'send-result error';
                    resultDiv.textContent = `Failed: ${data.error}`;
                }
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = `Error: ${err.message}`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Email';
            }
        }

        let currentMessage = null;
        let currentRunId = null;
        let currentCaseData = null;
        let latestCasePortalTasks = [];
        let currentCaseMessages = [];
        let currentCaseProposals = [];
        let portalLinkPollTimer = null;
        let runPollTimer = null;
        let aiLogLines = [];

        function appendLog(line) {
            aiLogLines.push(`[${new Date().toLocaleTimeString()}] ${line}`);
            const logEl = document.getElementById('aiLog');
            logEl.textContent = aiLogLines.slice(-200).join('\n');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function resetLog() {
            aiLogLines = [];
            document.getElementById('aiLog').textContent = '';
        }

        async function openMessage(id) {
            try {
                const res = await fetch(`/api/monitor/message/${id}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to load message');

                currentMessage = data.message;
                document.getElementById('drawerSubject').textContent = data.message.subject || '-';
                document.getElementById('drawerMessageId').textContent = data.message.id || '-';
                document.getElementById('drawerFrom').textContent = data.message.from_email || '-';
                document.getElementById('drawerTo').textContent = data.message.to_email || '-';
                document.getElementById('drawerDirection').textContent = data.message.direction || '-';
                document.getElementById('drawerTimestamp').textContent = formatTime(data.message.received_at || data.message.sent_at || data.message.created_at);
                document.getElementById('drawerBody').textContent = data.message.body_text || data.message.body_html || '-';
                document.getElementById('drawerSource').textContent = data.source || '-';
                document.getElementById('drawerMessageType').textContent = data.message.message_type || '-';
                document.getElementById('drawerProcessedAt').textContent = formatTime(data.message.processed_at);
                document.getElementById('drawerProcessedRun').textContent = data.message.processed_run_id || '-';
                document.getElementById('runStatusText').textContent = '-';

                if (data.case) {
                    document.getElementById('drawerCase').innerHTML = `<a class="case-link" href="#" onclick="openCase(${data.case.id});return false;">#${data.case.id} ${truncate(data.case.case_name || '', 30)}</a>`;
                    const routeProfile = getRoutingProfile(data.case);
                    const latestRoute = data.case.latest_initial_route_mode || 'not set';
                    document.getElementById('drawerRoutingProfile').textContent = `${routeProfile} | latest initial route: ${latestRoute}`;
                } else {
                    document.getElementById('drawerCase').textContent = 'Unmatched';
                    document.getElementById('drawerRoutingProfile').textContent = '-';
                }

                const isInbound = data.message.direction === 'inbound';
                document.getElementById('replySection').style.display = isInbound ? 'block' : 'none';
                document.getElementById('aiSection').style.display = data.case ? 'block' : 'none';
                document.getElementById('proposalSection').style.display = data.case ? 'block' : 'none';
                document.getElementById('simulationSection').style.display = data.case ? 'block' : 'none';

                document.getElementById('replySubject').value = `Re: ${data.message.subject || ''}`.trim();
                document.getElementById('replyBody').value = '';
                document.getElementById('replyResult').style.display = 'none';
                document.getElementById('aiRunLink').style.display = 'none';
                document.getElementById('aiMessageLink').style.display = 'inline-flex';
                document.getElementById('aiMessageLink').href = `/api/monitor/message/${data.message.id}`;
                document.getElementById('simCaseId').value = data.case?.id || '';
                document.getElementById('simFrom').value = data.case?.agency_email || data.message.from_email || '';
                document.getElementById('simSubject').value = data.message.subject || '';
                document.getElementById('simBody').value = data.message.body_text || '';
                resetLog();
                currentRunId = null;
                await loadProposals(id);

                document.getElementById('drawerBackdrop').classList.add('active');
                document.getElementById('messageDrawer').classList.add('active');
            } catch (err) {
                console.error(err);
            }
        }

        async function openCase(caseId) {
            const inspector = document.getElementById('caseInspector');
            const title = document.getElementById('caseInspectorTitle');
            const grid = document.getElementById('caseInspectorGrid');
            const msgList = document.getElementById('caseInspectorMessages');
            const runList = document.getElementById('caseInspectorRuns');
            const proposalList = document.getElementById('caseInspectorProposals');
            const actions = document.getElementById('caseInspectorActions');
            const actionResult = document.getElementById('caseInspectorActionResult');
            const reviewPanel = document.getElementById('casePortalReview');

            inspector.style.display = 'block';
            title.textContent = `Case #${caseId}`;
            grid.innerHTML = '<div class="cell">Loading...</div>';
            msgList.innerHTML = '<div class="timestamp">Loading...</div>';
            runList.innerHTML = '<div class="timestamp">Loading...</div>';
            proposalList.innerHTML = '<div class="timestamp">Loading...</div>';
            actions.innerHTML = '';
            actionResult.style.display = 'none';
            reviewPanel.style.display = 'none';
            currentCaseData = null;
            latestCasePortalTasks = [];
            currentCaseMessages = [];
            currentCaseProposals = [];
            if (portalLinkPollTimer) {
                clearInterval(portalLinkPollTimer);
                portalLinkPollTimer = null;
            }

            try {
                const res = await fetch(`/api/monitor/case/${caseId}`);
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || `Failed to load case (${res.status})`);

                const c = data.case;
                currentCaseData = c;
                latestCasePortalTasks = data.portal_tasks || [];
                currentCaseMessages = data.messages || [];
                currentCaseProposals = data.proposals || [];
                title.textContent = `Case #${c.id} ${truncate(c.case_name || '', 70)}`;
                grid.innerHTML = `
                    <div class="cell"><span class="k">Status</span>${c.status || '-'}</div>
                    <div class="cell"><span class="k">Substatus</span>${truncate(c.substatus || '-', 80)}</div>
                    <div class="cell"><span class="k">Agency</span>${truncate(c.agency_name || '-', 60)}</div>
                    <div class="cell"><span class="k">Routing</span>${getRoutingProfile(c)}</div>
                    <div class="cell"><span class="k">Agency Email</span>${c.agency_email || '-'}</div>
                    <div class="cell"><span class="k">Portal URL</span>${c.portal_url ? `<a class="case-link" href="${c.portal_url}" target="_blank">open</a>` : '-'}</div>
                    <div class="cell"><span class="k">Autopilot</span>${c.autopilot_mode || '-'}</div>
                    <div class="cell"><span class="k">Updated</span>${formatTime(c.updated_at)}</div>
                    <div class="cell"><span class="k">Portal Status</span>${c.last_portal_status || '-'}</div>
                    <div class="cell"><span class="k">Skyvern Task</span>${c.last_portal_task_url ? `<a class="case-link" href="${c.last_portal_task_url}" target="_blank">open task</a>` : '-'}</div>
                    <div class="cell"><span class="k">Skyvern Recording</span>${c.last_portal_recording_url ? `<a class="case-link" href="${c.last_portal_recording_url}" target="_blank">open recording</a>` : '-'}</div>
                    <div class="cell"><span class="k">Portal Updated</span>${formatTime(c.last_portal_status_at)}</div>
                `;

                actions.innerHTML = c.portal_url
                    ? `<button class="send-btn" onclick="showPortalReview(${c.id})">Review + Trigger Portal Submission</button>`
                    : `<span class="timestamp">No portal URL on case; cannot trigger portal submission.</span>`;

                const messages = data.messages || [];
                msgList.innerHTML = messages.length
                    ? messages.map(m => `
                        <div class="case-list-item">
                            <div>${directionBadge(m.direction)} <a class="case-link" href="#" onclick="openMessage(${m.id});return false;">Message #${m.id}</a> · ${relativeTime(m.received_at || m.sent_at || m.created_at)}</div>
                            <div>${truncate(m.subject || '-', 120)}</div>
                        </div>
                    `).join('')
                    : '<div class="timestamp">No correspondence yet</div>';

                const runs = data.runs || [];
                runList.innerHTML = runs.length
                    ? runs.map(r => `
                        <div class="case-list-item">
                            <div><a class="case-link" href="/api/runs/${r.id}" target="_blank">Run #${r.id}</a> · ${r.trigger_type} · ${r.status}</div>
                            <div>${formatTime(r.started_at)}${r.ended_at ? ` -> ${formatTime(r.ended_at)}` : ''}</div>
                        </div>
                    `).join('')
                    : '<div class="timestamp">No runs yet</div>';

                const proposals = data.proposals || [];
                proposalList.innerHTML = proposals.length
                    ? proposals.map(p => `
                        <div class="case-list-item">
                            <div><a class="case-link" href="/api/proposals/${p.id}" target="_blank">Proposal #${p.id}</a> · ${p.action_type} · ${p.status}</div>
                            <div>${truncate(p.draft_subject || '-', 110)}</div>
                        </div>
                    `).join('')
                    : '<div class="timestamp">No proposals yet</div>';
            } catch (error) {
                grid.innerHTML = `<div class="cell">Error: ${error.message || error}</div>`;
                msgList.innerHTML = '<div class="timestamp">-</div>';
                runList.innerHTML = '<div class="timestamp">-</div>';
                proposalList.innerHTML = '<div class="timestamp">-</div>';
                actions.innerHTML = '';
                actionResult.style.display = 'none';
            }
        }

        function showPortalReview(caseId) {
            const panel = document.getElementById('casePortalReview');
            const c = currentCaseData;
            if (!c || c.id !== caseId) return;

            let draftInstructions = buildPortalInstructions(c, currentCaseProposals, currentCaseMessages);
            const latestTask = latestCasePortalTasks.find(t => t.status !== 'COMPLETED') || latestCasePortalTasks[0];
            if (latestTask?.instructions) {
                draftInstructions = latestTask.instructions;
            }

            document.getElementById('portalReviewCase').value = `#${c.id} ${c.case_name || ''}`.trim();
            document.getElementById('portalReviewAgency').value = c.agency_name || '';
            document.getElementById('portalReviewUrl').value = c.portal_url || '';
            document.getElementById('portalReviewProvider').value = c.portal_provider || '';
            document.getElementById('portalReviewInstructions').value = draftInstructions;
            document.getElementById('portalReviewResearch').value = buildCaseResearchSnapshot(c);
            panel.style.display = 'block';
        }

        function hidePortalReview() {
            document.getElementById('casePortalReview').style.display = 'none';
        }

        function buildPortalInstructions(c, proposals, messages) {
            const latestProposal = (proposals || []).find(p => p.draft_body_text);
            if (latestProposal?.draft_body_text) {
                const subject = latestProposal.draft_subject || `Case #${c.id} follow-up`;
                return `Submit this message in the agency portal.\n\nSubject:\n${subject}\n\nBody:\n${latestProposal.draft_body_text}`;
            }

            const latestOutbound = (messages || []).find(m => m.direction === 'outbound' && m.body_text);
            if (latestOutbound?.body_text) {
                return `Submit this public-records request in the agency portal.\n\nSubject:\n${latestOutbound.subject || `Case #${c.id} records request`}\n\nBody:\n${latestOutbound.body_text}`;
            }

            return `Submit public-records request for case #${c.id} (${c.case_name || ''}) to ${c.agency_name || 'agency'} portal.\n\nUse case details below to fill all required portal fields and submit.`;
        }

        function buildCaseResearchSnapshot(c) {
            const records = Array.isArray(c.requested_records) ? c.requested_records.filter(Boolean) : [];
            const details = (c.additional_details || '').trim();
            const detailSnippet = details ? truncate(details.replace(/\s+/g, ' '), 1200) : '-';
            return [
                `Case: #${c.id} ${c.case_name || '-'}`,
                `Subject: ${c.subject_name || '-'}`,
                `Agency: ${c.agency_name || '-'}`,
                `State: ${c.state || '-'}`,
                `Incident Date: ${c.incident_date || '-'}`,
                `Incident Location: ${c.incident_location || '-'}`,
                `Requested Records: ${records.length ? records.join(', ') : '-'}`,
                `Status/Substatus: ${c.status || '-'} / ${c.substatus || '-'}`,
                '',
                'Research:',
                detailSnippet
            ].join('\n');
        }

        async function confirmPortalSubmission() {
            if (!currentCaseData?.id) return;
            const caseId = currentCaseData.id;
            const resultDiv = document.getElementById('caseInspectorActionResult');
            const portalUrl = document.getElementById('portalReviewUrl').value.trim();
            const provider = document.getElementById('portalReviewProvider').value.trim();
            const instructions = document.getElementById('portalReviewInstructions').value.trim();

            if (!portalUrl) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Portal URL is required.';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.style.display = 'none';
            try {
                const res = await fetch(`/api/monitor/case/${caseId}/trigger-portal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        portal_url: portalUrl,
                        provider: provider || null,
                        instructions: instructions || null
                    })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || `Failed (${res.status})`);

                resultDiv.className = 'send-result success';
                resultDiv.innerHTML = `Portal job queued for case #${caseId}. Job: ${data.job_id || '-'}.
                    <div style="margin-top:6px;">Waiting for Skyvern link...</div>`;
                resultDiv.style.display = 'block';
                hidePortalReview();
                await openCase(caseId);
                await loadData();
                startPortalLinkPolling(caseId);
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Portal trigger failed';
                resultDiv.style.display = 'block';
            }
        }

        function startPortalLinkPolling(caseId) {
            const resultDiv = document.getElementById('caseInspectorActionResult');
            if (portalLinkPollTimer) clearInterval(portalLinkPollTimer);
            let attempts = 0;
            portalLinkPollTimer = setInterval(async () => {
                attempts += 1;
                try {
                    const res = await fetch(`/api/monitor/case/${caseId}`);
                    const data = await res.json();
                    if (!res.ok || !data.success) return;
                    const c = data.case || {};
                    const task = c.last_portal_task_url;
                    const recording = c.last_portal_recording_url;
                    if (task || recording) {
                        const parts = [];
                        if (task) parts.push(`<a class="case-link" href="${task}" target="_blank">Skyvern Task</a>`);
                        if (recording) parts.push(`<a class="case-link" href="${recording}" target="_blank">Recording</a>`);
                        resultDiv.className = 'send-result success';
                        resultDiv.innerHTML = `Portal submission started. ${parts.join(' | ')}`;
                        clearInterval(portalLinkPollTimer);
                        portalLinkPollTimer = null;
                        openCase(caseId);
                        return;
                    }
                    if (attempts >= 20) {
                        resultDiv.className = 'send-result';
                        resultDiv.textContent = 'Portal queued. Skyvern link not available yet. Refresh shortly.';
                        clearInterval(portalLinkPollTimer);
                        portalLinkPollTimer = null;
                    }
                } catch (_) {}
            }, 3000);
        }

        async function loadProposals(messageId, runId = null) {
            const list = document.getElementById('proposalList');
            list.innerHTML = '<div class="timestamp">Loading proposals...</div>';

            try {
                let proposals = [];
                let headerNote = '';

                if (runId) {
                    const runRes = await fetch(`/api/runs/${runId}`);
                    const runData = await runRes.json();
                    if (!runData.success) throw new Error(runData.error || 'Failed to load run');
                    proposals = runData.proposals || [];
                    headerNote = `Showing proposals for run #${runId}`;
                } else {
                    const res = await fetch(`/api/monitor/message/${messageId}/proposals`);
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Failed to load proposals');
                    proposals = data.proposals || [];
                    headerNote = 'Showing proposals for this message';
                }

                if (!proposals || proposals.length === 0) {
                    list.innerHTML = `<div class="timestamp">${headerNote}. No proposals yet.</div>`;
                    return;
                }

                list.innerHTML = `<div class="proposal-meta">${headerNote}</div>` + proposals.map(p => {
                    const status = p.status || 'UNKNOWN';
                    const body = truncate(p.draft_body_text || '', 140);
                    const canApprove = status === 'PENDING_APPROVAL';
                    const isInitial = p.action_type === 'SEND_INITIAL_REQUEST';
                    const isHybrid = !!p.portal_url && !!p.agency_email;
                    const showRouteApprove = canApprove && isInitial && isHybrid;
                    let verdict = 'Pending decision';
                    if (p.status === 'EXECUTED') {
                        if (p.outbound_message_id && p.outbound_sendgrid_message_id) {
                            verdict = `Sent live (message #${p.outbound_message_id})`;
                        } else if (p.execution_status === 'FAILED') {
                            verdict = 'Not sent (execution failed)';
                        } else if (p.execution_status === 'SKIPPED') {
                            verdict = 'Not sent (execution skipped)';
                        } else if (p.execution_status === 'QUEUED') {
                            verdict = 'Queued (awaiting send worker)';
                        } else if (p.execution_status === 'SENT' && !p.outbound_message_id) {
                            verdict = 'Sent by executor, awaiting outbound row';
                        } else {
                            verdict = 'Not sent (no outbound evidence)';
                        }
                    }
                    return `
                        <div class="proposal-card">
                            <div class="proposal-title">${p.action_type || 'Action'} #${p.id}</div>
                            <div class="proposal-meta">Status: ${status} · Confidence: ${p.confidence || '-'}</div>
                            <div class="proposal-meta">Execution: ${p.execution_key || '-'} | Email Job: ${p.email_job_id || '-'}</div>
                            <div class="proposal-meta">Execution Status: ${p.execution_status || '-'}</div>
                            <div class="proposal-meta">Routing: ${isHybrid ? 'HYBRID' : (p.portal_url ? 'PORTAL' : (p.agency_email ? 'EMAIL' : 'UNKNOWN'))}</div>
                            <div class="proposal-meta">Send Verdict: ${verdict}</div>
                            <div class="proposal-meta">${body || '-'}</div>
                            <div class="proposal-actions">
                                <button class="drawer-btn primary" ${canApprove ? '' : 'disabled'} onclick="approveProposal(${p.id})">Approve</button>
                                <button class="drawer-btn warn" ${showRouteApprove ? '' : 'disabled'} onclick="approveProposalWithRoute(${p.id}, 'email')">Approve Email</button>
                                <button class="drawer-btn warn" ${showRouteApprove ? '' : 'disabled'} onclick="approveProposalWithRoute(${p.id}, 'portal')">Approve Portal</button>
                                <button class="drawer-btn" ${canApprove ? '' : 'disabled'} onclick="adjustProposal(${p.id})">Adjust</button>
                                <button class="drawer-btn" ${canApprove ? '' : 'disabled'} onclick="dismissProposal(${p.id})">Dismiss</button>
                                <a class="drawer-btn" href="/api/proposals/${p.id}" target="_blank">View</a>
                            </div>
                            <div class="proposal-decision-note">Run: ${p.run_id || '-'} | Trigger Message: ${p.trigger_message_id || '-'}</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                list.innerHTML = `<div class="timestamp">Error loading proposals: ${err.message}</div>`;
            }
        }

        function closeDrawer() {
            document.getElementById('drawerBackdrop').classList.remove('active');
            document.getElementById('messageDrawer').classList.remove('active');
            if (runPollTimer) {
                clearInterval(runPollTimer);
                runPollTimer = null;
            }
        }

        async function sendReply() {
            if (!currentMessage) return;
            const body = document.getElementById('replyBody').value.trim();
            const subject = document.getElementById('replySubject').value.trim();
            const resultDiv = document.getElementById('replyResult');
            const btn = document.getElementById('replySendBtn');

            if (!body) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Reply body is required.';
                resultDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            resultDiv.style.display = 'none';

            try {
                const res = await fetch(`/api/monitor/message/${currentMessage.id}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, body })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to send reply');

                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Reply sent. Message ID: ${data.message_id}`;
                resultDiv.style.display = 'block';
                setTimeout(loadData, 800);
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Failed to send reply';
                resultDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        }

        async function triggerAI() {
            if (!currentMessage) return;
            const btn = document.getElementById('aiTriggerBtn');
            const mode = document.getElementById('aiMode').value;
            const force = document.getElementById('aiForce').checked;
            btn.disabled = true;
            appendLog(`Triggering AI (${mode}${force ? ', force' : ''}) for message ${currentMessage.id}...`);

            try {
                const res = await fetch(`/api/monitor/trigger-inbound-run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_id: currentMessage.id,
                        autopilotMode: mode,
                        force_new_run: force
                    })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to trigger AI');

                appendLog(`Run queued: run_id=${data.run.id}, status=${data.run.status}`);
                if (data.job_id) appendLog(`Job queued: ${data.job_id}`);
                if (data.note) appendLog(data.note);
                if (data.run?.id) {
                    const link = document.getElementById('aiRunLink');
                    link.href = `/api/runs/${data.run.id}`;
                    link.style.display = 'inline-flex';
                    currentRunId = data.run.id;
                    pollRunStatus(currentRunId);
                }
                await loadProposals(currentMessage.id, currentRunId);
                setTimeout(loadData, 1000);
            } catch (err) {
                appendLog(`Error: ${err.message || err}`);
            } finally {
                btn.disabled = false;
            }
        }

        async function proposeDecision(proposalId, action, routeMode = null) {
            appendLog(`${action} proposal ${proposalId}${routeMode ? ` (route=${routeMode})` : ''}...`);
            try {
                const payload = { action };
                if (routeMode) payload.route_mode = routeMode;
                if (action === 'ADJUST') {
                    const instruction = prompt('Adjustment instruction:');
                    if (!instruction || !instruction.trim()) {
                        appendLog('Adjust cancelled: instruction required.');
                        return;
                    }
                    payload.instruction = instruction.trim();
                }
                const res = await fetch(`/api/monitor/proposals/${proposalId}/decision`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || `Decision failed (${res.status})`);
                }
                appendLog(`${action} accepted for proposal ${proposalId} (HTTP ${res.status}).`);
                if (data.message) appendLog(`Decision response: ${data.message}`);
                if (data.run?.id) {
                    currentRunId = data.run.id;
                    pollRunStatus(currentRunId);
                }
                if (currentMessage) await loadProposals(currentMessage.id);
                setTimeout(loadData, 1000);
            } catch (err) {
                appendLog(`Decision error: ${err.message || err}`);
            }
        }

        async function approveProposal(proposalId) {
            return proposeDecision(proposalId, 'APPROVE');
        }

        async function approveProposalWithRoute(proposalId, routeMode) {
            return proposeDecision(proposalId, 'APPROVE', routeMode);
        }

        async function adjustProposal(proposalId) {
            return proposeDecision(proposalId, 'ADJUST');
        }

        async function dismissProposal(proposalId) {
            return proposeDecision(proposalId, 'DISMISS');
        }

        async function pollRunStatus(runId) {
            if (!runId) return;
            if (runPollTimer) clearInterval(runPollTimer);

            const terminalStatuses = new Set(['completed', 'paused', 'failed']);
            const runStatusText = document.getElementById('runStatusText');

            const pollOnce = async () => {
                try {
                    const res = await fetch(`/api/runs/${runId}`);
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Run fetch failed');
                    const run = data.run || {};
                    runStatusText.textContent = `${run.status || '-'} | node=${run?.metadata?.current_node || '-'} | started=${formatTime(run.started_at)} | ended=${formatTime(run.ended_at)}`;
                    if (terminalStatuses.has(run.status)) {
                        appendLog(`Run ${runId} reached terminal state: ${run.status}`);
                        clearInterval(runPollTimer);
                        runPollTimer = null;
                        if (currentMessage) await loadProposals(currentMessage.id, runId);
                    }
                } catch (error) {
                    appendLog(`Run poll error: ${error.message || error}`);
                    clearInterval(runPollTimer);
                    runPollTimer = null;
                }
            };

            await pollOnce();
            runPollTimer = setInterval(pollOnce, 2000);
        }

        async function simulateInbound(triggerAfterCreate) {
            const caseId = parseInt(document.getElementById('simCaseId').value, 10);
            const from = document.getElementById('simFrom').value.trim();
            const subject = document.getElementById('simSubject').value.trim();
            const body = document.getElementById('simBody').value.trim();
            const resultDiv = document.getElementById('simResult');

            if (!caseId || !from || !body) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Simulation requires case id, from email, and body.';
                resultDiv.style.display = 'block';
                return;
            }

            try {
                const createRes = await fetch('/api/monitor/simulate-inbound', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        case_id: caseId,
                        subject,
                        body_text: body,
                        from_email: from,
                        attach_to_thread: true,
                        mark_processed: false
                    })
                });
                const createData = await createRes.json();
                if (!createRes.ok || !createData.success) {
                    throw new Error(createData.error || `Simulation create failed (${createRes.status})`);
                }

                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Simulated inbound created: message ${createData.message_id}`;
                resultDiv.style.display = 'block';
                appendLog(`Simulated inbound created: message ${createData.message_id}`);

                if (triggerAfterCreate) {
                    const triggerRes = await fetch('/api/monitor/trigger-inbound-run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message_id: createData.message_id,
                            autopilotMode: document.getElementById('aiMode').value,
                            force_new_run: document.getElementById('aiForce').checked
                        })
                    });
                    const triggerData = await triggerRes.json();
                    if (!triggerRes.ok || !triggerData.success) {
                        throw new Error(triggerData.error || `Simulation trigger failed (${triggerRes.status})`);
                    }

                    appendLog(`Run queued: run_id=${triggerData.run.id}, status=${triggerData.run.status}`);
                    if (triggerData.job_id) appendLog(`Job queued: ${triggerData.job_id}`);
                    currentRunId = triggerData.run.id;
                    const link = document.getElementById('aiRunLink');
                    link.href = `/api/runs/${currentRunId}`;
                    link.style.display = 'inline-flex';
                    await pollRunStatus(currentRunId);
                }

                await loadData();
            } catch (error) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = `Simulation error: ${error.message || error}`;
                resultDiv.style.display = 'block';
                appendLog(`Simulation error: ${error.message || error}`);
            }
        }

        // Initial load
        loadData();
        loadConfig();
        setupAutoRefresh();
    </script>
</body>
</html>
