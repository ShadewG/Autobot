<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor - Autobot</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        h1 { color: #58a6ff; margin-bottom: 20px; }
        h2 { color: #8b949e; margin: 20px 0 10px; font-size: 14px; text-transform: uppercase; }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
        }
        .stat-box .label { color: #8b949e; font-size: 12px; }
        .stat-box .value { color: #58a6ff; font-size: 28px; font-weight: bold; }
        .stat-box.inbound .value { color: #3fb950; }
        .stat-box.outbound .value { color: #f0883e; }
        .stat-box.error .value { color: #f85149; }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }
        .tab {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            color: #8b949e;
        }
        .tab:hover { background: #30363d; }
        .tab.active { background: #238636; color: white; border-color: #238636; }

        .panel { display: none; }
        .panel.active { display: block; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
        }
        th {
            background: #161b22;
            color: #8b949e;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #161b22; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.inbound { background: #238636; color: white; }
        .badge.outbound { background: #1f6feb; color: white; }
        .badge.webhook { background: #8957e5; color: white; }
        .badge.agent { background: #f0883e; color: white; }
        .badge.error { background: #f85149; color: white; }

        .email-subject {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .email-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #8b949e;
            font-size: 12px;
        }
        .timestamp { color: #8b949e; font-size: 12px; }
        .case-link { color: #58a6ff; text-decoration: none; }
        .case-link:hover { text-decoration: underline; }

        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .refresh-btn:hover { background: #2ea043; }
        .refresh-btn:disabled { background: #21262d; cursor: not-allowed; }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        pre {
            background: #161b22;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-width: 400px;
        }

        .expandable {
            cursor: pointer;
        }
        .expandable:hover {
            color: #58a6ff;
        }

        /* Send Test Email Form */
        .send-form {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .send-form h3 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 13px;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .send-btn {
            padding: 8px 20px;
            background: #1f6feb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .send-btn:hover { background: #388bfd; }
        .send-btn:disabled { background: #21262d; cursor: not-allowed; }
        .send-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .send-result.success {
            background: #238636;
            color: white;
            display: block;
        }
        .send-result.error {
            background: #f85149;
            color: white;
            display: block;
        }
        .config-info {
            color: #8b949e;
            font-size: 11px;
            margin-top: 10px;
        }

        /* Message Drawer */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 1000;
        }
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: #0d1117;
            border-left: 1px solid #30363d;
            padding: 16px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
        .drawer.active, .drawer-backdrop.active {
            display: block;
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .drawer-title {
            font-size: 16px;
            color: #58a6ff;
        }
        .drawer-close {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
        }
        .drawer-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #21262d;
        }
        .drawer-label {
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .drawer-value {
            color: #c9d1d9;
            font-size: 13px;
            word-break: break-word;
        }
        .drawer-body {
            white-space: pre-wrap;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .drawer-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .drawer-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 12px;
        }
        .drawer-btn.primary { background: #238636; border-color: #238636; color: white; }
        .drawer-btn.warn { background: #f0883e; border-color: #f0883e; color: #0d1117; }
        .drawer-btn:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
        .drawer-input, .drawer-textarea, .drawer-select {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .drawer-textarea { min-height: 90px; resize: vertical; }
        .drawer-log {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 11px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 8px;
            border-radius: 6px;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .proposal-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .proposal-title {
            font-size: 12px;
            color: #58a6ff;
            margin-bottom: 6px;
        }
        .proposal-meta {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 6px;
        }
        .proposal-actions {
            display: flex;
            gap: 6px;
        }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: #1f242b; }
    </style>
</head>
<body>
    <h1>System Monitor</h1>

    <div class="refresh-bar">
        <div class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked>
            <label for="autoRefresh">Auto-refresh every</label>
            <select id="refreshInterval">
                <option value="5000">5s</option>
                <option value="10000" selected>10s</option>
                <option value="30000">30s</option>
                <option value="60000">60s</option>
            </select>
            <span id="lastUpdate"></span>
        </div>
        <button class="refresh-btn" onclick="loadData()">Refresh Now</button>
    </div>

    <div class="stats" id="stats">
        <div class="stat-box">
            <div class="label">Total Messages</div>
            <div class="value" id="totalMessages">-</div>
        </div>
        <div class="stat-box inbound">
            <div class="label">Inbound</div>
            <div class="value" id="inboundCount">-</div>
        </div>
        <div class="stat-box outbound">
            <div class="label">Outbound</div>
            <div class="value" id="outboundCount">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Gen)</div>
            <div class="value" id="queueGen">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Email)</div>
            <div class="value" id="queueEmail">-</div>
        </div>
    </div>

    <!-- Send Test Email Form -->
    <div class="send-form">
        <h3>Send Test Email</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="emailTo">To Email</label>
                <input type="email" id="emailTo" placeholder="recipient@example.com">
            </div>
            <div class="form-group">
                <label for="emailSubject">Subject</label>
                <input type="text" id="emailSubject" placeholder="Test Email Subject" value="[TEST] Autobot Email Test">
            </div>
            <button class="send-btn" onclick="sendTestEmail()">Send Email</button>
        </div>
        <div class="form-group">
            <label for="emailBody">Body (optional)</label>
            <textarea id="emailBody" placeholder="This is a test email. Please reply to test inbound detection."></textarea>
        </div>
        <div id="sendResult" class="send-result"></div>
        <div class="config-info">
            From: <span id="configFrom">loading...</span> |
            Reply to this address to test inbound webhook
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-panel="all">All Messages</div>
        <div class="tab" data-panel="inbound">Inbound</div>
        <div class="tab" data-panel="outbound">Outbound</div>
        <div class="tab" data-panel="activity">Activity Log</div>
        <div class="tab" data-panel="unmatched">Unmatched</div>
    </div>

    <div id="all" class="panel active">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Direction</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="allMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="inbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Case</th>
                        <th>Intent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="inboundMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="outbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Sent</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="outboundMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="activity" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Description</th>
                        <th>Case</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityLog"></tbody>
            </table>
        </div>
    </div>

    <div id="unmatched" class="panel">
        <p style="color: #f0883e; margin-bottom: 15px;">
            These emails arrived but couldn't be matched to any case (sender email didn't match any agency_email).
        </p>
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Body Preview</th>
                    </tr>
                </thead>
                <tbody id="unmatchedMessages"></tbody>
            </table>
        </div>
    </div>

    <!-- Message Drawer -->
    <div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
    <div id="messageDrawer" class="drawer">
        <div class="drawer-header">
            <div class="drawer-title">Message Details</div>
            <button class="drawer-close" onclick="closeDrawer()">Close</button>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">Subject</div>
            <div class="drawer-value" id="drawerSubject">-</div>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">From</div>
            <div class="drawer-value" id="drawerFrom">-</div>
            <div class="drawer-label" style="margin-top:8px;">To</div>
            <div class="drawer-value" id="drawerTo">-</div>
            <div class="drawer-label" style="margin-top:8px;">Direction</div>
            <div class="drawer-value" id="drawerDirection">-</div>
            <div class="drawer-label" style="margin-top:8px;">Case</div>
            <div class="drawer-value" id="drawerCase">-</div>
            <div class="drawer-label" style="margin-top:8px;">Received/Sent</div>
            <div class="drawer-value" id="drawerTimestamp">-</div>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">Body</div>
            <div class="drawer-body" id="drawerBody">-</div>
        </div>

        <div class="drawer-section" id="replySection" style="display:none;">
            <div class="drawer-label">Reply</div>
            <input class="drawer-input" id="replySubject" placeholder="Subject" />
            <textarea class="drawer-textarea" id="replyBody" placeholder="Type your reply..."></textarea>
            <div class="drawer-actions">
                <button class="drawer-btn primary" id="replySendBtn" onclick="sendReply()">Send Reply</button>
            </div>
            <div id="replyResult" class="send-result" style="margin-top:8px;"></div>
        </div>

        <div class="drawer-section" id="aiSection" style="display:none;">
            <div class="drawer-label">AI Processing</div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <select class="drawer-select" id="aiMode">
                    <option value="SUPERVISED">SUPERVISED</option>
                    <option value="AUTO">AUTO</option>
                </select>
                <label style="font-size:12px;color:#8b949e;display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="aiForce" /> force new run
                </label>
            </div>
            <div class="drawer-actions">
                <button class="drawer-btn warn" id="aiTriggerBtn" onclick="triggerAI()">Trigger AI</button>
                <a class="drawer-btn" id="aiRunLink" href="#" target="_blank" style="display:none;">View Run</a>
            </div>
            <div class="drawer-label" style="margin-top:10px;">Run Log</div>
            <div class="drawer-log" id="aiLog"></div>
        </div>

        <div class="drawer-section" id="proposalSection" style="display:none;">
            <div class="drawer-label">Proposals</div>
            <div id="proposalList"></div>
        </div>
    </div>

    <script>
        let refreshTimer = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        // Format timestamp
        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        // Format relative time
        function relativeTime(ts) {
            if (!ts) return '-';
            const now = new Date();
            const then = new Date(ts);
            const diff = (now - then) / 1000;
            if (diff < 60) return Math.floor(diff) + 's ago';
            if (diff < 3600) return Math.floor(diff/60) + 'm ago';
            if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
            return Math.floor(diff/86400) + 'd ago';
        }

        // Truncate text
        function truncate(text, len = 50) {
            if (!text) return '-';
            return text.length > len ? text.slice(0, len) + '...' : text;
        }

        // Badge for direction
        function directionBadge(dir) {
            return `<span class="badge ${dir}">${dir}</span>`;
        }

        // Badge for event type
        function eventBadge(type) {
            const cls = type.includes('error') ? 'error' :
                       type.includes('webhook') || type.includes('ingest') ? 'webhook' :
                       type.includes('agent') ? 'agent' : 'inbound';
            return `<span class="badge ${cls}">${type}</span>`;
        }

        // Load all data
        async function loadData() {
            try {
                const [monitorRes, inboundRes, unmatchedRes] = await Promise.all([
                    fetch('/api/monitor?limit=100'),
                    fetch('/api/monitor/inbound?limit=100'),
                    fetch('/api/monitor/unmatched?limit=50')
                ]);

                const monitor = await monitorRes.json();
                const inboundData = await inboundRes.json();
                const unmatchedData = await unmatchedRes.json();

                // Update stats
                document.getElementById('totalMessages').textContent = monitor.summary.total_messages;
                document.getElementById('inboundCount').textContent = monitor.summary.inbound_count;
                document.getElementById('outboundCount').textContent = monitor.summary.outbound_count;
                document.getElementById('queueGen').textContent =
                    (monitor.queue.generation.waiting || 0) + (monitor.queue.generation.active || 0);
                document.getElementById('queueEmail').textContent =
                    (monitor.queue.email.waiting || 0) + (monitor.queue.email.active || 0);

                // All messages
                document.getElementById('allMessages').innerHTML = monitor.inbound.concat(monitor.outbound)
                    .sort((a, b) => new Date(b.received_at || b.sent_at || b.created_at) - new Date(a.received_at || a.sent_at || a.created_at))
                    .slice(0, 100)
                    .map(m => `
                        <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                            <td class="timestamp">${relativeTime(m.received_at || m.sent_at || m.created_at)}</td>
                            <td>${directionBadge(m.direction)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 60)}</td>
                            <td>${m.case_id ? `<a class="case-link" href="/api/cases/${m.case_id}" target="_blank">#${m.case_id}</a>` : '-'}</td>
                        </tr>
                    `).join('');

                // Inbound with analysis
                document.getElementById('inboundMessages').innerHTML = inboundData.inbound.map(m => `
                    <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                        <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                        <td>${truncate(m.from_email, 30)}</td>
                        <td class="email-subject">${truncate(m.subject, 50)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="/api/cases/${m.case_id}" target="_blank">${truncate(m.case_name, 30)}</a>` : '<span style="color:#f85149">UNMATCHED</span>'}</td>
                        <td>${m.intent ? `<span class="badge">${m.intent}</span>` : '-'}</td>
                        <td>${m.suggested_action || '-'}</td>
                    </tr>
                `).join('');

                // Outbound
                document.getElementById('outboundMessages').innerHTML = monitor.outbound.map(m => `
                    <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                        <td class="timestamp">${relativeTime(m.sent_at || m.created_at)}</td>
                        <td>${truncate(m.to_email, 35)}</td>
                        <td class="email-subject">${truncate(m.subject, 60)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="/api/cases/${m.case_id}" target="_blank">#${m.case_id}</a>` : '-'}</td>
                    </tr>
                `).join('');

                // Activity log
                document.getElementById('activityLog').innerHTML = monitor.activity.map(a => `
                    <tr>
                        <td class="timestamp">${relativeTime(a.created_at)}</td>
                        <td>${eventBadge(a.event_type)}</td>
                        <td>${truncate(a.description, 50)}</td>
                        <td>${a.case_id ? `<a class="case-link" href="/api/cases/${a.case_id}" target="_blank">#${a.case_id}</a>` : '-'}</td>
                        <td class="expandable" onclick="this.innerHTML = this.innerHTML.includes('...') ? JSON.stringify(${JSON.stringify(a.metadata).replace(/"/g, '&quot;')}, null, 2) : '${truncate(JSON.stringify(a.metadata), 30)}'">${truncate(JSON.stringify(a.metadata), 30)}</td>
                    </tr>
                `).join('');

                // Unmatched
                document.getElementById('unmatchedMessages').innerHTML = unmatchedData.unmatched.length ?
                    unmatchedData.unmatched.map(m => `
                        <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                            <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 40)}</td>
                            <td class="email-body">${truncate(m.body_text, 50)}</td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="5" style="text-align:center;color:#8b949e">No unmatched emails</td></tr>';

                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        // Auto-refresh setup
        function setupAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);

            if (document.getElementById('autoRefresh').checked) {
                const interval = parseInt(document.getElementById('refreshInterval').value);
                refreshTimer = setInterval(loadData, interval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('refreshInterval').addEventListener('change', setupAutoRefresh);

        // Load email config
        async function loadConfig() {
            try {
                const res = await fetch('/api/monitor/config');
                const config = await res.json();
                document.getElementById('configFrom').textContent = config.from_email;
            } catch (err) {
                document.getElementById('configFrom').textContent = 'Error loading config';
            }
        }

        // Send test email
        async function sendTestEmail() {
            const to = document.getElementById('emailTo').value.trim();
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            const resultDiv = document.getElementById('sendResult');
            const sendBtn = document.querySelector('.send-btn');

            if (!to) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Please enter a recipient email address';
                return;
            }

            if (!subject) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Please enter a subject';
                return;
            }

            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            resultDiv.style.display = 'none';

            try {
                const res = await fetch('/api/monitor/send-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body: body || undefined })
                });

                const data = await res.json();

                if (data.success) {
                    resultDiv.className = 'send-result success';
                    resultDiv.textContent = `Email sent to ${to}! Message ID: ${data.message_id}. Reply to ${data.from} to test inbound.`;
                    // Refresh data to show new outbound
                    setTimeout(loadData, 1000);
                } else {
                    resultDiv.className = 'send-result error';
                    resultDiv.textContent = `Failed: ${data.error}`;
                }
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = `Error: ${err.message}`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Email';
            }
        }

        let currentMessage = null;
        let currentRunId = null;
        let aiLogLines = [];

        function appendLog(line) {
            aiLogLines.push(`[${new Date().toLocaleTimeString()}] ${line}`);
            const logEl = document.getElementById('aiLog');
            logEl.textContent = aiLogLines.slice(-200).join('\n');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function resetLog() {
            aiLogLines = [];
            document.getElementById('aiLog').textContent = '';
        }

        async function openMessage(id) {
            try {
                const res = await fetch(`/api/monitor/message/${id}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to load message');

                currentMessage = data.message;
                document.getElementById('drawerSubject').textContent = data.message.subject || '-';
                document.getElementById('drawerFrom').textContent = data.message.from_email || '-';
                document.getElementById('drawerTo').textContent = data.message.to_email || '-';
                document.getElementById('drawerDirection').textContent = data.message.direction || '-';
                document.getElementById('drawerTimestamp').textContent = formatTime(data.message.received_at || data.message.sent_at || data.message.created_at);
                document.getElementById('drawerBody').textContent = data.message.body_text || data.message.body_html || '-';

                if (data.case) {
                    document.getElementById('drawerCase').innerHTML = `<a class="case-link" href="/api/cases/${data.case.id}" target="_blank">#${data.case.id} ${truncate(data.case.case_name || '', 30)}</a>`;
                } else {
                    document.getElementById('drawerCase').textContent = 'Unmatched';
                }

                const isInbound = data.message.direction === 'inbound';
                document.getElementById('replySection').style.display = isInbound ? 'block' : 'none';
                document.getElementById('aiSection').style.display = data.case ? 'block' : 'none';
                document.getElementById('proposalSection').style.display = data.case ? 'block' : 'none';

                document.getElementById('replySubject').value = `Re: ${data.message.subject || ''}`.trim();
                document.getElementById('replyBody').value = '';
                document.getElementById('replyResult').style.display = 'none';
                document.getElementById('aiRunLink').style.display = 'none';
                resetLog();
                currentRunId = null;
                await loadProposals(id);

                document.getElementById('drawerBackdrop').classList.add('active');
                document.getElementById('messageDrawer').classList.add('active');
            } catch (err) {
                console.error(err);
            }
        }

        async function loadProposals(messageId, runId = null) {
            const list = document.getElementById('proposalList');
            list.innerHTML = '<div class="timestamp">Loading proposals...</div>';

            try {
                let proposals = [];
                let headerNote = '';

                if (runId) {
                    const runRes = await fetch(`/api/runs/${runId}`);
                    const runData = await runRes.json();
                    if (!runData.success) throw new Error(runData.error || 'Failed to load run');
                    proposals = runData.proposals || [];
                    headerNote = `Showing proposals for run #${runId}`;
                } else {
                    const res = await fetch(`/api/monitor/message/${messageId}/proposals`);
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Failed to load proposals');
                    proposals = data.proposals || [];
                    headerNote = 'Showing proposals for this message';
                }

                if (!proposals || proposals.length === 0) {
                    list.innerHTML = `<div class="timestamp">${headerNote}. No proposals yet.</div>`;
                    return;
                }

                list.innerHTML = `<div class="proposal-meta">${headerNote}</div>` + proposals.map(p => {
                    const status = p.status || 'UNKNOWN';
                    const body = truncate(p.draft_body_text || '', 140);
                    const canApprove = status === 'PENDING_APPROVAL';
                    return `
                        <div class="proposal-card">
                            <div class="proposal-title">${p.action_type || 'Action'} #${p.id}</div>
                            <div class="proposal-meta">Status: ${status} Â· Confidence: ${p.confidence || '-'}</div>
                            <div class="proposal-meta">${body || '-'}</div>
                            <div class="proposal-actions">
                                <button class="drawer-btn primary" ${canApprove ? '' : 'disabled'} onclick="approveProposal(${p.id})">Approve</button>
                                <a class="drawer-btn" href="/api/proposals/${p.id}" target="_blank">View</a>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                list.innerHTML = `<div class="timestamp">Error loading proposals: ${err.message}</div>`;
            }
        }

        function closeDrawer() {
            document.getElementById('drawerBackdrop').classList.remove('active');
            document.getElementById('messageDrawer').classList.remove('active');
        }

        async function sendReply() {
            if (!currentMessage) return;
            const body = document.getElementById('replyBody').value.trim();
            const subject = document.getElementById('replySubject').value.trim();
            const resultDiv = document.getElementById('replyResult');
            const btn = document.getElementById('replySendBtn');

            if (!body) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Reply body is required.';
                resultDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            resultDiv.style.display = 'none';

            try {
                const res = await fetch(`/api/monitor/message/${currentMessage.id}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, body })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to send reply');

                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Reply sent. Message ID: ${data.message_id}`;
                resultDiv.style.display = 'block';
                setTimeout(loadData, 800);
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Failed to send reply';
                resultDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        }

        async function triggerAI() {
            if (!currentMessage) return;
            const btn = document.getElementById('aiTriggerBtn');
            const mode = document.getElementById('aiMode').value;
            const force = document.getElementById('aiForce').checked;
            btn.disabled = true;
            appendLog(`Triggering AI (${mode}${force ? ', force' : ''}) for message ${currentMessage.id}...`);

            try {
                const res = await fetch(`/api/monitor/message/${currentMessage.id}/trigger-ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autopilotMode: mode, force_new_run: force })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to trigger AI');

                appendLog(`Run queued: run_id=${data.run.id}, status=${data.run.status}`);
                if (data.job_id) appendLog(`Job queued: ${data.job_id}`);
                if (data.note) appendLog(data.note);
                if (data.run?.id) {
                    const link = document.getElementById('aiRunLink');
                    link.href = `/api/runs/${data.run.id}`;
                    link.style.display = 'inline-flex';
                    currentRunId = data.run.id;
                }
                await loadProposals(currentMessage.id, currentRunId);
                setTimeout(loadData, 1000);
            } catch (err) {
                appendLog(`Error: ${err.message || err}`);
            } finally {
                btn.disabled = false;
            }
        }

        async function approveProposal(proposalId) {
            appendLog(`Approving proposal ${proposalId}...`);
            try {
                const res = await fetch(`/api/monitor/proposals/${proposalId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Approval failed');
                appendLog(`Approved proposal ${proposalId}.`);
                if (currentMessage) await loadProposals(currentMessage.id);
                setTimeout(loadData, 1000);
            } catch (err) {
                appendLog(`Approval error: ${err.message || err}`);
            }
        }

        // Initial load
        loadData();
        loadConfig();
        setupAutoRefresh();
    </script>
</body>
</html>
