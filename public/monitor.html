<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor - Autobot</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        h1 { color: #58a6ff; margin-bottom: 0; }
        .topline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .runtime-badges {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .runtime-badge {
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 11px;
            color: #8b949e;
            background: #161b22;
        }
        .runtime-badge.live {
            color: #3fb950;
            border-color: #2f6f44;
        }
        h2 { color: #8b949e; margin: 20px 0 10px; font-size: 14px; text-transform: uppercase; }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
        }
        .stat-box .label { color: #8b949e; font-size: 12px; }
        .stat-box .value { color: #58a6ff; font-size: 28px; font-weight: bold; }
        .stat-box.inbound .value { color: #3fb950; }
        .stat-box.outbound .value { color: #f0883e; }
        .stat-box.error .value { color: #f85149; }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .tab {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            color: #8b949e;
            flex: 0 0 auto;
        }
        .tab:hover { background: #30363d; }
        .tab.active { background: #238636; color: white; border-color: #238636; }

        .panel { display: none; }
        .panel.active { display: block; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
        }
        th {
            background: #161b22;
            color: #8b949e;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #161b22; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.inbound { background: #238636; color: white; }
        .badge.outbound { background: #1f6feb; color: white; }
        .badge.webhook { background: #8957e5; color: white; }
        .badge.agent { background: #f0883e; color: white; }
        .badge.error { background: #f85149; color: white; }
        .badge.route-email { background: #1f6feb; color: #fff; }
        .badge.route-portal { background: #f0883e; color: #0d1117; }
        .badge.route-hybrid { background: #8957e5; color: #fff; }
        .badge.route-none { background: #30363d; color: #c9d1d9; }

        .email-subject {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .email-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #8b949e;
            font-size: 12px;
        }
        .timestamp { color: #8b949e; font-size: 12px; }
        .case-link { color: #58a6ff; text-decoration: none; }
        .case-link:hover { text-decoration: underline; }

        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .refresh-btn:hover { background: #2ea043; }
        .refresh-btn:disabled { background: #21262d; cursor: not-allowed; }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        pre {
            background: #161b22;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-width: 400px;
        }

        .expandable {
            cursor: pointer;
        }
        .expandable:hover {
            color: #58a6ff;
        }

        /* Send Test Email Form */
        .send-form {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .send-form h3 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 13px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .send-btn {
            padding: 8px 20px;
            background: #1f6feb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .send-btn:hover { background: #388bfd; }
        .send-btn:disabled { background: #21262d; cursor: not-allowed; }
        .send-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .send-result.success {
            background: #238636;
            color: white;
            display: block;
        }
        .send-result.error {
            background: #f85149;
            color: white;
            display: block;
        }
        .config-info {
            color: #8b949e;
            font-size: 11px;
            margin-top: 10px;
        }
        .ops-panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .ops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .ops-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
        }
        .ops-card .label {
            color: #8b949e;
            font-size: 11px;
        }
        .ops-card .value {
            font-size: 20px;
            color: #58a6ff;
            font-weight: 700;
        }
        .ops-lists {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .ops-list {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .ops-list h4 {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .ops-item {
            padding: 6px 0;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
        }
        .ops-item:last-child {
            border-bottom: none;
        }
        .ops-item a {
            color: #58a6ff;
            text-decoration: none;
        }
        .ops-item a:hover {
            text-decoration: underline;
        }

        /* Message Drawer */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 1000;
        }
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: #0d1117;
            border-left: 1px solid #30363d;
            padding: 16px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
        .drawer.active, .drawer-backdrop.active {
            display: block;
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .drawer-title {
            font-size: 16px;
            color: #58a6ff;
        }
        .drawer-close {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
        }
        .drawer-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #21262d;
        }
        .drawer-label {
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .drawer-value {
            color: #c9d1d9;
            font-size: 13px;
            word-break: break-word;
        }
        .drawer-body {
            white-space: pre-wrap;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .drawer-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .drawer-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 12px;
        }
        .drawer-btn.primary { background: #238636; border-color: #238636; color: white; }
        .drawer-btn.warn { background: #f0883e; border-color: #f0883e; color: #0d1117; }
        .drawer-btn:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
        .drawer-input, .drawer-textarea, .drawer-select {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .drawer-textarea { min-height: 90px; resize: vertical; }
        .drawer-log {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 11px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 8px;
            border-radius: 6px;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .proposal-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .proposal-title {
            font-size: 12px;
            color: #58a6ff;
            margin-bottom: 6px;
        }
        .proposal-meta {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 6px;
        }
        .proposal-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .proposal-decision-note {
            font-size: 11px;
            color: #8b949e;
            margin-top: 6px;
        }

        /* Pending proposal action cards */
        .proposal-action-card {
            background: #0d1117;
            border: 2px solid #1f6feb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .proposal-action-card .pac-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .proposal-action-card .pac-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: #1f6feb;
            color: #fff;
        }
        .proposal-action-card .pac-reasoning {
            font-size: 12px;
            color: #d2a8ff;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .proposal-action-card .pac-draft {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .proposal-action-card .pac-draft .pac-subject {
            color: #58a6ff;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .proposal-action-card .pac-draft .pac-body-preview {
            color: #8b949e;
            white-space: pre-wrap;
            max-height: 60px;
            overflow: hidden;
        }
        .proposal-action-card .pac-draft .pac-body-full {
            color: #c9d1d9;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .proposal-action-card .pac-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .proposal-action-card .pac-expanded-detail {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #30363d;
        }
        .proposal-action-card .pac-detail-row {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }

        /* Contact indicator badges */
        .contact-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background: #21262d;
            color: #8b949e;
        }
        .contact-indicator.has-portal { color: #f0883e; border: 1px solid #f0883e40; }
        .contact-indicator.has-email { color: #1f6feb; border: 1px solid #1f6feb40; }
        .contact-indicator.has-both { color: #8957e5; border: 1px solid #8957e540; }

        /* AI case summary */
        .ai-case-summary {
            background: #1c2333;
            border: 1px solid #388bfd40;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.5;
        }
        .ai-case-summary .summary-label {
            color: #58a6ff;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .ai-case-summary .summary-text {
            color: #c9d1d9;
        }

        /* Quick Actions section */
        .quick-actions-section {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #30363d;
        }
        .quick-actions-label {
            font-size: 11px;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: #1f242b; }
        .clickable-row.expanded { background: #1c2333; }
        .case-expanded-row td { padding: 0; }
        .case-inspector {
            margin-top: 14px;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #161b22;
            padding: 12px;
        }
        .case-inspector h3 {
            color: #58a6ff;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .case-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        .case-grid .cell {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
        }
        .case-grid .cell .k {
            color: #8b949e;
            display: block;
            font-size: 11px;
            margin-bottom: 2px;
        }
        .case-list {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            padding: 8px;
        }
        .case-list-item {
            font-size: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #21262d;
        }
        .case-list-item:last-child {
            border-bottom: none;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 380px;
        }
        .toast {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 13px;
            color: #c9d1d9;
            box-shadow: 0 4px 16px rgba(0,0,0,.4);
            animation: toastSlideIn .3s ease-out;
            cursor: pointer;
            border-left: 4px solid #8b949e;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            word-break: break-word;
        }
        .toast.success { border-left-color: #3fb950; }
        .toast.error   { border-left-color: #f85149; }
        .toast.warning { border-left-color: #d29922; }
        .toast.info    { border-left-color: #58a6ff; }
        .toast .toast-close {
            margin-left: auto;
            cursor: pointer;
            color: #8b949e;
            font-size: 16px;
            line-height: 1;
            flex-shrink: 0;
        }
        .toast .toast-close:hover { color: #c9d1d9; }
        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }

        /* SSE connection badge */
        .runtime-badge.sse-connected { color: #3fb950; border-color: #2f6f44; }
        .runtime-badge.sse-disconnected { color: #f85149; border-color: #da3633; }

        /* Find PD Contact button */
        .btn-pd-contact {
            background: #6e40c9;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        .btn-pd-contact:hover { background: #8957e5; }
        .btn-pd-contact:disabled { opacity: .5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="topline">
        <h1>System Monitor</h1>
        <div class="runtime-badges">
            <span class="runtime-badge live" id="runtimeMode">Execution: LIVE</span>
            <span class="runtime-badge" id="shadowMode">Shadow: OFF</span>
            <span class="runtime-badge" id="queueBadge">Queue: -</span>
            <span class="runtime-badge sse-disconnected" id="sseBadge">SSE: --</span>
        </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <span id="lastUpdate" style="color:#8b949e;font-size:12px;"></span>
        <button class="refresh-btn" onclick="loadData()">Refresh Now</button>
    </div>

    <div class="stats" id="stats">
        <div class="stat-box">
            <div class="label">Total Messages</div>
            <div class="value" id="totalMessages">-</div>
        </div>
        <div class="stat-box inbound">
            <div class="label">Inbound</div>
            <div class="value" id="inboundCount">-</div>
        </div>
        <div class="stat-box outbound">
            <div class="label">Outbound</div>
            <div class="value" id="outboundCount">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Gen)</div>
            <div class="value" id="queueGen">-</div>
        </div>
        <div class="stat-box">
            <div class="label">Queue (Email)</div>
            <div class="value" id="queueEmail">-</div>
        </div>
        <div class="stat-box" style="border-color:#f0883e;">
            <div class="label">Phone Queue</div>
            <div class="value" id="phoneQueueCount" style="color:#f0883e;">-</div>
        </div>
    </div>

    <div class="ops-panel">
        <h3 style="color:#58a6ff; margin-bottom:8px; font-size:14px;">Live Operations</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="notionUrlInput">Notion Case Link</label>
                <input type="text" id="notionUrlInput" placeholder="https://www.notion.so/...">
            </div>
            <div class="form-group" style="max-width: 180px;">
                <label for="initialRouteMode">Mode</label>
                <select id="initialRouteMode">
                    <option value="SUPERVISED" selected>Supervised</option>
                    <option value="AUTO">Auto</option>
                </select>
            </div>
            <button class="send-btn" id="importBtn" onclick="importNotionCase()">Import</button>
        </div>
        <div id="notionImportResult" class="send-result"></div>
        <div id="importConfirmPanel" style="display:none; background:#0d1117; border:1px solid #30363d; border-radius:8px; padding:12px; margin-top:8px;">
            <div id="importConfirmDetails" style="font-size:12px; color:#c9d1d9; margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;">
                <button class="send-btn" onclick="confirmImportSend()">Confirm &amp; Send</button>
                <button class="drawer-btn" onclick="cancelImportConfirm()">Cancel</button>
            </div>
        </div>

        <div class="ops-grid">
            <div class="ops-card">
                <div class="label">Inbound (24h)</div>
                <div class="value" id="opsInbound24h">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Pending Approvals</div>
                <div class="value" id="opsPendingApprovals">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Unmatched Inbound</div>
                <div class="value" id="opsUnmatchedInbound">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Active Runs</div>
                <div class="value" id="opsActiveRuns">-</div>
            </div>
            <div class="ops-card">
                <div class="label">Stuck Runs (&gt;2m)</div>
                <div class="value" id="opsStuckRuns">-</div>
            </div>
        </div>
        <div style="margin-top:8px;">
            <button class="send-btn" onclick="openCasesPanel()">Open All Cases</button>
        </div>

        <div class="ops-lists">
            <div class="ops-list">
                <h4>Pending Approval Queue</h4>
                <div id="opsPendingList"></div>
            </div>
            <div class="ops-list">
                <h4>Unmatched Inbound Queue</h4>
                <div id="opsUnmatchedList"></div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-panel="all">All Messages</div>
        <div class="tab" data-panel="cases">All Cases</div>
        <div class="tab" data-panel="inbound">Inbound</div>
        <div class="tab" data-panel="outbound">Outbound</div>
        <div class="tab" data-panel="activity">Activity Log</div>
        <div class="tab" data-panel="phonecalls">Phone Calls <span id="phoneCallBadge" style="background:#f0883e;color:#0d1117;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px;display:none;">0</span></div>
        <div class="tab" data-panel="unmatched">Unmatched</div>
    </div>

    <div id="all" class="panel active">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Direction</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="allMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="inbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Case</th>
                        <th>Intent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="inboundMessages"></tbody>
            </table>
        </div>
    </div>

        <div id="cases" class="panel">
            <div class="scroll-container" style="max-height:none;">
                <table>
                <thead>
                    <tr>
                        <th>Updated</th>
                        <th>Case</th>
                        <th>Agency</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th>Pending</th>
                        <th>Messages</th>
                        <th>Active Run</th>
                    </tr>
                </thead>
                <tbody id="caseRows"></tbody>
                </table>
            </div>
    </div>

    <!-- Case Inspector Template (moved inline under clicked row via JS) -->
    <div id="caseInspector" class="case-inspector" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 id="caseInspectorTitle">Case Inspector</h3>
            <button class="drawer-close" onclick="collapseCase()" title="Close">Close</button>
        </div>
        <div id="caseInspectorGrid" class="case-grid"></div>
        <div id="casePortalInfoPanel" style="display:none; margin-top:12px; border:1px solid #30363d; border-radius:8px; padding:10px;"></div>
        <div id="caseInspectorProposalCards" style="margin-top:10px;"></div>
        <div id="caseInspectorActions" style="margin-top:10px;"></div>
        <div id="caseInspectorActionResult" class="send-result" style="display:none; margin-top:8px;"></div>
        <div id="casePortalReview" style="display:none; margin-top:10px; border:1px solid #30363d; border-radius:8px; padding:10px;">
            <h3 style="margin-top:0;">Portal Submission Review</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="portalReviewCase">Case</label>
                    <input id="portalReviewCase" readonly>
                </div>
                <div class="form-group">
                    <label for="portalReviewAgency">Agency</label>
                    <input id="portalReviewAgency" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="portalReviewUrl">Portal URL</label>
                    <input id="portalReviewUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="portalReviewProvider">Portal Provider (optional)</label>
                    <input id="portalReviewProvider" placeholder="GovQA / NextRequest / etc">
                </div>
            </div>
            <div class="form-group">
                <label for="portalReviewInstructions">Instructions sent to Skyvern</label>
                <textarea id="portalReviewInstructions" placeholder="What to submit in the portal..."></textarea>
            </div>
            <div class="form-group">
                <label for="portalReviewResearch">Case Research Snapshot (read-only)</label>
                <textarea id="portalReviewResearch" readonly></textarea>
            </div>
            <div class="form-group">
                <label for="portalReviewRawDetails">Raw Case Text For AI/Skyvern (read-only)</label>
                <textarea id="portalReviewRawDetails" readonly></textarea>
            </div>
            <div class="proposal-actions">
                <button class="send-btn" onclick="confirmPortalSubmission()">Confirm + Submit Portal</button>
                <button class="drawer-btn" onclick="hidePortalReview()">Cancel</button>
            </div>
        </div>
        <h3>Correspondence</h3>
        <div id="caseInspectorMessages" class="case-list"></div>
        <h3 style="margin-top:10px;">Runs</h3>
        <div id="caseInspectorRuns" class="case-list"></div>
        <h3 style="margin-top:10px;">Proposal History</h3>
        <div id="caseInspectorProposals" class="case-list"></div>
    </div>

    <div id="outbound" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Sent</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Case</th>
                    </tr>
                </thead>
                <tbody id="outboundMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="activity" class="panel">
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Description</th>
                        <th>Case</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityLog"></tbody>
            </table>
        </div>
    </div>

    <div id="phonecalls" class="panel">
        <p style="color: #f0883e; margin-bottom: 15px;">
            Cases requiring a phone call — no email response, details too complex for email, portal failures, or clarification needed.
        </p>
        <div style="margin-bottom:10px;display:flex;gap:8px;align-items:center;">
            <select id="phoneCallFilter" onchange="loadPhoneCalls()" style="padding:6px 10px;background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;font-size:12px;">
                <option value="">Pending + Claimed</option>
                <option value="pending">Pending Only</option>
                <option value="claimed">Claimed Only</option>
                <option value="completed">Completed</option>
                <option value="skipped">Skipped</option>
            </select>
            <span id="phoneCallCount" style="color:#8b949e;font-size:12px;"></span>
        </div>
        <div id="phoneCallCards" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>

    <!-- Phone Call Detail Drawer -->
    <div id="phoneDrawerBackdrop" class="drawer-backdrop" onclick="closePhoneDrawer()"></div>
    <div id="phoneDrawer" class="drawer" style="width:520px;">
        <div class="drawer-header">
            <div class="drawer-title" id="phoneDrawerTitle">Call Details</div>
            <button class="drawer-close" onclick="closePhoneDrawer()">Close</button>
        </div>

        <!-- Section 1: Header -->
        <div class="drawer-section" style="padding-bottom:10px;">
            <div id="pdPhone" style="font-size:22px;font-weight:700;margin-bottom:4px;"></div>
            <div style="font-size:14px;color:#c9d1d9;"><span id="pdAgency" style="font-weight:600;">-</span> <span id="pdState" style="color:#8b949e;font-size:12px;"></span></div>
            <div id="pdCaseName" style="margin-top:4px;font-size:13px;"></div>
        </div>

        <!-- Section 2: Call Justification (prominent) -->
        <div class="drawer-section" id="pdJustificationSection" style="border:1px solid #f0883e;border-radius:8px;padding:10px 12px;margin:0 0 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div class="drawer-label" style="color:#f0883e;margin:0;font-weight:600;">Why This Call Is Needed</div>
                <button class="drawer-btn" id="pdBriefingBtn" onclick="generateBriefing(true)" style="font-size:10px;padding:2px 8px;color:#8b949e;">Regenerate</button>
            </div>
            <div id="pdBriefingLoading" style="display:none;text-align:center;padding:8px 0;color:#8b949e;">
                <span style="display:inline-block;animation:spin 1s linear infinite;margin-right:6px;">&#9696;</span> Generating briefing...
            </div>
            <div id="pdJustificationText" style="font-size:13px;line-height:1.5;color:#c9d1d9;"></div>
        </div>

        <!-- Section 3: Briefing (collapsible) -->
        <div class="drawer-section" id="pdBriefingSection" style="display:none;">
            <div onclick="toggleBriefingDetails()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                <div class="drawer-label" style="margin:0;">Briefing Details</div>
                <span id="pdBriefingToggleIcon" style="color:#8b949e;font-size:11px;">&#9660; Show</span>
            </div>
            <div id="pdBriefingContent" style="display:none;margin-top:8px;">
                <div style="margin-bottom:8px;">
                    <div class="drawer-label" style="color:#3fb950;">Talking Points</div>
                    <ul id="pdBriefingTalkingPoints" style="font-size:12px;line-height:1.6;color:#c9d1d9;margin:0;padding-left:18px;"></ul>
                </div>
                <div style="margin-bottom:8px;">
                    <div class="drawer-label" style="color:#8b949e;">Key Details</div>
                    <div id="pdBriefingKeyDetails" style="font-size:12px;line-height:1.5;color:#c9d1d9;background:#161b22;padding:8px;border-radius:6px;border:1px solid #30363d;white-space:pre-wrap;"></div>
                </div>
                <div>
                    <div class="drawer-label" style="color:#58a6ff;">Case Summary</div>
                    <div id="pdBriefingSummary" style="font-size:12px;line-height:1.5;color:#c9d1d9;background:#161b22;padding:8px;border-radius:6px;border:1px solid #30363d;"></div>
                </div>
            </div>
        </div>

        <!-- Section 4: Quick Reference (compact grid, only populated fields) -->
        <div class="drawer-section" id="pdQuickRef">
            <div class="drawer-label" style="margin-bottom:6px;">Quick Reference</div>
            <div id="pdQuickRefGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;font-size:12px;"></div>
        </div>

        <!-- Section 5: Phone Options (compact) -->
        <div id="pdPhoneOptions" style="display:none;" class="drawer-section">
            <div class="drawer-label" style="margin-bottom:6px;">Phone Options</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div id="pdPhoneOptionNotion" onclick="selectPhoneOption('notion')" style="background:#161b22;border:2px solid #30363d;border-radius:6px;padding:8px;cursor:pointer;transition:border-color 0.15s;">
                    <div style="font-size:10px;color:#8b949e;margin-bottom:2px;font-weight:600;">Notion PD Card</div>
                    <div id="pdNotionPhone" style="font-size:14px;font-weight:700;color:#c9d1d9;margin-bottom:4px;">-</div>
                    <a id="pdNotionLink" href="#" target="_blank" onclick="event.stopPropagation();" style="font-size:10px;color:#58a6ff;text-decoration:none;display:none;">View PD Card &rarr;</a>
                </div>
                <div id="pdPhoneOptionWeb" onclick="selectPhoneOption('web_search')" style="background:#161b22;border:2px solid #30363d;border-radius:6px;padding:8px;cursor:pointer;transition:border-color 0.15s;">
                    <div style="font-size:10px;color:#8b949e;margin-bottom:2px;font-weight:600;">Web Search</div>
                    <div id="pdWebPhone" style="font-size:14px;font-weight:700;color:#c9d1d9;margin-bottom:4px;">-</div>
                    <div id="pdWebReasoning" style="font-size:10px;color:#8b949e;line-height:1.3;display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Section 6: Full Details (collapsible, hidden by default) -->
        <div class="drawer-section" id="pdDetailsSection">
            <div onclick="toggleFullDetails()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                <div class="drawer-label" style="margin:0;">Full Details</div>
                <span id="pdDetailsToggleIcon" style="color:#8b949e;font-size:11px;">&#9660; Show</span>
            </div>
            <div id="pdDetailsContent" style="display:none;margin-top:8px;">
                <div class="drawer-label">Request Details</div>
                <div class="drawer-value" id="pdDetails" style="white-space:pre-wrap;max-height:150px;overflow-y:auto;background:#161b22;padding:8px;border-radius:6px;border:1px solid #30363d;font-size:12px;">-</div>
                <div class="drawer-label" style="margin-top:8px;">Escalation Notes</div>
                <div class="drawer-value" id="pdNotes" style="white-space:pre-wrap;font-size:12px;">-</div>
                <div id="pdCallNotes" style="display:none;margin-top:8px;">
                    <div class="drawer-label">Previous Call Notes</div>
                    <div class="drawer-value" id="pdCallNotesText" style="font-size:12px;">-</div>
                </div>
            </div>
        </div>

        <!-- Section 7: Actions -->
        <div class="drawer-section" id="pdActions">
            <div id="pdClaimForm" style="display:none;">
                <div class="drawer-label">Claim This Call</div>
                <input class="drawer-input" id="pdClaimName" placeholder="Your name" style="margin-bottom:8px;" />
                <button class="drawer-btn primary" onclick="doClaimPhoneCall()" style="width:100%;">Claim This Call</button>
            </div>
            <div id="pdCompleteForm" style="display:none;">
                <div class="drawer-label">Mark Complete</div>
                <select class="drawer-input" id="pdOutcome" style="margin-bottom:8px;">
                    <option value="">Select outcome...</option>
                    <option value="connected">Connected - Spoke with someone</option>
                    <option value="voicemail">Voicemail - Left message</option>
                    <option value="no_answer">No Answer</option>
                    <option value="wrong_number">Wrong Number</option>
                    <option value="transferred">Transferred to correct dept</option>
                    <option value="resolved">Resolved - Got what we needed</option>
                </select>
                <textarea class="drawer-textarea" id="pdCompleteNotes" placeholder="Call notes — what happened, who you spoke with, next steps..." style="margin-bottom:8px;min-height:70px;"></textarea>
                <button class="drawer-btn primary" onclick="doCompletePhoneCall()" style="width:100%;">Mark Complete</button>
            </div>
            <div id="pdSkipForm" style="display:none;">
                <div class="drawer-label" style="margin-top:12px;">Skip This Call</div>
                <textarea class="drawer-textarea" id="pdSkipReason" placeholder="Reason for skipping (optional)..." style="margin-bottom:8px;min-height:50px;"></textarea>
                <button class="drawer-btn warn" onclick="doSkipPhoneCall()" style="width:100%;">Skip</button>
            </div>
            <div id="pdStatusDisplay" style="display:none;">
                <div class="drawer-label">Status</div>
                <div class="drawer-value" id="pdStatusText">-</div>
            </div>
        </div>
        <div id="pdActionResult" class="send-result" style="display:none;margin-top:8px;"></div>
    </div>

    <div id="unmatched" class="panel">
        <p style="color: #f0883e; margin-bottom: 15px;">
            These emails arrived but couldn't be matched to any case (sender email didn't match any agency_email).
        </p>
        <div class="scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Received</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Body Preview</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="unmatchedMessages"></tbody>
            </table>
        </div>
    </div>

    <div id="caseMatchModal" class="drawer-backdrop" style="display:none;" onclick="closeMatchModal(event)">
        <div class="drawer" style="right:auto;left:50%;transform:translateX(-50%);width:min(760px,95vw);max-height:80vh;" onclick="event.stopPropagation()">
            <div class="drawer-header">
                <div class="drawer-title">Match Message To Case</div>
                <button class="drawer-close" onclick="closeMatchModal()">Close</button>
            </div>
            <div class="drawer-section">
                <div class="drawer-label">Message</div>
                <div class="drawer-value" id="matchModalMessage">-</div>
                <div class="drawer-label" style="margin-top:8px;">Search Cases</div>
                <input class="drawer-input" id="matchModalSearch" placeholder="Search by case name, subject, agency, or ID" oninput="renderMatchCaseOptions()" />
                <div class="drawer-label" style="margin-top:8px;">Select Case</div>
                <div id="matchModalCaseList" class="case-list" style="max-height:280px; overflow:auto;"></div>
                <div class="drawer-actions" style="margin-top:10px;">
                    <button class="drawer-btn primary" id="matchModalConfirm" onclick="confirmMatchModal()" disabled>Confirm Match</button>
                    <button class="drawer-btn" onclick="closeMatchModal()">Cancel</button>
                </div>
                <div id="matchModalResult" class="send-result" style="display:none; margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <!-- Message Drawer -->
    <div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
    <div id="messageDrawer" class="drawer">
        <div class="drawer-header">
            <div class="drawer-title">Message Details</div>
            <button class="drawer-close" onclick="closeDrawer()">Close</button>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">Subject</div>
            <div class="drawer-value" id="drawerSubject">-</div>
            <div class="drawer-label" style="margin-top:8px;">Message ID</div>
            <div class="drawer-value" id="drawerMessageId">-</div>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">From</div>
            <div class="drawer-value" id="drawerFrom">-</div>
            <div class="drawer-label" style="margin-top:8px;">To</div>
            <div class="drawer-value" id="drawerTo">-</div>
            <div class="drawer-label" style="margin-top:8px;">Direction</div>
            <div class="drawer-value" id="drawerDirection">-</div>
            <div class="drawer-label" style="margin-top:8px;">Case</div>
            <div class="drawer-value" id="drawerCase">-</div>
            <div class="drawer-label" style="margin-top:8px;">Routing Profile</div>
            <div class="drawer-value" id="drawerRoutingProfile">-</div>
            <div class="drawer-label" style="margin-top:8px;">Received/Sent</div>
            <div class="drawer-value" id="drawerTimestamp">-</div>
            <div class="drawer-label" style="margin-top:8px;">Source</div>
            <div class="drawer-value" id="drawerSource">-</div>
            <div class="drawer-label" style="margin-top:8px;">Message Type</div>
            <div class="drawer-value" id="drawerMessageType">-</div>
            <div class="drawer-label" style="margin-top:8px;">Processed At</div>
            <div class="drawer-value" id="drawerProcessedAt">-</div>
            <div class="drawer-label" style="margin-top:8px;">Processed Run</div>
            <div class="drawer-value" id="drawerProcessedRun">-</div>
        </div>

        <div class="drawer-section">
            <div class="drawer-label">Body</div>
            <div class="drawer-body" id="drawerBody">-</div>
        </div>

        <div class="drawer-section" id="replySection" style="display:none;">
            <div class="drawer-label">Reply</div>
            <input class="drawer-input" id="replySubject" placeholder="Subject" />
            <textarea class="drawer-textarea" id="replyBody" placeholder="Type your reply..."></textarea>
            <div class="drawer-actions">
                <button class="drawer-btn primary" id="replySendBtn" onclick="sendReply()">Send Reply</button>
            </div>
            <div id="replyResult" class="send-result" style="margin-top:8px;"></div>
        </div>

        <div class="drawer-section" id="proposalSection" style="display:none;">
            <div class="drawer-label">Proposals</div>
            <div id="proposalList"></div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
            });
        });

        function openCasesPanel() {
            const tab = document.querySelector('.tab[data-panel="cases"]');
            const panel = document.getElementById('cases');
            if (!tab || !panel) return;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            panel.classList.add('active');
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Format timestamp
        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        // Format relative time
        function relativeTime(ts) {
            if (!ts) return '-';
            const now = new Date();
            const then = new Date(ts);
            const diff = (now - then) / 1000;
            if (diff < 60) return Math.floor(diff) + 's ago';
            if (diff < 3600) return Math.floor(diff/60) + 'm ago';
            if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
            return Math.floor(diff/86400) + 'd ago';
        }

        // Truncate text
        function truncate(text, len = 50) {
            if (!text) return '-';
            return text.length > len ? text.slice(0, len) + '...' : text;
        }

        // Format proposal reasoning from JSON steps into readable text
        function formatReasoning(reasoning) {
            if (!reasoning) return '';
            if (typeof reasoning === 'string') return reasoning;
            if (Array.isArray(reasoning)) {
                return reasoning.map(r => r.detail || r.step || (typeof r === 'string' ? r : '')).filter(Boolean).join(' · ');
            }
            if (reasoning.summary) return reasoning.summary;
            if (reasoning.text) return reasoning.text;
            if (reasoning.step) return reasoning.detail || reasoning.step;
            return '';
        }

        // Badge for direction
        function directionBadge(dir) {
            return `<span class="badge ${dir}">${dir}</span>`;
        }

        function getRoutingProfile(data) {
            const hasPortal = !!data?.portal_url;
            const hasEmail = !!data?.agency_email;
            if (hasPortal && hasEmail) return 'HYBRID';
            if (hasPortal) return 'PORTAL';
            if (hasEmail) return 'EMAIL';
            return 'UNKNOWN';
        }

        function routeBadgeForRecord(data) {
            const profile = getRoutingProfile(data);
            if (profile === 'HYBRID') return '<span class="badge route-hybrid">HYBRID</span>';
            if (profile === 'PORTAL') return '<span class="badge route-portal">PORTAL</span>';
            if (profile === 'EMAIL') return '<span class="badge route-email">EMAIL</span>';
            return '<span class="badge route-none">NONE</span>';
        }

        function contactIndicator(data) {
            const hasPortal = !!data?.portal_url;
            const hasEmail = !!data?.agency_email;
            if (hasPortal && hasEmail) return '<span class="contact-indicator has-both">P+E</span>';
            if (hasPortal) return '<span class="contact-indicator has-portal">P</span>';
            if (hasEmail) return '<span class="contact-indicator has-email">E</span>';
            return '<span class="contact-indicator">-</span>';
        }

        // Badge for event type
        function eventBadge(type) {
            const cls = type.includes('error') ? 'error' :
                       type.includes('webhook') || type.includes('ingest') ? 'webhook' :
                       type.includes('agent') ? 'agent' : 'inbound';
            return `<span class="badge ${cls}">${type}</span>`;
        }

        let caseCache = [];

        // Load all data
        async function loadData() {
            try {
                const [monitorRes, inboundRes, unmatchedRes, liveRes, casesRes] = await Promise.all([
                    fetch('/api/monitor?limit=100'),
                    fetch('/api/monitor/inbound?limit=100'),
                    fetch('/api/monitor/unmatched?limit=50'),
                    fetch('/api/monitor/live-overview?limit=25'),
                    fetch('/api/monitor/cases?limit=300')
                ]);

                const monitor = await monitorRes.json();
                const inboundData = await inboundRes.json();
                const unmatchedData = await unmatchedRes.json();
                const live = await liveRes.json();
                const casesData = await casesRes.json();

                // Update stats
                document.getElementById('totalMessages').textContent = monitor.summary.total_messages;
                document.getElementById('inboundCount').textContent = monitor.summary.inbound_count;
                document.getElementById('outboundCount').textContent = monitor.summary.outbound_count;
                document.getElementById('queueGen').textContent =
                    (monitor.queue.generation.waiting || 0) + (monitor.queue.generation.active || 0);
                document.getElementById('queueEmail').textContent =
                    (monitor.queue.email.waiting || 0) + (monitor.queue.email.active || 0);

                // All messages
                document.getElementById('allMessages').innerHTML = monitor.inbound.concat(monitor.outbound)
                    .sort((a, b) => new Date(b.received_at || b.sent_at || b.created_at) - new Date(a.received_at || a.sent_at || a.created_at))
                    .slice(0, 100)
                    .map(m => `
                        <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                            <td class="timestamp">${relativeTime(m.received_at || m.sent_at || m.created_at)}</td>
                            <td>${directionBadge(m.direction)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 60)}</td>
                            <td>${m.case_id ? `<a class="case-link" href="#" onclick="openCase(${m.case_id});return false;">#${m.case_id}</a> ${routeBadgeForRecord(m)}` : '-'}</td>
                        </tr>
                    `).join('');

                // Inbound with analysis
                document.getElementById('inboundMessages').innerHTML = inboundData.inbound.map(m => `
                    <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                        <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                        <td>${truncate(m.from_email, 30)}</td>
                        <td class="email-subject">${truncate(m.subject, 50)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="#" onclick="openCase(${m.case_id});return false;">${truncate(m.case_name, 30)}</a> ${routeBadgeForRecord(m)}` : '<span style="color:#f85149">UNMATCHED</span>'}</td>
                        <td>${m.intent ? `<span class="badge">${m.intent}</span>` : '-'}</td>
                        <td>${m.suggested_action || '-'}</td>
                    </tr>
                `).join('');

                // Outbound
                document.getElementById('outboundMessages').innerHTML = monitor.outbound.map(m => `
                    <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                        <td class="timestamp">${relativeTime(m.sent_at || m.created_at)}</td>
                        <td>${truncate(m.to_email, 35)}</td>
                        <td class="email-subject">${truncate(m.subject, 60)}</td>
                        <td>${m.case_id ? `<a class="case-link" href="#" onclick="openCase(${m.case_id});return false;">#${m.case_id}</a> ${routeBadgeForRecord(m)}` : '-'}</td>
                    </tr>
                `).join('');

                // Activity log
                document.getElementById('activityLog').innerHTML = monitor.activity.map(a => `
                    <tr>
                        <td class="timestamp">${relativeTime(a.created_at)}</td>
                        <td>${eventBadge(a.event_type)}</td>
                        <td>${truncate(a.description, 50)}</td>
                        <td>${a.case_id ? `<a class="case-link" href="#" onclick="openCase(${a.case_id});return false;">#${a.case_id}</a>` : '-'}</td>
                        <td class="expandable" onclick="this.innerHTML = this.innerHTML.includes('...') ? JSON.stringify(${JSON.stringify(a.metadata).replace(/"/g, '&quot;')}, null, 2) : '${truncate(JSON.stringify(a.metadata), 30)}'">${truncate(JSON.stringify(a.metadata), 30)}</td>
                    </tr>
                `).join('');

                // Unmatched
                document.getElementById('unmatchedMessages').innerHTML = unmatchedData.unmatched.length ?
                    unmatchedData.unmatched.map(m => `
                        <tr class="clickable-row" data-message-id="${m.id}" onclick="openMessage(${m.id})">
                            <td class="timestamp">${relativeTime(m.received_at || m.created_at)}</td>
                            <td>${truncate(m.from_email, 30)}</td>
                            <td>${truncate(m.to_email, 30)}</td>
                            <td class="email-subject">${truncate(m.subject, 40)}</td>
                            <td class="email-body">${truncate(m.body_text, 50)}</td>
                            <td><button class="drawer-btn" onclick="event.stopPropagation();openMatchModal(${m.id});">Match to Case</button></td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="6" style="text-align:center;color:#8b949e">No unmatched emails</td></tr>';

                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                renderLiveOverview(live);
                renderCases(casesData);
                loadPhoneCalls();

            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        // =========================================================================
        // Phone Call Queue
        // =========================================================================
        let phoneCallCache = [];
        let activePhoneCallId = null;

        async function loadPhoneCalls() {
            try {
                const filter = document.getElementById('phoneCallFilter')?.value || '';
                const url = filter ? `/api/phone-calls?status=${filter}&limit=100` : '/api/phone-calls?limit=100';
                const res = await fetch(url);
                const data = await res.json();

                if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

                // Update stat box and badge
                const pendingCount = data.stats?.pending || 0;
                document.getElementById('phoneQueueCount').textContent = pendingCount;
                const badge = document.getElementById('phoneCallBadge');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }

                phoneCallCache = data.tasks || [];
                const cardsEl = document.getElementById('phoneCallCards');
                const countEl = document.getElementById('phoneCallCount');
                countEl.textContent = phoneCallCache.length > 0 ? `${phoneCallCache.length} call(s)` : '';

                if (phoneCallCache.length === 0) {
                    cardsEl.innerHTML = '<div style="text-align:center;color:#8b949e;padding:30px 0;">No phone call tasks</div>';
                    return;
                }

                cardsEl.innerHTML = phoneCallCache.map(t => {
                    const priorityColor = t.priority >= 2 ? '#f85149' : t.priority === 1 ? '#f0883e' : '#30363d';
                    const statusColor = t.status === 'pending' ? '#f0883e' :
                                       t.status === 'claimed' ? '#58a6ff' :
                                       t.status === 'completed' ? '#3fb950' : '#8b949e';
                    const phone = t.agency_phone || t.agency_phone_from_db;
                    const phoneDisplay = phone
                        ? `<a href="tel:${phone}" style="color:#58a6ff;font-size:16px;font-weight:700;text-decoration:none;" onclick="event.stopPropagation();">${phone}</a>`
                        : `<span style="color:#f85149;font-size:13px;">No phone on file</span>`;

                    const daysText = t.days_since_sent != null ? `${t.days_since_sent}d` : '-';
                    const reasonLabels = {
                        'no_email_response': 'No Response',
                        'details_needed': 'Details Needed',
                        'complex_inquiry': 'Complex Inquiry',
                        'portal_failed': 'Portal Failed',
                        'followup_max_reached': 'Max Follow-ups',
                        'clarification_difficult': 'Clarification Needed'
                    };
                    const reasonLabel = reasonLabels[t.reason] || t.reason || 'Unknown';
                    const reasonColor = t.reason === 'no_email_response' ? '#f0883e' :
                                       t.reason === 'details_needed' || t.reason === 'clarification_difficult' ? '#d2a8ff' :
                                       t.reason === 'portal_failed' ? '#f85149' : '#8b949e';

                    let actionBtns = '';
                    if (t.status === 'pending') {
                        actionBtns = `<button class="drawer-btn primary" onclick="event.stopPropagation();openPhoneDrawer(${t.id})" style="font-size:11px;padding:4px 10px;">Claim</button>`;
                    } else if (t.status === 'claimed') {
                        actionBtns = `<button class="drawer-btn primary" onclick="event.stopPropagation();openPhoneDrawer(${t.id})" style="font-size:11px;padding:4px 10px;">Complete</button>`;
                    }

                    return `<div onclick="openPhoneDrawer(${t.id})" style="display:flex;gap:0;background:#161b22;border:1px solid #30363d;border-radius:8px;cursor:pointer;overflow:hidden;transition:border-color 0.15s;" onmouseover="this.style.borderColor='#58a6ff'" onmouseout="this.style.borderColor='#30363d'">
                        <div style="width:4px;background:${priorityColor};flex-shrink:0;"></div>
                        <div style="flex:1;padding:12px 14px;display:flex;flex-wrap:wrap;align-items:center;gap:6px 16px;">
                            <div style="flex:1;min-width:200px;">
                                <div style="font-size:14px;color:#c9d1d9;font-weight:600;">${t.agency_name || 'Unknown Agency'} <span style="color:#8b949e;font-weight:400;font-size:12px;">${t.agency_state || ''}</span></div>
                                <div style="margin-top:4px;">${phoneDisplay}</div>
                                <div style="margin-top:4px;font-size:12px;color:#8b949e;">
                                    <a class="case-link" href="#" onclick="event.stopPropagation();openCase(${t.case_id});return false;" style="color:#58a6ff;">#${t.case_id}</a>
                                    ${t.case_name || ''}
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
                                <span style="background:#21262d;color:${reasonColor};padding:2px 8px;border-radius:10px;font-size:11px;" title="${t.reason}">${reasonLabel}</span>
                                <span style="background:#21262d;color:#c9d1d9;padding:2px 8px;border-radius:10px;font-size:11px;" title="Days waiting">${daysText}</span>
                                <span style="color:${statusColor};font-weight:600;font-size:12px;">${t.status}</span>
                                ${t.assigned_to ? `<span style="color:#8b949e;font-size:11px;">${t.assigned_to}</span>` : ''}
                                ${actionBtns}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (err) {
                console.error('Failed to load phone calls:', err);
                document.getElementById('phoneCallCards').innerHTML =
                    '<div style="text-align:center;color:#f85149;padding:20px 0;">Failed to load phone calls</div>';
            }
        }

        function openPhoneDrawer(id) {
            const t = phoneCallCache.find(x => x.id === id);
            if (!t) return;
            activePhoneCallId = id;

            const phone = t.agency_phone || t.agency_phone_from_db;
            document.getElementById('phoneDrawerTitle').textContent = `Call #${t.id}`;

            // Section 1: Header
            const pdPhone = document.getElementById('pdPhone');
            if (phone) {
                pdPhone.innerHTML = `<a href="tel:${phone}" style="color:#58a6ff;text-decoration:none;">${phone}</a>`;
            } else {
                pdPhone.innerHTML = `<span style="color:#f85149;">No phone on file</span>`;
            }
            document.getElementById('pdAgency').textContent = t.agency_name || '-';
            document.getElementById('pdState').textContent = t.agency_state || t.state || '';
            document.getElementById('pdCaseName').innerHTML = `<a class="case-link" href="#" onclick="openCase(${t.case_id});closePhoneDrawer();return false;" style="color:#58a6ff;">#${t.case_id}</a> ${t.case_name || ''}`;

            // Section 2: Justification + briefing
            document.getElementById('pdBriefingLoading').style.display = 'none';
            document.getElementById('pdJustificationText').textContent = '';
            document.getElementById('pdBriefingSection').style.display = 'none';
            document.getElementById('pdBriefingContent').style.display = 'none';
            document.getElementById('pdBriefingBtn').disabled = false;

            if (t.ai_briefing) {
                renderBriefing(t.ai_briefing);
            } else {
                // Auto-trigger briefing generation
                document.getElementById('pdJustificationText').textContent = '';
                document.getElementById('pdBriefingLoading').style.display = 'block';
                generateBriefing(false);
            }

            // Section 4: Quick Reference (only populated fields)
            const refItems = [];
            if (t.contact_name) refItems.push(['Contact', t.contact_name]);
            if (t.agency_email) refItems.push(['Email', t.agency_email]);
            if (t.days_since_sent != null) refItems.push(['Days Waiting', `${t.days_since_sent} days`]);
            if (t.reason) refItems.push(['Escalation', (t.reason || '').replace(/_/g, ' ')]);
            if (t.send_date) refItems.push(['Sent Date', new Date(t.send_date).toLocaleDateString()]);
            document.getElementById('pdQuickRefGrid').innerHTML = refItems.map(([label, val]) =>
                `<div style="color:#8b949e;">${label}</div><div style="color:#c9d1d9;">${val}</div>`
            ).join('');
            document.getElementById('pdQuickRef').style.display = refItems.length ? 'block' : 'none';

            // Section 5: Phone Options
            const phoneOptionsEl = document.getElementById('pdPhoneOptions');
            const opts = t.phone_options;
            if (opts && (opts.notion?.phone || opts.web_search?.phone)) {
                phoneOptionsEl.style.display = 'block';

                const notionPhoneEl = document.getElementById('pdNotionPhone');
                const notionLinkEl = document.getElementById('pdNotionLink');
                if (opts.notion?.phone) {
                    notionPhoneEl.innerHTML = `<a href="tel:${opts.notion.phone}" style="color:#c9d1d9;text-decoration:none;" onclick="event.stopPropagation();">${opts.notion.phone}</a>`;
                } else {
                    notionPhoneEl.textContent = 'Not found';
                    notionPhoneEl.style.color = '#8b949e';
                }
                if (opts.notion?.pd_page_url) {
                    notionLinkEl.href = opts.notion.pd_page_url;
                    notionLinkEl.style.display = 'inline';
                } else if (opts.notion?.pd_page_id) {
                    notionLinkEl.href = `https://www.notion.so/${opts.notion.pd_page_id.replace(/-/g, '')}`;
                    notionLinkEl.style.display = 'inline';
                } else {
                    notionLinkEl.style.display = 'none';
                }

                const webPhoneEl = document.getElementById('pdWebPhone');
                const webReasoningEl = document.getElementById('pdWebReasoning');
                if (opts.web_search?.phone) {
                    webPhoneEl.innerHTML = `<a href="tel:${opts.web_search.phone}" style="color:#c9d1d9;text-decoration:none;" onclick="event.stopPropagation();">${opts.web_search.phone}</a>`;
                } else {
                    webPhoneEl.textContent = 'Not found';
                    webPhoneEl.style.color = '#8b949e';
                }
                if (opts.web_search?.reasoning) {
                    webReasoningEl.textContent = opts.web_search.reasoning;
                    webReasoningEl.style.display = 'block';
                } else {
                    webReasoningEl.style.display = 'none';
                }

                highlightSelectedPhoneOption(phone, opts);
            } else {
                phoneOptionsEl.style.display = 'none';
            }

            // Section 6: Full Details (collapsed)
            document.getElementById('pdDetailsContent').style.display = 'none';
            document.getElementById('pdDetailsToggleIcon').innerHTML = '&#9660; Show';
            document.getElementById('pdDetails').textContent = t.additional_details || 'No details available';
            document.getElementById('pdNotes').textContent = t.notes || 'No escalation notes';
            if (t.call_notes) {
                document.getElementById('pdCallNotes').style.display = 'block';
                document.getElementById('pdCallNotesText').textContent = t.call_notes;
            } else {
                document.getElementById('pdCallNotes').style.display = 'none';
            }

            // Section 7: Actions
            document.getElementById('pdClaimForm').style.display = 'none';
            document.getElementById('pdCompleteForm').style.display = 'none';
            document.getElementById('pdSkipForm').style.display = 'none';
            document.getElementById('pdStatusDisplay').style.display = 'none';
            document.getElementById('pdActionResult').style.display = 'none';

            if (t.status === 'pending') {
                document.getElementById('pdClaimForm').style.display = 'block';
                document.getElementById('pdSkipForm').style.display = 'block';
                document.getElementById('pdClaimName').value = '';
            } else if (t.status === 'claimed') {
                document.getElementById('pdCompleteForm').style.display = 'block';
                document.getElementById('pdSkipForm').style.display = 'block';
                document.getElementById('pdOutcome').value = '';
                document.getElementById('pdCompleteNotes').value = '';
                document.getElementById('pdSkipReason').value = '';
            } else {
                document.getElementById('pdStatusDisplay').style.display = 'block';
                const statusColor = t.status === 'completed' ? '#3fb950' : '#8b949e';
                document.getElementById('pdStatusText').innerHTML = `<span style="color:${statusColor};font-weight:600;">${t.status}</span>${t.call_outcome ? ` - ${t.call_outcome}` : ''}${t.completed_by ? ` (by ${t.completed_by})` : ''}`;
            }

            // Show drawer
            document.getElementById('phoneDrawerBackdrop').classList.add('active');
            document.getElementById('phoneDrawer').classList.add('active');
        }

        function closePhoneDrawer() {
            document.getElementById('phoneDrawerBackdrop').classList.remove('active');
            document.getElementById('phoneDrawer').classList.remove('active');
            activePhoneCallId = null;
        }

        function showPhoneActionResult(msg, isError) {
            const el = document.getElementById('pdActionResult');
            el.style.display = 'block';
            el.style.color = isError ? '#f85149' : '#3fb950';
            el.textContent = msg;
        }

        async function doClaimPhoneCall() {
            const name = document.getElementById('pdClaimName').value.trim();
            if (!name) { showPhoneActionResult('Please enter your name', true); return; }
            try {
                const res = await fetch(`/api/phone-calls/${activePhoneCallId}/claim`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignedTo: name })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                showPhoneActionResult('Claimed successfully!', false);
                setTimeout(() => { closePhoneDrawer(); loadPhoneCalls(); }, 600);
            } catch (err) {
                showPhoneActionResult('Failed to claim: ' + err.message, true);
            }
        }

        async function doCompletePhoneCall() {
            const outcome = document.getElementById('pdOutcome').value;
            if (!outcome) { showPhoneActionResult('Please select an outcome', true); return; }
            const notes = document.getElementById('pdCompleteNotes').value.trim();
            const t = phoneCallCache.find(x => x.id === activePhoneCallId);
            const completedBy = t?.assigned_to || 'unknown';
            try {
                const res = await fetch(`/api/phone-calls/${activePhoneCallId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ outcome, notes, completedBy })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                showPhoneActionResult('Marked complete!', false);
                setTimeout(() => { closePhoneDrawer(); loadPhoneCalls(); }, 600);
            } catch (err) {
                showPhoneActionResult('Failed to complete: ' + err.message, true);
            }
        }

        async function doSkipPhoneCall() {
            const notes = document.getElementById('pdSkipReason').value.trim();
            try {
                const res = await fetch(`/api/phone-calls/${activePhoneCallId}/skip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                showPhoneActionResult('Skipped', false);
                setTimeout(() => { closePhoneDrawer(); loadPhoneCalls(); }, 600);
            } catch (err) {
                showPhoneActionResult('Failed to skip: ' + err.message, true);
            }
        }

        function renderBriefing(briefing) {
            // Justification (always visible in prominent section)
            document.getElementById('pdJustificationText').textContent = briefing.call_justification || 'No justification available';
            document.getElementById('pdBriefingLoading').style.display = 'none';

            // Briefing details (collapsible)
            document.getElementById('pdBriefingSummary').textContent = briefing.case_summary || '';
            const tpEl = document.getElementById('pdBriefingTalkingPoints');
            tpEl.innerHTML = (briefing.talking_points || []).map(p => `<li>${p}</li>`).join('');
            const kd = briefing.key_details;
            let kdText = '';
            if (kd) {
                if (kd.dates) kdText += `Dates: incident ${kd.dates.incident_date || '?'}, sent ${kd.dates.request_sent || '?'}, waiting ${kd.dates.days_waiting || '?'} days\n`;
                if (kd.records_requested) kdText += `Records: ${kd.records_requested.join(', ')}\n`;
                if (kd.previous_responses?.length) kdText += `Responses: ${kd.previous_responses.join('; ')}\n`;
                if (kd.amounts) kdText += `Amounts: ${JSON.stringify(kd.amounts)}`;
            }
            document.getElementById('pdBriefingKeyDetails').textContent = kdText.trim() || 'None';
            document.getElementById('pdBriefingSection').style.display = 'block';
            document.getElementById('pdBriefingContent').style.display = 'none';
            document.getElementById('pdBriefingToggleIcon').innerHTML = '&#9660; Show';
            document.getElementById('pdBriefingBtn').textContent = 'Regenerate';
        }

        function toggleBriefingDetails() {
            const content = document.getElementById('pdBriefingContent');
            const icon = document.getElementById('pdBriefingToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.innerHTML = '&#9650; Hide';
            } else {
                content.style.display = 'none';
                icon.innerHTML = '&#9660; Show';
            }
        }

        function toggleFullDetails() {
            const content = document.getElementById('pdDetailsContent');
            const icon = document.getElementById('pdDetailsToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.innerHTML = '&#9650; Hide';
            } else {
                content.style.display = 'none';
                icon.innerHTML = '&#9660; Show';
            }
        }

        async function generateBriefing(force) {
            document.getElementById('pdBriefingContent').style.display = 'none';
            document.getElementById('pdBriefingSection').style.display = 'none';
            document.getElementById('pdBriefingLoading').style.display = 'block';
            document.getElementById('pdJustificationText').textContent = '';
            document.getElementById('pdBriefingBtn').disabled = true;
            try {
                const res = await fetch(`/api/phone-calls/${activePhoneCallId}/briefing?force=${force}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                renderBriefing(data.briefing);
                const t = phoneCallCache.find(x => x.id === activePhoneCallId);
                if (t) t.ai_briefing = data.briefing;
            } catch (err) {
                document.getElementById('pdBriefingLoading').style.display = 'none';
                document.getElementById('pdJustificationText').textContent = 'Failed to generate briefing';
                document.getElementById('pdJustificationText').style.color = '#f85149';
                showPhoneActionResult('Briefing failed: ' + err.message, true);
            } finally {
                document.getElementById('pdBriefingBtn').disabled = false;
            }
        }

        function highlightSelectedPhoneOption(currentPhone, opts) {
            const notionCard = document.getElementById('pdPhoneOptionNotion');
            const webCard = document.getElementById('pdPhoneOptionWeb');
            const isNotion = opts.notion?.phone && currentPhone === opts.notion.phone;
            const isWeb = opts.web_search?.phone && currentPhone === opts.web_search.phone;
            notionCard.style.borderColor = isNotion ? '#3fb950' : '#30363d';
            webCard.style.borderColor = isWeb ? '#3fb950' : '#30363d';
        }

        async function selectPhoneOption(source) {
            const t = phoneCallCache.find(x => x.id === activePhoneCallId);
            if (!t || !t.phone_options) return;
            const opts = t.phone_options;
            const phone = source === 'notion' ? opts.notion?.phone : opts.web_search?.phone;
            if (!phone) return;

            try {
                const res = await fetch(`/api/phone-calls/${activePhoneCallId}/select-phone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, source })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                // Update local cache and UI
                t.agency_phone = phone;
                const pdPhone = document.getElementById('pdPhone');
                pdPhone.innerHTML = `<a href="tel:${phone}" style="color:#58a6ff;text-decoration:none;">${phone}</a>`;
                highlightSelectedPhoneOption(phone, opts);
            } catch (err) {
                showPhoneActionResult('Failed to select phone: ' + err.message, true);
            }
        }

        let lastCasesJson = '';
        function renderCases(payload) {
            const rowsEl = document.getElementById('caseRows');

            // Skip rebuild if data hasn't changed (prevents click race condition)
            const newJson = JSON.stringify(payload?.cases?.map(c => c.id + ':' + c.status + ':' + c.updated_at) || []);
            if (newJson === lastCasesJson && expandedCaseId) return;
            lastCasesJson = newJson;

            // Detach inspector before rebuilding so innerHTML doesn't destroy it
            const inspector = document.getElementById('caseInspector');
            const wasExpanded = expandedCaseId;
            if (inspector && inspector.parentElement) {
                inspector.style.display = 'none';
                document.body.appendChild(inspector);
            }

            if (!payload || !payload.success) {
                rowsEl.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#f85149">Failed to load cases</td></tr>';
                expandedCaseId = null;
                return;
            }
            caseCache = payload.cases || [];
            if (!caseCache.length) {
                rowsEl.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#8b949e">No cases found</td></tr>';
                expandedCaseId = null;
                return;
            }

            rowsEl.innerHTML = caseCache.map(c => `
                <tr class="clickable-row" data-case-id="${c.id}" onclick="toggleCase(${c.id})">
                    <td class="timestamp">${relativeTime(c.updated_at)}</td>
                    <td><a class="case-link" href="#" onclick="event.stopPropagation();toggleCase(${c.id});return false;">#${c.id}</a> ${truncate(c.case_name, 40)}</td>
                    <td>${truncate(c.agency_name, 30)}</td>
                    <td>${contactIndicator(c)}</td>
                    <td>${truncate(c.status || '-', 24)}</td>
                    <td>${c.pending_approvals || 0}</td>
                    <td>${c.total_messages || 0} (in ${c.inbound_messages || 0} / out ${c.outbound_messages || 0})</td>
                    <td>${c.active_run_id ? `#${c.active_run_id} ${c.active_run_status}` : '-'}</td>
                </tr>
            `).join('');

            // Re-expand the previously open case after rebuild
            if (wasExpanded) {
                const clickedRow = document.querySelector(`tr[data-case-id="${wasExpanded}"]`);
                if (clickedRow) {
                    clickedRow.classList.add('expanded');
                    const expandedRow = document.createElement('tr');
                    expandedRow.className = 'case-expanded-row';
                    const td = document.createElement('td');
                    td.colSpan = 8;
                    td.style.padding = '0';
                    td.appendChild(inspector);
                    expandedRow.appendChild(td);
                    clickedRow.after(expandedRow);
                    inspector.style.display = 'block';
                    expandedCaseId = wasExpanded;
                } else {
                    // Case no longer in list
                    expandedCaseId = null;
                }
            }
        }

        function renderOpsList(listId, items, renderer) {
            const el = document.getElementById(listId);
            if (!el) return;
            if (!items || items.length === 0) {
                el.innerHTML = '<div class="timestamp">None</div>';
                return;
            }
            el.innerHTML = items.map(renderer).join('');
        }

        function renderLiveOverview(payload) {
            if (!payload || !payload.success) return;
            const s = payload.summary || {};
            document.getElementById('opsInbound24h').textContent = s.inbound_24h ?? 0;
            document.getElementById('opsPendingApprovals').textContent = s.pending_approvals_total ?? 0;
            document.getElementById('opsUnmatchedInbound').textContent = s.unmatched_inbound_total ?? 0;
            document.getElementById('opsActiveRuns').textContent = s.active_runs_total ?? 0;
            document.getElementById('opsStuckRuns').textContent = s.stuck_runs_total ?? 0;

            renderOpsList('opsPendingList', payload.pending_approvals, (p) => {
                const hasPortal = p.portal_url && !p.portal_url.startsWith('http://') || (p.portal_url && p.portal_url.includes('portal'));
                const actionLabel = String(p.action_type || '').replace(/_/g, ' ');
                const caseStatus = String(p.case_status || '').replace(/_/g, ' ');
                const msgSummary = p.inbound_count > 0
                    ? `${p.inbound_count} inbound msg${p.inbound_count > 1 ? 's' : ''}`
                    : 'No responses yet';
                const lastMsg = p.last_inbound_preview
                    ? truncate(String(p.last_inbound_preview).replace(/\s+/g, ' '), 100)
                    : '';
                const lastSubj = p.last_inbound_subject ? truncate(String(p.last_inbound_subject), 50) : '';
                const reasoning = truncate(formatReasoning(p.reasoning), 120);
                return `
                <div class="ops-item" style="padding:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div>
                            <a href="#" onclick="openCase(${p.case_id});return false;" style="color:#58a6ff;font-weight:600;">Case #${p.case_id || '-'}</a>
                            <span style="color:#c9d1d9;font-size:12px;margin-left:4px;">${truncate(p.case_name || '', 35)}</span>
                        </div>
                        <span style="font-size:11px;color:#8b949e;">${relativeTime(p.created_at)}</span>
                    </div>
                    <div style="margin-top:4px;">
                        <span class="badge agent" style="font-size:10px;">${actionLabel}</span>
                        ${p.agency_name ? `<span style="color:#8b949e;font-size:11px;margin-left:6px;">${truncate(p.agency_name, 30)}</span>` : ''}
                        <span style="color:#8b949e;font-size:11px;margin-left:6px;">${caseStatus}</span>
                    </div>
                    ${reasoning ? `<div style="margin-top:4px;font-size:11px;color:#d2a8ff;line-height:1.4;">${reasoning}</div>` : ''}
                    <div style="margin-top:4px;font-size:11px;color:#8b949e;">
                        ${msgSummary}${p.message_count > 0 ? ` (${p.message_count} total)` : ''}
                        ${lastSubj ? ` · Last: "${lastSubj}"` : ''}
                    </div>
                    ${lastMsg ? `<div style="margin-top:3px;font-size:11px;color:#6e7681;font-style:italic;line-height:1.3;max-height:32px;overflow:hidden;">${lastMsg}</div>` : ''}
                    <div style="margin-top:6px;display:flex;gap:6px;">
                        <button class="drawer-btn primary" onclick="openPendingApproval(${p.id}, ${p.trigger_message_id || 'null'}, ${p.case_id || 'null'})">Open</button>
                        <button class="drawer-btn" onclick="approveProposal(${p.id})">Approve</button>
                        <button class="drawer-btn" onclick="dismissProposal(${p.id})" style="color:#f85149;">Dismiss</button>
                    </div>
                </div>`;
            });

            renderOpsList('opsUnmatchedList', payload.unmatched_inbound, (m) => `
                <div class="ops-item">
                    <div><a href="#" onclick="openMessage(${m.id});return false;">Message #${m.id}</a> · ${truncate(m.from_email, 36)}</div>
                    <div>${truncate(m.subject, 70)} · ${relativeTime(m.received_at || m.created_at)}</div>
                    <div style="margin-top:4px;">
                        <button class="drawer-btn" onclick="openMatchModal(${m.id})">Match to Case</button>
                    </div>
                </div>
            `);

        }

        async function openPendingApproval(proposalId, triggerMessageId, caseId) {
            if (caseId) {
                await openCase(caseId);
                return;
            }
            if (triggerMessageId) {
                await openMessage(triggerMessageId);
                return;
            }
            alert(`Proposal #${proposalId} missing case linkage.`);
        }

        async function triggerAIFromOps(messageId) {
            try {
                const res = await fetch('/api/monitor/trigger-inbound-run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId, force_new_run: false })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || `Failed (${res.status})`);
                await loadData();
            } catch (err) {
                alert(`Failed to trigger AI: ${err.message || err}`);
            }
        }

        async function openMatchModal(messageId) {
            matchModalMessageId = messageId;
            matchModalSelectedCaseId = null;
            document.getElementById('matchModalSearch').value = '';
            document.getElementById('matchModalMessage').textContent = `Message #${messageId}`;
            document.getElementById('matchModalConfirm').disabled = true;
            document.getElementById('matchModalResult').style.display = 'none';
            renderMatchCaseOptions();
            const modal = document.getElementById('caseMatchModal');
            modal.style.display = 'block';
            modal.classList.add('active');
        }

        function closeMatchModal(event) {
            if (event && event.target && event.target.id !== 'caseMatchModal') return;
            const modal = document.getElementById('caseMatchModal');
            modal.classList.remove('active');
            modal.style.display = 'none';
            matchModalMessageId = null;
            matchModalSelectedCaseId = null;
        }

        function renderMatchCaseOptions() {
            const listEl = document.getElementById('matchModalCaseList');
            if (!listEl) return;
            const q = (document.getElementById('matchModalSearch').value || '').trim().toLowerCase();
            const cases = (caseCache || [])
                .filter(c => {
                    if (!q) return true;
                    const hay = [
                        String(c.id || ''),
                        c.case_name || '',
                        c.subject_name || '',
                        c.agency_name || '',
                        c.status || ''
                    ].join(' ').toLowerCase();
                    return hay.includes(q);
                })
                .slice(0, 120);

            if (!cases.length) {
                listEl.innerHTML = '<div class="timestamp">No matching cases</div>';
                return;
            }

            listEl.innerHTML = cases.map(c => `
                <div class="case-list-item" style="cursor:pointer; border:${matchModalSelectedCaseId === c.id ? '1px solid #58a6ff' : '1px solid transparent'};" onclick="selectMatchCase(${c.id})">
                    <div><strong>#${c.id}</strong> ${truncate(c.case_name, 90)}</div>
                    <div>${truncate(c.agency_name || '-', 60)} · ${c.status || '-'} · ${getRoutingProfile(c)}</div>
                </div>
            `).join('');
        }

        function selectMatchCase(caseId) {
            matchModalSelectedCaseId = caseId;
            document.getElementById('matchModalConfirm').disabled = false;
            renderMatchCaseOptions();
        }

        async function confirmMatchModal() {
            const resultEl = document.getElementById('matchModalResult');
            if (!matchModalMessageId || !matchModalSelectedCaseId) return;
            resultEl.style.display = 'none';
            try {
                const res = await fetch(`/api/monitor/message/${matchModalMessageId}/match-case`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ case_id: matchModalSelectedCaseId })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || `Failed (${res.status})`);

                resultEl.className = 'send-result success';
                resultEl.textContent = `Matched Message #${matchModalMessageId} to Case #${matchModalSelectedCaseId}`;
                resultEl.style.display = 'block';
                await loadData();
                await openMessage(matchModalMessageId);
                closeMatchModal();
            } catch (err) {
                resultEl.className = 'send-result error';
                resultEl.textContent = `Failed to match message: ${err.message || err}`;
                resultEl.style.display = 'block';
            }
        }

        // Load runtime config
        async function loadConfig() {
            try {
                const res = await fetch('/api/monitor/config');
                const config = await res.json();
                document.getElementById('runtimeMode').textContent = `Execution: ${config.execution_mode || 'LIVE'}`;
                document.getElementById('shadowMode').textContent = `Shadow: ${config.shadow_mode ? 'ON' : 'OFF'}`;
                const queueGen = (config.queue?.generation?.waiting || 0) + (config.queue?.generation?.active || 0);
                const queueEmail = (config.queue?.email?.waiting || 0) + (config.queue?.email?.active || 0);
                document.getElementById('queueBadge').textContent = `Queue G:${queueGen} E:${queueEmail}`;
            } catch (err) {
                console.error('Config load failed:', err);
            }
        }

        // Import: step 1 — import from Notion, show details for confirmation
        let pendingImportCaseId = null;
        async function importNotionCase() {
            const notionUrl = document.getElementById('notionUrlInput').value.trim();
            const resultDiv = document.getElementById('notionImportResult');
            const confirmPanel = document.getElementById('importConfirmPanel');
            confirmPanel.style.display = 'none';
            if (!notionUrl) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Notion URL is required.';
                resultDiv.style.display = 'block';
                return;
            }

            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.textContent = 'Importing...';
            resultDiv.style.display = 'none';

            try {
                const importRes = await fetch('/api/cases/import-notion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notion_url: notionUrl, refresh_existing: true })
                });
                const importData = await importRes.json();
                if (!importRes.ok || !importData.success) {
                    throw new Error(importData.error || `Import failed (${importRes.status})`);
                }

                const caseId = importData.case_id || importData.case?.id;
                if (!caseId) throw new Error('No case_id returned');

                pendingImportCaseId = caseId;
                const c = importData.case || {};
                const hasPortal = !!c.portal_url;
                const hasEmail = !!c.agency_email;
                const routing = hasPortal && hasEmail ? 'HYBRID' : hasPortal ? 'PORTAL' : hasEmail ? 'EMAIL' : 'UNKNOWN';

                document.getElementById('importConfirmDetails').innerHTML = `
                    <div style="margin-bottom:6px;"><strong>Case #${caseId}</strong> ${c.case_name || ''}</div>
                    <div>Agency: ${c.agency_name || '-'} | State: ${c.state || '-'}</div>
                    <div>Routing: <strong>${routing}</strong>${hasPortal ? ` | Portal: ${truncate(c.portal_url, 40)}` : ''}${hasEmail ? ` | Email: ${c.agency_email}` : ''}</div>
                    <div style="margin-top:4px;color:#8b949e;">Click <strong>Confirm & Send</strong> to queue the initial request.</div>
                `;
                confirmPanel.style.display = 'block';
                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Imported case #${caseId}. Review details below and confirm to send.`;
                resultDiv.style.display = 'block';
                await loadData();
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Notion import failed';
                resultDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Import';
            }
        }

        // Import: step 2 — confirm and queue initial request
        async function confirmImportSend() {
            if (!pendingImportCaseId) return;
            const autopilotMode = document.getElementById('initialRouteMode').value;
            const resultDiv = document.getElementById('notionImportResult');
            const confirmPanel = document.getElementById('importConfirmPanel');

            try {
                const runRes = await fetch(`/api/cases/${pendingImportCaseId}/run-initial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autopilotMode })
                });
                const runData = await runRes.json();
                if (!runRes.ok || !runData.success) {
                    throw new Error(runData.error || `Initial run failed (${runRes.status})`);
                }

                confirmPanel.style.display = 'none';
                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Case #${pendingImportCaseId} queued (${autopilotMode}). Run #${runData.run?.id || '-'}`;
                resultDiv.style.display = 'block';
                pendingImportCaseId = null;
                document.getElementById('notionUrlInput').value = '';
                await loadData();
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Failed to queue initial request';
                resultDiv.style.display = 'block';
            }
        }

        function cancelImportConfirm() {
            document.getElementById('importConfirmPanel').style.display = 'none';
            pendingImportCaseId = null;
        }

        let currentMessage = null;
        let currentRunId = null;
        let currentCaseData = null;
        let latestCasePortalTasks = [];
        let currentCaseMessages = [];
        let currentCaseProposals = [];
        let matchModalMessageId = null;
        let matchModalSelectedCaseId = null;
        let portalLinkPollTimer = null;
        let runPollTimer = null;
        let aiLogLines = [];

        function appendLog(line) {
            aiLogLines.push(`[${new Date().toLocaleTimeString()}] ${line}`);
            const logEl = document.getElementById('aiLog');
            if (logEl) {
                logEl.textContent = aiLogLines.slice(-200).join('\n');
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        function resetLog() {
            aiLogLines = [];
            const logEl = document.getElementById('aiLog');
            if (logEl) logEl.textContent = '';
        }

        async function openMessage(id) {
            try {
                const res = await fetch(`/api/monitor/message/${id}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to load message');

                currentMessage = data.message;
                document.getElementById('drawerSubject').textContent = data.message.subject || '-';
                document.getElementById('drawerMessageId').textContent = data.message.id || '-';
                document.getElementById('drawerFrom').textContent = data.message.from_email || '-';
                document.getElementById('drawerTo').textContent = data.message.to_email || '-';
                document.getElementById('drawerDirection').textContent = data.message.direction || '-';
                document.getElementById('drawerTimestamp').textContent = formatTime(data.message.received_at || data.message.sent_at || data.message.created_at);
                document.getElementById('drawerBody').textContent = data.message.body_text || data.message.body_html || '-';
                document.getElementById('drawerSource').textContent = data.source || '-';
                document.getElementById('drawerMessageType').textContent = data.message.message_type || '-';
                document.getElementById('drawerProcessedAt').textContent = formatTime(data.message.processed_at);
                document.getElementById('drawerProcessedRun').textContent = data.message.processed_run_id || '-';

                if (data.case) {
                    document.getElementById('drawerCase').innerHTML = `<a class="case-link" href="#" onclick="openCase(${data.case.id});return false;">#${data.case.id} ${truncate(data.case.case_name || '', 30)}</a>`;
                    const routeProfile = getRoutingProfile(data.case);
                    const latestRoute = data.case.latest_initial_route_mode || 'not set';
                    document.getElementById('drawerRoutingProfile').textContent = `${routeProfile} | latest initial route: ${latestRoute}`;
                } else {
                    document.getElementById('drawerCase').textContent = 'Unmatched';
                    document.getElementById('drawerRoutingProfile').textContent = '-';
                }

                const isInbound = data.message.direction === 'inbound';
                document.getElementById('replySection').style.display = isInbound ? 'block' : 'none';
                document.getElementById('proposalSection').style.display = data.case ? 'block' : 'none';

                document.getElementById('replySubject').value = `Re: ${data.message.subject || ''}`.trim();
                document.getElementById('replyBody').value = '';
                document.getElementById('replyResult').style.display = 'none';
                resetLog();
                currentRunId = null;
                await loadProposals(id);

                document.getElementById('drawerBackdrop').classList.add('active');
                document.getElementById('messageDrawer').classList.add('active');
            } catch (err) {
                console.error(err);
            }
        }

        let expandedCaseId = null;

        function toggleCase(caseId) {
            if (expandedCaseId === caseId) {
                collapseCase();
            } else {
                openCase(caseId);
            }
        }

        function collapseCase() {
            const existing = document.querySelector('.case-expanded-row');
            if (existing) existing.remove();
            document.querySelectorAll('.clickable-row.expanded').forEach(r => r.classList.remove('expanded'));
            const inspector = document.getElementById('caseInspector');
            inspector.style.display = 'none';
            document.body.appendChild(inspector); // park it back in body
            expandedCaseId = null;
        }

        async function openCase(caseId) {
            // Switch to Cases tab so the table is visible
            openCasesPanel();

            // Collapse any previously expanded row
            collapseCase();

            const inspector = document.getElementById('caseInspector');
            const title = document.getElementById('caseInspectorTitle');
            const grid = document.getElementById('caseInspectorGrid');
            const msgList = document.getElementById('caseInspectorMessages');
            const runList = document.getElementById('caseInspectorRuns');
            const proposalList = document.getElementById('caseInspectorProposals');
            const proposalCards = document.getElementById('caseInspectorProposalCards');
            const actions = document.getElementById('caseInspectorActions');
            const actionResult = document.getElementById('caseInspectorActionResult');
            const reviewPanel = document.getElementById('casePortalReview');
            const portalInfoPanel = document.getElementById('casePortalInfoPanel');

            // Insert inspector as expanded row under the clicked case
            const clickedRow = document.querySelector(`tr[data-case-id="${caseId}"]`);
            if (clickedRow) {
                clickedRow.classList.add('expanded');
                const expandedRow = document.createElement('tr');
                expandedRow.className = 'case-expanded-row';
                const td = document.createElement('td');
                td.colSpan = 8;
                td.style.padding = '0';
                td.appendChild(inspector);
                expandedRow.appendChild(td);
                clickedRow.after(expandedRow);
            }

            inspector.style.display = 'block';
            expandedCaseId = caseId;
            title.textContent = `Case #${caseId}`;
            grid.innerHTML = '<div class="cell">Loading...</div>';
            msgList.innerHTML = '<div class="timestamp">Loading...</div>';
            runList.innerHTML = '<div class="timestamp">Loading...</div>';
            proposalList.innerHTML = '<div class="timestamp">Loading...</div>';
            proposalCards.innerHTML = '';
            actions.innerHTML = '';
            actionResult.style.display = 'none';
            reviewPanel.style.display = 'none';
            portalInfoPanel.style.display = 'none';
            currentCaseData = null;
            latestCasePortalTasks = [];
            currentCaseMessages = [];
            currentCaseProposals = [];
            if (portalLinkPollTimer) {
                clearInterval(portalLinkPollTimer);
                portalLinkPollTimer = null;
            }

            try {
                const res = await fetch(`/api/monitor/case/${caseId}`);
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || `Failed to load case (${res.status})`);

                const c = data.case;
                currentCaseData = c;
                latestCasePortalTasks = data.portal_tasks || [];
                currentCaseMessages = data.messages || [];
                currentCaseProposals = data.proposals || [];
                title.textContent = `Case #${c.id} ${truncate(c.case_name || '', 70)}`;
                grid.innerHTML = `
                    <div class="cell"><span class="k">Status</span>${c.status || '-'}</div>
                    <div class="cell"><span class="k">Substatus</span>${truncate(c.substatus || '-', 80)}</div>
                    <div class="cell"><span class="k">Agency</span>${truncate(c.agency_name || '-', 60)}</div>
                    <div class="cell"><span class="k">Agency Email</span>${c.agency_email || '-'}</div>
                    <div class="cell"><span class="k">Autopilot</span>${c.autopilot_mode || '-'}</div>
                    <div class="cell"><span class="k">Updated</span>${formatTime(c.updated_at)}</div>
                    <div class="cell"><span class="k">Notion</span>${c.notion_page_id ? `<a class="case-link" href="https://www.notion.so/${c.notion_page_id.replace(/-/g, '')}" target="_blank">open card</a>` : '-'}</div>
                `;

                // Portal Info panel
                if (c.portal_url) {
                    const pa = data.portal_account;
                    let portalHtml = `<h3 style="margin-top:0;color:#58a6ff;">Portal Info</h3><div class="case-grid">`;
                    portalHtml += `<div class="cell"><span class="k">Portal URL</span><a class="case-link" href="${c.portal_url}" target="_blank">${truncate(c.portal_url, 50)}</a></div>`;
                    portalHtml += `<div class="cell"><span class="k">Provider</span>${c.portal_provider || '-'}</div>`;
                    portalHtml += `<div class="cell"><span class="k">Account Email</span>${pa?.email || '-'}</div>`;
                    portalHtml += `<div class="cell"><span class="k">Account Password</span>${pa?.password ? `<span id="portalPwDisplay">${pa.password}</span> <button onclick="navigator.clipboard.writeText('${pa.password.replace(/'/g, "\\'")}').then(()=>{this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1500)})" style="margin-left:6px;padding:2px 8px;font-size:11px;cursor:pointer;background:#21262d;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;">Copy</button>` : '-'}</div>`;
                    portalHtml += `<div class="cell"><span class="k">Request Number</span>${c.portal_request_number || '-'}</div>`;
                    portalHtml += `<div class="cell"><span class="k">Last Status</span>${c.last_portal_status || '-'}${c.last_portal_status_at ? ` <span class="timestamp">(${formatTime(c.last_portal_status_at)})</span>` : ''}</div>`;
                    portalHtml += `</div>`;
                    // Quick link buttons
                    let links = '';
                    if (c.portal_url) links += `<a href="${c.portal_url}" target="_blank" style="display:inline-block;margin:4px 6px 0 0;padding:4px 10px;font-size:12px;background:#21262d;color:#58a6ff;border:1px solid #30363d;border-radius:4px;text-decoration:none;">Open Portal</a>`;
                    if (c.last_portal_task_url) links += `<a href="${c.last_portal_task_url}" target="_blank" style="display:inline-block;margin:4px 6px 0 0;padding:4px 10px;font-size:12px;background:#21262d;color:#58a6ff;border:1px solid #30363d;border-radius:4px;text-decoration:none;">Skyvern Task</a>`;
                    if (links) portalHtml += `<div style="margin-top:6px;">${links}</div>`;
                    portalInfoPanel.innerHTML = portalHtml;
                    portalInfoPanel.style.display = 'block';
                } else {
                    portalInfoPanel.style.display = 'none';
                    portalInfoPanel.innerHTML = '';
                }

                // Render pending proposal action cards
                const proposals = data.proposals || [];
                const pendingProposals = proposals.filter(p => p.status === 'PENDING_APPROVAL');
                const otherProposals = proposals.filter(p => p.status !== 'PENDING_APPROVAL');

                proposalCards.innerHTML = renderProposalCards(proposals, c);

                // Build review actions as secondary Quick Actions
                const isNeedsReview = c.requires_human || c.status === 'needs_human_review';
                let actionsHtml = '';

                if (isNeedsReview || pendingProposals.length === 0) {
                    if (isNeedsReview) {
                        const label = pendingProposals.length > 0 ? 'Quick Actions' : 'Review Actions';
                        actionsHtml += `<div class="${pendingProposals.length > 0 ? 'quick-actions-section' : ''}">`;
                        if (pendingProposals.length > 0) {
                            actionsHtml += `<div class="quick-actions-label">${label}</div>`;
                        }
                        actionsHtml += buildReviewActions(c);
                        actionsHtml += `</div>`;
                    }
                }

                if (!actionsHtml && pendingProposals.length === 0) {
                    actionsHtml = `<span class="timestamp">No actions available for this case.</span>`;
                }

                // Add "Find PD Contact" button
                actionsHtml += `<button class="btn-pd-contact" id="btn-pd-lookup-${c.id}" onclick="triggerPDContactLookup(${c.id}, this)">Find PD Contact</button>`;

                actions.innerHTML = actionsHtml;

                // Correspondence with inline expansion
                const messages = data.messages || [];
                let msgHtml = '';

                // AI Case Summary
                const latestAnalysis = findLatestAnalysisSummary(messages, c);
                if (latestAnalysis) {
                    msgHtml += `<div class="ai-case-summary">
                        <div class="summary-label">AI Case Summary</div>
                        <div class="summary-text">${escapeHtml(latestAnalysis)}</div>
                    </div>`;
                }

                msgHtml += messages.length
                    ? messages.map(m => `
                        <div class="case-list-item">
                            <div>${directionBadge(m.direction)} <a class="case-link" href="#" onclick="openMessage(${m.id});return false;">Message #${m.id}</a> · ${relativeTime(m.received_at || m.sent_at || m.created_at)}</div>
                            <div>${truncate(m.subject || '-', 120)}</div>
                        </div>
                    `).join('')
                    : '<div class="timestamp">No correspondence yet</div>';
                msgList.innerHTML = msgHtml;

                const runs = data.runs || [];
                runList.innerHTML = runs.length
                    ? runs.map(r => `
                        <div class="case-list-item">
                            <div><a class="case-link" href="/api/runs/${r.id}" target="_blank">Run #${r.id}</a> · ${r.trigger_type} · ${r.status}</div>
                            <div>${formatTime(r.started_at)}${r.ended_at ? ` -> ${formatTime(r.ended_at)}` : ''}</div>
                        </div>
                    `).join('')
                    : '<div class="timestamp">No runs yet</div>';

                // Only show non-pending proposals in the minimal list
                proposalList.innerHTML = otherProposals.length
                    ? otherProposals.map(p => `
                        <div class="case-list-item">
                            <div><a class="case-link" href="/api/proposals/${p.id}" target="_blank">Proposal #${p.id}</a> · ${p.action_type} · ${p.status}</div>
                            <div>${truncate(p.draft_subject || '-', 110)}</div>
                        </div>
                    `).join('')
                    : '<div class="timestamp">No past proposals</div>';
            } catch (error) {
                grid.innerHTML = `<div class="cell">Error: ${error.message || error}</div>`;
                msgList.innerHTML = '<div class="timestamp">-</div>';
                runList.innerHTML = '<div class="timestamp">-</div>';
                proposalList.innerHTML = '<div class="timestamp">-</div>';
                proposalCards.innerHTML = '';
                actions.innerHTML = '';
                actionResult.style.display = 'none';
            }
        }

        function showPortalReview(caseId) {
            const panel = document.getElementById('casePortalReview');
            const c = currentCaseData;
            if (!c || c.id !== caseId) return;

            let draftInstructions = buildPortalInstructions(c, currentCaseProposals, currentCaseMessages);
            const latestTask = latestCasePortalTasks.find(t => t.status !== 'COMPLETED') || latestCasePortalTasks[0];
            if (latestTask?.instructions) {
                draftInstructions = latestTask.instructions;
            }

            document.getElementById('portalReviewCase').value = `#${c.id} ${c.case_name || ''}`.trim();
            document.getElementById('portalReviewAgency').value = c.agency_name || '';
            document.getElementById('portalReviewUrl').value = c.portal_url || '';
            document.getElementById('portalReviewProvider').value = c.portal_provider || '';
            document.getElementById('portalReviewInstructions').value = draftInstructions;
            document.getElementById('portalReviewResearch').value = buildCaseResearchSnapshot(c);
            document.getElementById('portalReviewRawDetails').value = (c.additional_details || '').trim();
            panel.style.display = 'block';
        }

        function hidePortalReview() {
            document.getElementById('casePortalReview').style.display = 'none';
        }

        // =====================================================================
        // Human Review Actions
        // =====================================================================

        function detectReviewReason(c) {
            const sub = (c.substatus || '').toLowerCase();
            const status = (c.status || '').toLowerCase();
            if (sub.includes('portal') && (sub.includes('fail') || sub.includes('error'))) return 'PORTAL_FAILED';
            if (status === 'error' && c.portal_url) return 'PORTAL_FAILED';
            if (sub.includes('portal')) return 'PORTAL_FAILED';
            if (sub.includes('fee') || sub.includes('quote') || sub.includes('cost')) return 'FEE_QUOTE';
            if (c.last_fee_quote_amount) return 'FEE_QUOTE';
            if (sub.includes('denial') || sub.includes('denied') || sub.includes('reject')) return 'DENIAL';
            if (sub.includes('clarif') || sub.includes('question') || sub.includes('details needed') || sub.includes('more info')) return 'CLARIFICATION';
            if (sub.includes('missing') || sub.includes('contact') || sub.includes('info needed')) return 'MISSING_INFO';
            if (status === 'needs_contact_info') return 'MISSING_INFO';
            return 'GENERAL';
        }

        const REVIEW_ACTIONS = {
            PORTAL_FAILED: [
                { id: 'retry_portal', label: 'Retry Portal', primary: true },
                { id: 'send_via_email', label: 'Send via Email' },
                { id: 'submit_manually', label: 'Submit Manually (opens portal)' },
                { id: 'call_agency', label: 'Call Agency' },
                { id: 'put_on_hold', label: 'Put on Hold' },
            ],
            FEE_QUOTE: [
                { id: 'accept_fee', label: 'Accept & Proceed', primary: true },
                { id: 'negotiate_fee', label: 'Negotiate Fee' },
                { id: 'call_agency', label: 'Call Agency' },
                { id: 'close', label: 'Decline & Close' },
                { id: 'put_on_hold', label: 'Put on Hold' },
            ],
            DENIAL: [
                { id: 'appeal', label: 'Appeal Denial', primary: true },
                { id: 'narrow_scope', label: 'Narrow Scope & Retry' },
                { id: 'call_agency', label: 'Call Agency' },
                { id: 'close', label: 'Close Request' },
                { id: 'put_on_hold', label: 'Put on Hold' },
            ],
            CLARIFICATION: [
                { id: 'narrow_scope', label: 'Reply via Email', primary: true },
                { id: 'call_agency', label: 'Call Agency' },
                { id: 'custom', label: 'Custom Response' },
                { id: 'put_on_hold', label: 'Put on Hold' },
            ],
            MISSING_INFO: [
                { id: 'reprocess', label: 'Re-process', primary: true },
                { id: 'call_agency', label: 'Call Agency' },
                { id: 'put_on_hold', label: 'Put on Hold' },
                { id: 'close', label: 'Skip / Close' },
            ],
            GENERAL: [
                { id: 'reprocess', label: 'Re-process', primary: true },
                { id: 'call_agency', label: 'Call Agency' },
                { id: 'put_on_hold', label: 'Put on Hold' },
                { id: 'close', label: 'Close Request' },
            ],
        };

        const REVIEW_LABELS = {
            PORTAL_FAILED: 'Portal Failed',
            FEE_QUOTE: 'Fee Quote',
            DENIAL: 'Denial',
            CLARIFICATION: 'Clarification Needed',
            MISSING_INFO: 'Missing Info',
            GENERAL: 'Needs Review',
        };

        function buildReviewActions(c) {
            const reason = detectReviewReason(c);
            const actions = REVIEW_ACTIONS[reason] || REVIEW_ACTIONS.GENERAL;
            const label = REVIEW_LABELS[reason] || 'Needs Review';

            let html = `<div style="margin-bottom:8px;">
                <span style="display:inline-block;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:600;background:#30363d;color:#f0883e;margin-bottom:6px;">${label}</span>
                ${c.substatus ? `<div style="font-size:11px;color:#8b949e;margin-bottom:6px;">Context: ${c.substatus}</div>` : ''}
            </div>`;

            html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;">`;
            for (const action of actions) {
                const style = action.primary
                    ? 'background:#1f6feb;color:white;'
                    : 'background:#21262d;color:#c9d1d9;border:1px solid #30363d;';
                html += `<button onclick="resolveReview(${c.id},'${action.id}')" style="padding:6px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;${style}">${action.label}</button>`;
            }
            html += `</div>`;

            html += `<div style="margin-top:6px;">
                <input id="reviewInstruction_${c.id}" type="text" placeholder="Custom instruction (optional)" style="width:100%;padding:6px 10px;background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;font-size:12px;box-sizing:border-box;">
                <button onclick="resolveReview(${c.id},'custom',document.getElementById('reviewInstruction_${c.id}').value)" style="margin-top:4px;padding:5px 12px;background:#21262d;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;cursor:pointer;font-size:11px;">Send Custom Instruction</button>
            </div>`;

            return html;
        }

        async function resolveReview(caseId, action, instruction) {
            const actionResult = document.getElementById('caseInspectorActionResult');

            // For retry_portal, open the portal review panel instead of immediately resolving
            if (action === 'retry_portal' && currentCaseData?.portal_url) {
                showPortalReview(caseId);
                return;
            }

            // For submit_manually, also open the portal URL
            if (action === 'submit_manually' && currentCaseData?.portal_url) {
                window.open(currentCaseData.portal_url, '_blank');
            }

            try {
                actionResult.style.display = 'block';
                actionResult.className = 'send-result';
                actionResult.textContent = `Resolving: ${action}...`;

                const res = await fetch(`/api/requests/${caseId}/resolve-review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, instruction: instruction || undefined })
                });
                const data = await res.json();

                if (!res.ok || !data.success) throw new Error(data.error || 'Failed');

                actionResult.className = 'send-result success';
                actionResult.textContent = `✓ ${data.message}${data.job_id ? ` (job: ${data.job_id})` : ''}`;

                // Refresh case after a moment
                setTimeout(() => openCase(caseId), 1500);
            } catch (err) {
                actionResult.style.display = 'block';
                actionResult.className = 'send-result error';
                actionResult.textContent = `✗ ${err.message}`;
            }
        }

        function buildPortalInstructions(c, proposals, messages) {
            const latestProposal = (proposals || []).find(p => p.draft_body_text);
            if (latestProposal?.draft_body_text) {
                const subject = latestProposal.draft_subject || `Case #${c.id} follow-up`;
                return `Submit this message in the agency portal.\n\nSubject:\n${subject}\n\nBody:\n${latestProposal.draft_body_text}`;
            }

            const latestOutbound = (messages || []).find(m => m.direction === 'outbound' && m.body_text);
            if (latestOutbound?.body_text) {
                return `Submit this public-records request in the agency portal.\n\nSubject:\n${latestOutbound.subject || `Case #${c.id} records request`}\n\nBody:\n${latestOutbound.body_text}`;
            }

            return `Submit public-records request for case #${c.id} (${c.case_name || ''}) to ${c.agency_name || 'agency'} portal.\n\nUse case details below to fill all required portal fields and submit.`;
        }

        function buildCaseResearchSnapshot(c) {
            const records = Array.isArray(c.requested_records) ? c.requested_records.filter(Boolean) : [];
            const details = (c.additional_details || '').trim();
            const detailSnippet = details ? truncate(details.replace(/\s+/g, ' '), 1200) : '-';
            return [
                `Case: #${c.id} ${c.case_name || '-'}`,
                `Subject: ${c.subject_name || '-'}`,
                `Agency: ${c.agency_name || '-'}`,
                `State: ${c.state || '-'}`,
                `Incident Date: ${c.incident_date || '-'}`,
                `Incident Location: ${c.incident_location || '-'}`,
                `Requested Records: ${records.length ? records.join(', ') : '-'}`,
                `Status/Substatus: ${c.status || '-'} / ${c.substatus || '-'}`,
                '',
                'Research:',
                detailSnippet
            ].join('\n');
        }

        async function confirmPortalSubmission() {
            if (!currentCaseData?.id) return;
            const caseId = currentCaseData.id;
            const resultDiv = document.getElementById('caseInspectorActionResult');
            const portalUrl = document.getElementById('portalReviewUrl').value.trim();
            const provider = document.getElementById('portalReviewProvider').value.trim();
            const instructions = document.getElementById('portalReviewInstructions').value.trim();
            const researchContext = document.getElementById('portalReviewRawDetails').value.trim();

            if (!portalUrl) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Portal URL is required.';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.style.display = 'none';
            try {
                const res = await fetch(`/api/monitor/case/${caseId}/trigger-portal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        portal_url: portalUrl,
                        provider: provider || null,
                        instructions: instructions || null,
                        research_context: researchContext || null
                    })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || `Failed (${res.status})`);

                resultDiv.className = 'send-result success';
                resultDiv.innerHTML = `Portal job queued for case #${caseId}. Job: ${data.job_id || '-'}.
                    <div style="margin-top:6px;">Waiting for Skyvern link...</div>`;
                resultDiv.style.display = 'block';
                hidePortalReview();
                await openCase(caseId);
                await loadData();
                startPortalLinkPolling(caseId);
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Portal trigger failed';
                resultDiv.style.display = 'block';
            }
        }

        function startPortalLinkPolling(caseId) {
            const resultDiv = document.getElementById('caseInspectorActionResult');
            if (portalLinkPollTimer) clearInterval(portalLinkPollTimer);
            let attempts = 0;
            portalLinkPollTimer = setInterval(async () => {
                attempts += 1;
                try {
                    const res = await fetch(`/api/monitor/case/${caseId}`);
                    const data = await res.json();
                    if (!res.ok || !data.success) return;
                    const c = data.case || {};
                    const task = c.last_portal_task_url;
                    const recording = c.last_portal_recording_url;
                    if (task || recording) {
                        const parts = [];
                        if (task) parts.push(`<a class="case-link" href="${task}" target="_blank">Skyvern Task</a>`);
                        if (recording) parts.push(`<a class="case-link" href="${recording}" target="_blank">Recording</a>`);
                        resultDiv.className = 'send-result success';
                        resultDiv.innerHTML = `Portal submission started. ${parts.join(' | ')}`;
                        clearInterval(portalLinkPollTimer);
                        portalLinkPollTimer = null;
                        openCase(caseId);
                        return;
                    }
                    if (attempts >= 20) {
                        resultDiv.className = 'send-result';
                        resultDiv.textContent = 'Portal queued. Skyvern link not available yet. Refresh shortly.';
                        clearInterval(portalLinkPollTimer);
                        portalLinkPollTimer = null;
                    }
                } catch (_) {}
            }, 3000);
        }

        async function loadProposals(messageId, runId = null) {
            const list = document.getElementById('proposalList');
            list.innerHTML = '<div class="timestamp">Loading proposals...</div>';

            try {
                let proposals = [];
                let headerNote = '';

                if (runId) {
                    const runRes = await fetch(`/api/runs/${runId}`);
                    const runData = await runRes.json();
                    if (!runData.success) throw new Error(runData.error || 'Failed to load run');
                    proposals = runData.proposals || [];
                    headerNote = `Showing proposals for run #${runId}`;
                } else {
                    const res = await fetch(`/api/monitor/message/${messageId}/proposals`);
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Failed to load proposals');
                    proposals = data.proposals || [];
                    headerNote = 'Showing proposals for this message';
                }

                if (!proposals || proposals.length === 0) {
                    list.innerHTML = `<div class="timestamp">${headerNote}. No proposals yet.</div>`;
                    return;
                }

                list.innerHTML = `<div class="proposal-meta">${headerNote}</div>` + proposals.map(p => {
                    const status = p.status || 'UNKNOWN';
                    const body = truncate(p.draft_body_text || '', 140);
                    const canApprove = status === 'PENDING_APPROVAL';
                    const isInitial = p.action_type === 'SEND_INITIAL_REQUEST';
                    const isHybrid = !!p.portal_url && !!p.agency_email;
                    const showRouteApprove = canApprove && isInitial && isHybrid;
                    let verdict = 'Pending decision';
                    if (p.status === 'EXECUTED') {
                        if (p.outbound_message_id && p.outbound_sendgrid_message_id) {
                            verdict = `Sent live (message #${p.outbound_message_id})`;
                        } else if (p.execution_status === 'FAILED') {
                            verdict = 'Not sent (execution failed)';
                        } else if (p.execution_status === 'SKIPPED') {
                            verdict = 'Not sent (execution skipped)';
                        } else if (p.execution_status === 'QUEUED') {
                            verdict = 'Queued (awaiting send worker)';
                        } else if (p.execution_status === 'SENT' && !p.outbound_message_id) {
                            verdict = 'Sent by executor, awaiting outbound row';
                        } else {
                            verdict = 'Not sent (no outbound evidence)';
                        }
                    }
                    return `
                        <div class="proposal-card">
                            <div class="proposal-title">${p.action_type || 'Action'} #${p.id}</div>
                            <div class="proposal-meta">Status: ${status} · Confidence: ${p.confidence || '-'}</div>
                            <div class="proposal-meta">Execution: ${p.execution_key || '-'} | Email Job: ${p.email_job_id || '-'}</div>
                            <div class="proposal-meta">Execution Status: ${p.execution_status || '-'}</div>
                            <div class="proposal-meta">Routing: ${isHybrid ? 'HYBRID' : (p.portal_url ? 'PORTAL' : (p.agency_email ? 'EMAIL' : 'UNKNOWN'))}</div>
                            <div class="proposal-meta">Send Verdict: ${verdict}</div>
                            <div class="proposal-meta">${body || '-'}</div>
                            <div class="proposal-actions">
                                <button class="drawer-btn primary" ${canApprove ? '' : 'disabled'} onclick="approveProposal(${p.id})">Approve</button>
                                <button class="drawer-btn warn" ${showRouteApprove ? '' : 'disabled'} onclick="approveProposalWithRoute(${p.id}, 'email')">Approve Email</button>
                                <button class="drawer-btn warn" ${showRouteApprove ? '' : 'disabled'} onclick="approveProposalWithRoute(${p.id}, 'portal')">Approve Portal</button>
                                <button class="drawer-btn" ${canApprove ? '' : 'disabled'} onclick="adjustProposal(${p.id})">Adjust</button>
                                <button class="drawer-btn" ${canApprove ? '' : 'disabled'} onclick="dismissProposal(${p.id})">Dismiss</button>
                                <a class="drawer-btn" href="/api/proposals/${p.id}" target="_blank">View</a>
                            </div>
                            <div class="proposal-decision-note">Run: ${p.run_id || '-'} | Trigger Message: ${p.trigger_message_id || '-'}</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                list.innerHTML = `<div class="timestamp">Error loading proposals: ${err.message}</div>`;
            }
        }

        function closeDrawer() {
            document.getElementById('drawerBackdrop').classList.remove('active');
            document.getElementById('messageDrawer').classList.remove('active');
            if (runPollTimer) {
                clearInterval(runPollTimer);
                runPollTimer = null;
            }
        }

        async function sendReply() {
            if (!currentMessage) return;
            const body = document.getElementById('replyBody').value.trim();
            const subject = document.getElementById('replySubject').value.trim();
            const resultDiv = document.getElementById('replyResult');
            const btn = document.getElementById('replySendBtn');

            if (!body) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = 'Reply body is required.';
                resultDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            resultDiv.style.display = 'none';

            try {
                const res = await fetch(`/api/monitor/message/${currentMessage.id}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, body })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to send reply');

                resultDiv.className = 'send-result success';
                resultDiv.textContent = `Reply sent. Message ID: ${data.message_id}`;
                resultDiv.style.display = 'block';
                setTimeout(loadData, 800);
            } catch (err) {
                resultDiv.className = 'send-result error';
                resultDiv.textContent = err.message || 'Failed to send reply';
                resultDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        }

        async function triggerAI() {
            // AI Processing panel removed; trigger via triggerAIFromOps or API directly
            if (!currentMessage) return;
            appendLog('AI trigger not available from this panel');
        }

        async function proposeDecision(proposalId, action, routeMode = null) {
            appendLog(`${action} proposal ${proposalId}${routeMode ? ` (route=${routeMode})` : ''}...`);
            try {
                const payload = { action };
                if (routeMode) payload.route_mode = routeMode;
                if (action === 'ADJUST') {
                    const instruction = prompt('Adjustment instruction:');
                    if (!instruction || !instruction.trim()) {
                        appendLog('Adjust cancelled: instruction required.');
                        return;
                    }
                    payload.instruction = instruction.trim();
                }
                const res = await fetch(`/api/monitor/proposals/${proposalId}/decision`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || `Decision failed (${res.status})`);
                }
                appendLog(`${action} accepted for proposal ${proposalId} (HTTP ${res.status}).`);
                if (data.message) appendLog(`Decision response: ${data.message}`);
                if (data.run?.id) {
                    currentRunId = data.run.id;
                    pollRunStatus(currentRunId);
                }
                if (currentMessage) await loadProposals(currentMessage.id);
                setTimeout(loadData, 1000);
            } catch (err) {
                appendLog(`Decision error: ${err.message || err}`);
            }
        }

        async function approveProposal(proposalId) {
            return proposeDecision(proposalId, 'APPROVE');
        }

        async function approveProposalWithRoute(proposalId, routeMode) {
            return proposeDecision(proposalId, 'APPROVE', routeMode);
        }

        async function adjustProposal(proposalId) {
            return proposeDecision(proposalId, 'ADJUST');
        }

        async function dismissProposal(proposalId) {
            return proposeDecision(proposalId, 'DISMISS');
        }

        function renderProposalCards(proposals, caseData) {
            const pending = (proposals || []).filter(p => p.status === 'PENDING_APPROVAL');
            if (!pending.length) return '';

            let html = `<h3 style="margin-bottom:8px;">Pending Actions</h3>`;
            for (const p of pending) {
                const actionLabel = String(p.action_type || 'action').replace(/_/g, ' ');
                const isInitial = String(p.action_type) === 'SEND_INITIAL_REQUEST';
                const isHybrid = !!p.portal_url && !!p.agency_email;
                const showRouteApprove = isInitial && isHybrid;

                html += `<div class="proposal-action-card" id="pac_${p.id}">`;
                html += `<div class="pac-header">`;
                html += `<span class="pac-badge">${actionLabel}</span>`;
                html += `<span style="font-size:11px;color:#8b949e;">Proposal #${p.id} · Confidence: ${p.confidence || '-'}</span>`;
                html += `</div>`;

                const reasoningText = formatReasoning(p.reasoning);
                if (reasoningText) {
                    html += `<div class="pac-reasoning">${escapeHtml(truncate(reasoningText, 200))}</div>`;
                }

                if (p.draft_subject || p.draft_body_text) {
                    html += `<div class="pac-draft">`;
                    if (p.draft_subject) {
                        html += `<div class="pac-subject">${escapeHtml(p.draft_subject)}</div>`;
                    }
                    if (p.draft_body_text) {
                        html += `<div class="pac-body-preview" id="pac_preview_${p.id}">${escapeHtml(truncate(p.draft_body_text, 200))}</div>`;
                        html += `<div class="pac-body-full" id="pac_full_${p.id}" style="display:none;">${escapeHtml(p.draft_body_text)}</div>`;
                    }
                    html += `</div>`;
                }

                // Action buttons
                html += `<div class="pac-actions">`;
                html += `<button class="drawer-btn primary" onclick="expandProposalCard(${p.id})">Review & Confirm</button>`;
                html += `<button class="drawer-btn" onclick="dismissProposal(${p.id}).then(()=>openCase(${caseData.id}))" style="color:#f85149;">Dismiss</button>`;
                html += `</div>`;

                // Expanded detail (hidden by default)
                html += `<div class="pac-expanded-detail" id="pac_detail_${p.id}" style="display:none;">`;
                if (p.draft_body_text) {
                    html += `<div class="pac-detail-row">Full draft body shown above</div>`;
                }
                if (p.agency_email) {
                    html += `<div class="pac-detail-row">Recipient: ${escapeHtml(p.agency_email)}</div>`;
                }
                if (p.portal_url) {
                    html += `<div class="pac-detail-row">Portal: <a class="case-link" href="${p.portal_url}" target="_blank">${truncate(p.portal_url, 50)}</a></div>`;
                }
                html += `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">`;
                html += `<button class="send-btn" onclick="approveProposal(${p.id}).then(()=>openCase(${caseData.id}))">Approve</button>`;
                if (showRouteApprove) {
                    html += `<button class="drawer-btn warn" onclick="approveProposalWithRoute(${p.id},'email').then(()=>openCase(${caseData.id}))">Approve Email</button>`;
                    html += `<button class="drawer-btn warn" onclick="approveProposalWithRoute(${p.id},'portal').then(()=>openCase(${caseData.id}))">Approve Portal</button>`;
                }
                html += `<button class="drawer-btn" onclick="adjustProposal(${p.id}).then(()=>openCase(${caseData.id}))">Adjust</button>`;
                html += `<button class="drawer-btn" onclick="collapseProposalCard(${p.id})">Cancel</button>`;
                html += `</div>`;
                html += `</div>`; // end pac-expanded-detail

                html += `</div>`; // end proposal-action-card
            }
            return html;
        }

        function expandProposalCard(proposalId) {
            const preview = document.getElementById(`pac_preview_${proposalId}`);
            const full = document.getElementById(`pac_full_${proposalId}`);
            const detail = document.getElementById(`pac_detail_${proposalId}`);
            if (preview) preview.style.display = 'none';
            if (full) full.style.display = 'block';
            if (detail) detail.style.display = 'block';
        }

        function collapseProposalCard(proposalId) {
            const preview = document.getElementById(`pac_preview_${proposalId}`);
            const full = document.getElementById(`pac_full_${proposalId}`);
            const detail = document.getElementById(`pac_detail_${proposalId}`);
            if (preview) preview.style.display = 'block';
            if (full) full.style.display = 'none';
            if (detail) detail.style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function findLatestAnalysisSummary(messages, caseData) {
            // Check case-level analysis summary first
            if (caseData?.analysis?.summary) return caseData.analysis.summary;
            if (caseData?.latest_analysis_summary) return caseData.latest_analysis_summary;

            // Check latest inbound message for analysis
            const inbound = (messages || []).filter(m => m.direction === 'inbound');
            for (const m of inbound) {
                if (m.analysis?.summary) return m.analysis.summary;
                if (m.ai_summary) return m.ai_summary;
            }
            return null;
        }

        async function pollRunStatus(runId) {
            if (!runId) return;
            if (runPollTimer) clearInterval(runPollTimer);

            const terminalStatuses = new Set(['completed', 'paused', 'failed']);
            const runStatusText = document.getElementById('runStatusText');

            const pollOnce = async () => {
                try {
                    const res = await fetch(`/api/runs/${runId}`);
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Run fetch failed');
                    const run = data.run || {};
                    if (runStatusText) runStatusText.textContent = `${run.status || '-'} | node=${run?.metadata?.current_node || '-'} | started=${formatTime(run.started_at)} | ended=${formatTime(run.ended_at)}`;
                    if (terminalStatuses.has(run.status)) {
                        appendLog(`Run ${runId} reached terminal state: ${run.status}`);
                        clearInterval(runPollTimer);
                        runPollTimer = null;
                        if (currentMessage) await loadProposals(currentMessage.id, runId);
                    }
                } catch (error) {
                    appendLog(`Run poll error: ${error.message || error}`);
                    clearInterval(runPollTimer);
                    runPollTimer = null;
                }
            };

            await pollOnce();
            runPollTimer = setInterval(pollOnce, 2000);
        }

        async function simulateInbound() {
            // Simulation panel removed
        }

        // === Toast notifications ===
        function showToast(type, message, meta = {}) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${escapeHtml(message)}</span><span class="toast-close" onclick="this.parentElement.remove()">&times;</span>`;
            if (meta.case_id) {
                toast.style.cursor = 'pointer';
                toast.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toast-close')) return;
                    openCase(meta.case_id);
                    toast.remove();
                });
            }
            container.appendChild(toast);
            // Keep max 6 toasts visible
            while (container.children.length > 6) container.firstChild.remove();
            // Auto-dismiss after 8s
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 8000);
        }

        // === SSE connection ===
        let sseSource = null;
        function connectSSE() {
            if (sseSource) { sseSource.close(); sseSource = null; }
            const badge = document.getElementById('sseBadge');
            try {
                sseSource = new EventSource('/api/monitor/events');
                sseSource.onopen = () => {
                    badge.textContent = 'SSE: ON';
                    badge.className = 'runtime-badge sse-connected';
                };
                sseSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        showToast(data.type || 'info', data.message || 'Notification', data);
                    } catch (_) {}
                };
                sseSource.onerror = () => {
                    badge.textContent = 'SSE: OFF';
                    badge.className = 'runtime-badge sse-disconnected';
                    sseSource.close();
                    sseSource = null;
                    setTimeout(connectSSE, 5000);
                };
            } catch (_) {
                badge.textContent = 'SSE: OFF';
                badge.className = 'runtime-badge sse-disconnected';
                setTimeout(connectSSE, 5000);
            }
        }

        // === PD Contact Lookup ===
        async function triggerPDContactLookup(caseId, btn) {
            btn.disabled = true;
            btn.textContent = 'Searching...';
            try {
                await fetch(`/api/monitor/case/${caseId}/lookup-contact`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
            } catch (err) {
                showToast('error', `Lookup request failed: ${err.message}`, { case_id: caseId });
            }
            // Re-enable after 90s and refresh case data
            setTimeout(async () => {
                btn.disabled = false;
                btn.textContent = 'Find PD Contact';
                // Refresh case data in the inspector
                try { await openCase(caseId); } catch (_) {}
            }, 90000);
        }

        // Initial load + fixed 10s auto-refresh
        loadData();
        loadConfig();
        connectSSE();
        setInterval(loadData, 10000);
    </script>
</body>
</html>
